<html>
<head>
  <title>postfix笔记（马哥学员倾情奉献）</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="Evernote Windows/307027 (zh-CN, DDL); Windows/10.0.0 (Win64);"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="560"/>
<h1>postfix笔记（马哥学员倾情奉献）</h1>

<div>
<span><div>postfix笔记（马哥学员倾情奉献）</div><div><br/></div><div>一、安装前的准备工作：</div><div><br/></div><div>安装前说明：邮件服务依赖于DNS服务，请事先确信您的DNS服务已经为邮件应用配置完成。</div><div><br/></div><div>1、安装所需的rpm包，这包括以下这些：</div><div>httpd, php, php-mysql, mysql, mysql-server, mysql-devel, openssl-devel, dovecot, perl-DBD-MySQL, tcl, tcl-devel, libart_lgpl, libart_lgpl-devel, libtool-ltdl, libtool-ltdl-devel, expect</div><div><br/></div><div>2、关闭sendmail，并将它的随系统自动启动功能关闭：</div><div># service sendmail stop</div><div># chkconfig sendmail off</div><div><br/></div><div>3、安装以下开发所用到的rpm包组：</div><div>Development Libraries</div><div>Development Tools</div><div><br/></div><div>方法：</div><div># yum groupinstall &quot;packge_group_name&quot;</div><div><br/></div><div>二、启动依赖的服务：</div><div><br/></div><div>1、启动mysql数据库，并给mysql的root用户设置密码：</div><div># service mysqld start</div><div># chkconfig mysqld on</div><div># mysqladmin -uroot password 'your_password'</div><div><br/></div><div>2、启动saslauthd服务，并将其加入到自动启动队列：</div><div># service saslauthd start</div><div># chkconfig saslauthd on</div><div><br/></div><div>三、安装配置postfix</div><div><br/></div><div># groupadd -g 2525 postfix</div><div># useradd -g postfix -u 2525 -s /sbin/nologin -M postfix</div><div># groupadd -g 2526 postdrop</div><div># useradd -g postdrop -u 2526 -s /sbin/nologin -M postdrop</div><div><br/></div><div># tar zxvf postfix-2.9.1.tar.gz</div><div># cd postfix-2.9.1</div><div># make makefiles 'CCARGS=-DHAS_MYSQL -I/usr/include/mysql -DUSE_SASL_AUTH -DUSE_CYRUS_SASL -I/usr/include/sasl  -DUSE_TLS ' 'AUXLIBS=-L/usr/lib/mysql -lmysqlclient -lz -lm -L/usr/lib/sasl2 -lsasl2  -lssl -lcrypto'</div><div># make</div><div># make install</div><div><br/></div><div>按照以下的提示输入相关的路径([]号中的是缺省值，”]”后的是输入值，省略的表示采用默认值)</div><div><br/></div><div>　　install_root: [/] /</div><div>　　tempdir: [/root/postfix-2.9.1] /tmp/postfix</div><div>　　config_directory: [/etc/postfix] /etc/postfix</div><div>　　daemon_directory: [/usr/libexec/postfix]</div><div>　　command_directory: [/usr/sbin]</div><div>　　queue_directory: [/var/spool/postfix]</div><div>　　sendmail_path: [/usr/sbin/sendmail]</div><div>　　newaliases_path: [/usr/bin/newaliases]</div><div>　　mailq_path: [/usr/bin/mailq]</div><div>　　mail_owner: [postfix]</div><div>　　setgid_group: [postdrop]   </div><div>    html_directory: [no]/var/www/html/postfix</div><div>    manpages: [/usr/local/man]</div><div>    readme_directory: [no]</div><div><br/></div><div>生成别名二进制文件：</div><div>#  newaliases</div><div><br/></div><div>2．进行一些基本配置，测试启动postfix并进行发信</div><div># vim /etc/postfix/main.cf</div><div>修改以下几项为您需要的配置</div><div>myhostname = <a href="http://mail.magedu.com/">mail.magedu.com</a></div><div>myorigin = <a href="http://magedu.com/">magedu.com</a></div><div>mydomain = <a href="http://magedu.com/">magedu.com</a></div><div>mydestination = $myhostname, localhost.$mydomain, localhost, $mydomain</div><div>mynetworks = 192.168.1.0/24, 127.0.0.0/8</div><div><br/></div><div>说明:</div><div>myorigin参数用来指明发件人所在的域名，即做发件地址伪装；</div><div>mydestination参数指定postfix接收邮件时收件人的域名，即您的postfix系统要接收到哪个域名的邮件；</div><div>myhostname 参数指定运行postfix邮件系统的主机的主机名，默认情况下，其值被设定为本地机器名；</div><div>mydomain 参数指定您的域名，默认情况下，postfix将myhostname的第一部分删除而作为mydomain的值；</div><div>mynetworks 参数指定你所在的网络的网络地址，postfix系统根据其值来区别用户是远程的还是本地的，如果是本地网络用户则允许其访问；</div><div>inet_interfaces 参数指定postfix系统监听的网络接口；</div><div><br/></div><div>注意：</div><div>1、在postfix的配置文件中，参数行和注释行是不能处在同一行中的；</div><div>2、任何一个参数的值都不需要加引号，否则，引号将会被当作参数值的一部分来使用；</div><div>3、每修改参数及其值后执行 postfix reload 即可令其生效；但若修改了inet_interfaces，则需重新启动postfix；</div><div>4、如果一个参数的值有多个，可以将它们放在不同的行中，只需要在其后的每个行前多置一个空格即可；postfix会把第一个字符为空格或tab的文本行视为上一行的延续；</div><div><br/></div><div><br/></div><div>四、为postfix提供SysV服务脚本/etc/rc.d/init.d/postfix，内容如下(#END 之前)：</div><div>#!/bin/bash</div><div>#</div><div># postfix      Postfix Mail Transfer Agent</div><div>#</div><div># chkconfig: 2345 80 30</div><div># description: Postfix is a Mail Transport Agent, which is the program \</div><div>#              that moves mail from one machine to another.</div><div># processname: master</div><div># pidfile: /var/spool/postfix/pid/master.pid</div><div># config: /etc/postfix/main.cf</div><div># config: /etc/postfix/master.cf</div><div><br/></div><div># Source function library.</div><div>. /etc/rc.d/init.d/functions</div><div><br/></div><div># Source networking configuration.</div><div>. /etc/sysconfig/network</div><div><br/></div><div># Check that networking is up.</div><div>[ $NETWORKING = &quot;no&quot; ] &amp;&amp; exit 3</div><div><br/></div><div>[ -x /usr/sbin/postfix ] || exit 4</div><div>[ -d /etc/postfix ] || exit 5</div><div>[ -d /var/spool/postfix ] || exit 6</div><div><br/></div><div>RETVAL=0</div><div>prog=&quot;postfix&quot;</div><div><br/></div><div>start() {</div><div>    # Start daemons.</div><div>    echo -n $&quot;Starting postfix: &quot;</div><div>        /usr/bin/newaliases &gt;/dev/null 2&gt;&amp;1</div><div>    /usr/sbin/postfix start 2&gt;/dev/null 1&gt;&amp;2 &amp;&amp; success || failure $&quot;$prog start&quot;</div><div>    RETVAL=$?</div><div>    [ $RETVAL -eq 0 ] &amp;&amp; touch /var/lock/subsys/postfix</div><div>        echo</div><div>    return $RETVAL</div><div>}</div><div><br/></div><div>stop() {</div><div>  # Stop daemons.</div><div>    echo -n $&quot;Shutting down postfix: &quot;</div><div>    /usr/sbin/postfix stop 2&gt;/dev/null 1&gt;&amp;2 &amp;&amp; success || failure $&quot;$prog stop&quot;</div><div>    RETVAL=$?</div><div>    [ $RETVAL -eq 0 ] &amp;&amp; rm -f /var/lock/subsys/postfix</div><div>    echo</div><div>    return $RETVAL</div><div>}</div><div><br/></div><div>reload() {</div><div>    echo -n $&quot;Reloading postfix: &quot;</div><div>    /usr/sbin/postfix reload 2&gt;/dev/null 1&gt;&amp;2 &amp;&amp; success || failure $&quot;$prog reload&quot;</div><div>    RETVAL=$?</div><div>    echo</div><div>    return $RETVAL</div><div>}</div><div><br/></div><div>abort() {</div><div>    /usr/sbin/postfix abort 2&gt;/dev/null 1&gt;&amp;2 &amp;&amp; success || failure $&quot;$prog abort&quot;</div><div>    return $?</div><div>}</div><div><br/></div><div>flush() {</div><div>    /usr/sbin/postfix flush 2&gt;/dev/null 1&gt;&amp;2 &amp;&amp; success || failure $&quot;$prog flush&quot;</div><div>    return $?</div><div>}</div><div><br/></div><div>check() {</div><div>    /usr/sbin/postfix check 2&gt;/dev/null 1&gt;&amp;2 &amp;&amp; success || failure $&quot;$prog check&quot;</div><div>    return $?</div><div>}</div><div><br/></div><div>restart() {</div><div>    stop</div><div>    start</div><div>}</div><div><br/></div><div># See how we were called.</div><div>case &quot;$1&quot; in</div><div>  start)</div><div>    start</div><div>    ;;</div><div>  stop)</div><div>    stop</div><div>    ;;</div><div>  restart)</div><div>    stop</div><div>    start</div><div>    ;;</div><div>  reload)</div><div>    reload</div><div>    ;;</div><div>  abort)</div><div>    abort</div><div>    ;;</div><div>  flush)</div><div>    flush</div><div>    ;;</div><div>  check)</div><div>    check</div><div>    ;;</div><div>  status)</div><div>      status master</div><div>    ;;</div><div>  condrestart)</div><div>    [ -f /var/lock/subsys/postfix ] &amp;&amp; restart || :</div><div>    ;;</div><div>  *)</div><div>    echo $&quot;Usage: $0 {start|stop|restart|reload|abort|flush|check|status|condrestart}&quot;</div><div>    exit 1</div><div>esac</div><div><br/></div><div>exit $?</div><div><br/></div><div># END</div><div><br/></div><div>为此脚本赋予执行权限：</div><div># chmod +x /etc/rc.d/init.d/postfix</div><div><br/></div><div>将postfix服务添加至服务列表：</div><div># chkconfig --add postfix</div><div><br/></div><div>设置其开机自动启动：</div><div># chkconfig postfix on</div><div><br/></div><div>使用此脚本重新启动服务，以测试其能否正常执行：</div><div># service postfix restart</div><div><br/></div><div>此时可使用本地用户测试邮件收发了。</div><div><br/></div><div>五、为postfix服务开启用户别名支持：</div><div><br/></div><div>1、在配置文件开启基于hash的别名文件支持</div><div><br/></div><div>在main.cf中，找到如下指令，而后启用它(即移除前面的#号)：</div><div>#alias_maps = hash:/etc/aliases</div><div><br/></div><div>2、在/etc/aliases文件中定义新的别名项，其格式通常为以冒号隔开的两个字段，前一个字段为初始目标邮件地址，后一个字段为实际发往的地址，如：</div><div>redhat：    magedu</div><div><a href="mailto:gentoo@126.com">gentoo@126.com</a>:  <a href="mailto:admin@magedu.com">admin@magedu.com</a></div><div><br/></div><div>3、将/etc/aliases转换为hash格式：</div><div># postalias  /etc/aliases</div><div><br/></div><div>4、让postfix重新载入配置文件，即可进行测试；</div><div><br/></div><div>六、实现postfix基于客户端的访问控制</div><div><br/></div><div>1、基于客户端的访问控制概览</div><div><br/></div><div>postfix内置了多种反垃圾邮件的机制，其中就包括“客户端”发送邮件限制。客户端判别机制可以设定一系列客户信息的判别条件：</div><div>smtpd_client_restrictions</div><div>smtpd_data_restrictions</div><div>smtpd_helo_restrictions</div><div>smtpd_recipient_restrictions</div><div>smtpd_sender_restrictions</div><div><br/></div><div>上面的每一项参数分别用于检查SMTP会话过程中的特定阶段，即客户端提供相应信息的阶段，如当客户端发起连接请求时，postfix就可以根据配置文件中定义的smtpd_client_restrictions参数来判别此客户端IP的访问权限。相应地，smtpd_helo_restrictions则用于根据用户的helo信息判别客户端的访问能力等等。</div><div><br/></div><div>如果DATA命令之前的所有内容都被接受，客户端接着就可以开始传送邮件内容了。邮件内容通常由两部分组成，前半部分是标题(header)，其可以由header_check过滤，后半部分是邮件正文(body)，其可以由check_body过滤。这两项实现的是邮件“内容检查”。</div><div><br/></div><div>postfix的默认配置如下：</div><div>smtpd_client_restrictions =</div><div>smtpd_data_restrictions =</div><div>smtpd_end_of_data_restrictions =</div><div>smtpd_etrn_restrictions =</div><div>smtpd_helo_restrictions =</div><div>smtpd_recipient_restrictions = permit_mynetworks, reject_unauth_destination</div><div>smtpd_sender_restrictions =</div><div><br/></div><div>这限制了只有mynetworks参数中定义的本地网络中的客户端才能通过postfix转发邮件，其它客户端则不被允许，从而关闭了开放式中继(open relay)的功能。</div><div><br/></div><div>Postfix有多个内置的限制条件，如上面的permit_mynetworks和reject_unauth_destination，但管理员也可以使用访问表(access map)来自定义限制条件。自定义访问表的条件通常使用check_client_access, check_helo_access, check_sender_access, check_recipient_access进行，它们后面通常跟上type:mapname格式的访问表类型和名称。其中，check_sender_access和check_recipient_access用来检查客户端提供的邮件地址，因此，其访问表中可以使用完整的邮件地址，如<a href="mailto:admin@magedu.com">admin@magedu.com</a>；也可以只使用域名，如<a href="http://magedu.com/">magedu.com</a>；还可以只有用户名的部分，如marion@。</div><div><br/></div><div>2、实现示例1</div><div><br/></div><div>这里以禁止172.16.100.200这台主机通过工作在172.16.100.1上的postfix服务发送邮件为例演示说明其实现过程。访问表使用hash的格式。</div><div><br/></div><div>(1)首先，编辑/etc/postfix/access文件，以之做为客户端检查的控制文件，在里面定义如下一行：</div><div>172.16.100.200        REJECT</div><div><br/></div><div>(2)将此文件转换为hash格式</div><div># postmap /etc/postfix/access</div><div><br/></div><div>(3)配置postfix使用此文件对客户端进行检查</div><div>编辑/etc/postfix/main.cf文件，添加如下参数：</div><div>smtpd_client_restrictions = check_client_access hash:/etc/postfix/access</div><div><br/></div><div>(4)让postfix重新载入配置文件即可进行发信控制的效果测试了。</div><div><br/></div><div>3、实现示例2</div><div><br/></div><div>这里以禁止通过本服务器向<a href="http://microsoft.com/">microsoft.com</a>域发送邮件为例演示其实现过程。访问表使用hash的格式。</div><div>(1)首先，建立/etc/postfix/denydstdomains文件(文件名任取)，在里面定义如下一行：</div><div><a href="http://microsoft.com/">microsoft.com</a>        REJECT</div><div><br/></div><div>(2)将此文件转换为hash格式</div><div># postmap /etc/postfix/denydstdomains</div><div><br/></div><div>(3)配置postfix使用此文件对客户端进行检查</div><div>编辑/etc/postfix/main.cf文件，添加如下参数：</div><div>smtpd_recipient_restrictions = check_recipient_access hash:/etc/postfix/denydstdomains, permit_mynetworks, reject_unauth_destination</div><div><br/></div><div>(4)让postfix重新载入配置文件即可进行发信控制的效果测试了。</div><div><br/></div><div>4、检查表格式的说明</div><div><br/></div><div>hash类的检查表都使用类似如下的格式：</div><div>pattern   action</div><div><br/></div><div>检查表文件中，空白行、仅包含空白字符的行和以#开头的行都会被忽略。以空白字符开头后跟其它非空白字符的行会被认为是前一行的延续，是一行的组成部分。</div><div><br/></div><div>(1)关于pattern</div><div>其pattern通常有两类地址：邮件地址和主机名称/地址。</div><div><br/></div><div>邮件地址的pattern格式如下：</div><div>user@domain  用于匹配指定邮件地址；</div><div>domain.tld   用于匹配以此域名作为邮件地址中的域名部分的所有邮件地址；</div><div>user@              用于匹配以此作为邮件地址中的用户名部分的所有邮件地址；</div><div><br/></div><div>主机名称/地址的pattern格式如下：</div><div>domain.tld   用于匹配指定域及其子域内的所有主机；</div><div>.domain.tld   用于匹配指定域的子域内的所有主机；</div><div>net.work.addr.ess</div><div>net.work.addr</div><div>net.work</div><div>net        用于匹配特定的IP地址或网络内的所有主机；</div><div>network/mask  CIDR格式，匹配指定网络内的所有主机；</div><div><br/></div><div>(2)关于action</div><div><br/></div><div>接受类的动作：</div><div>OK   接受其pattern匹配的邮件地址或主机名称/地址；</div><div>全部由数字组成的action   隐式表示OK；</div><div><br/></div><div>拒绝类的动作(部分)：</div><div>4NN text</div><div>5NN text</div><div>    其中4NN类表示过一会儿重试；5NN类表示严重错误，将停止重试邮件发送；421和521对于postfix来说有特殊意义，尽量不要自定义这两个代码；</div><div>REJECT optional text...   拒绝；text为可选信息；</div><div>DEFER optional text...    拒绝；text为可选信息；</div><div><br/></div><div><br/></div><div><br/></div><div>七、为postfix开启基于cyrus-sasl的认证功能</div><div><br/></div><div>使用以下命令验正postfix是否支持cyrus风格的sasl认证，如果您的输出为以下结果，则是支持的：</div><div># /usr/local/postfix/sbin/postconf  -a</div><div>cyrus</div><div>dovecot</div><div><br/></div><div>#vim /etc/postfix/main.cf</div><div>添加以下内容：</div><div>############################CYRUS-SASL############################</div><div>broken_sasl_auth_clients = yes</div><div>smtpd_recipient_restrictions=permit_mynetworks,permit_sasl_authenticated,reject_invalid_hostname,reject_non_fqdn_hostname,reject_unknown_sender_domain,reject_non_fqdn_sender,reject_non_fqdn_recipient,reject_unknown_recipient_domain,reject_unauth_pipelining,reject_unauth_destination</div><div>smtpd_sasl_auth_enable = yes</div><div>smtpd_sasl_local_domain = $myhostname</div><div>smtpd_sasl_security_options = noanonymous</div><div>smtpd_sasl_application_name = smtpd</div><div>smtpd_banner = Welcome to our $myhostname ESMTP,Warning: Version not Available!</div><div><br/></div><div># vim /usr/lib/sasl2/smtpd.conf</div><div>添加如下内容：</div><div>pwcheck_method: saslauthd</div><div>mech_list: PLAIN LOGIN</div><div><br/></div><div>让postfix重新加载配置文件</div><div>#/usr/sbin/postfix reload</div><div><br/></div><div># telnet localhost 25</div><div>Trying 127.0.0.1...</div><div>Connected to localhost.localdomain (127.0.0.1).</div><div>Escape character is '^]'.</div><div>220 Welcome to our <a href="http://mail.magedu.com/">mail.magedu.com</a> ESMTP,Warning: Version not Available!</div><div>ehlo <a href="http://mail.magedu.com/">mail.magedu.com</a></div><div>250-<a href="http://mail.magedu.com/">mail.magedu.com</a></div><div>250-PIPELINING</div><div>250-SIZE 10240000</div><div>250-VRFY</div><div>250-ETRN</div><div>250-AUTH PLAIN LOGIN</div><div>250-AUTH=PLAIN LOGIN               （请确保您的输出以类似两行）</div><div>250-ENHANCEDSTATUSCODES</div><div>250-8BITMIME</div><div>250 DSN</div><div><br/></div><div><br/></div><div><br/></div><div>八、安装Courier authentication library</div><div><br/></div><div>1、courier简介</div><div><br/></div><div>courier-authlib是Courier组件中的认证库，它是courier组件中一个独立的子项目，用于为Courier的其它组件提供认证服务。其认证功能通常包括验正登录时的帐号和密码、获取一个帐号相关的家目录或邮件目录等信息、改变帐号的密码等。而其认证的实现方式也包括基于PAM通过/etc/passwd和/etc/shadow进行认证，基于GDBM或DB进行认证，基于LDAP/MySQL/PostgreSQL进行认证等。因此，courier-authlib也常用来与courier之外的其它邮件组件(如postfix)整合为其提供认证服务。</div><div><br/></div><div>2、安装</div><div><br/></div><div>接下来开始编译安装</div><div># tar jxvf courier-authlib-0.62.4.tar.bz2</div><div># cd courier-authlib-0.62.4</div><div>#./configure \</div><div>    --prefix=/usr/local/courier-authlib \</div><div>    --sysconfdir=/etc \</div><div>    --without-authpam \</div><div>    --without-authshadow \</div><div>    --without-authvchkpw \</div><div>    --without-authpgsql \</div><div>    --with-authmysql \</div><div>    --with-mysql-libs=/usr/lib/mysql \</div><div>    --with-mysql-includes=/usr/include/mysql \</div><div>    --with-redhat \</div><div>    --with-authmysqlrc=/etc/authmysqlrc \</div><div>    --with-authdaemonrc=/etc/authdaemonrc \</div><div>    --with-mailuser=postfix \</div><div>    --with-mailgroup=postfix \</div><div>    --with-ltdl-lib=/usr/lib \</div><div>    --with-ltdl-include=/usr/include</div><div># make</div><div># make install</div><div><br/></div><div># chmod 755 /usr/local/courier-authlib/var/spool/authdaemon</div><div># cp /etc/authdaemonrc.dist  /etc/authdaemonrc</div><div># cp /etc/authmysqlrc.dist  /etc/authmysqlrc</div><div><br/></div><div>修改/etc/authdaemonrc 文件</div><div>authmodulelist=&quot;authmysql&quot;</div><div>authmodulelistorig=&quot;authmysql&quot;</div><div>daemons=10</div><div><br/></div><div>3、配置其通过mysql进行邮件帐号认证</div><div><br/></div><div>编辑/etc/authmysqlrc 为以下内容，其中2525，2525 为postfix 用户的UID和GID。</div><div>MYSQL_SERVER localhost</div><div>MYSQL_PORT 3306                   (指定你的mysql监听的端口，这里使用默认的3306)</div><div>MYSQL_USERNAME  extmail      (这时为后文要用的数据库的所有者的用户名)</div><div>MYSQL_PASSWORD extmail        (密码)</div><div>MYSQL_SOCKET  /var/lib/mysql/mysql.sock</div><div>MYSQL_DATABASE  extmail</div><div>MYSQL_USER_TABLE  mailbox</div><div>MYSQL_CRYPT_PWFIELD  password</div><div>MYSQL_UID_FIELD  '2525'</div><div>MYSQL_GID_FIELD  '2525'</div><div>MYSQL_LOGIN_FIELD  username</div><div>MYSQL_HOME_FIELD  concat('/var/mailbox/',homedir)</div><div>MYSQL_NAME_FIELD  name</div><div>MYSQL_MAILDIR_FIELD  concat('/var/mailbox/',maildir)</div><div><br/></div><div>4、提供SysV服务脚本</div><div><br/></div><div># cp courier-authlib.sysvinit /etc/rc.d/init.d/courier-authlib</div><div># chmod 755 /etc/init.d/courier-authlib</div><div># chkconfig --add courier-authlib</div><div># chkconfig --level 2345 courier-authlib on</div><div><br/></div><div>#echo &quot;/usr/local/courier-authlib/lib/courier-authlib&quot; &gt;&gt; /etc/ld.so.conf.d/courier-authlib.conf</div><div># ldconfig -v</div><div># service courier-authlib start   (启动服务)</div><div><br/></div><div>5、事件postfix和courier-authlib</div><div><br/></div><div>新建虚拟用户邮箱所在的目录，并将其权限赋予postfix用户：</div><div>#mkdir –pv /var/mailbox</div><div>#chown –R postfix /var/mailbox</div><div><br/></div><div>接下来重新配置SMTP 认证，编辑 /usr/lib/sasl2/smtpd.conf ，确保其为以下内容：</div><div>pwcheck_method: authdaemond</div><div>log_level: 3</div><div>mech_list:PLAIN LOGIN</div><div>authdaemond_path:/usr/local/courier-authlib/var/spool/authdaemon/socket</div><div><br/></div><div><br/></div><div>九、让postfix支持虚拟域和虚拟用户</div><div><br/></div><div>1、编辑/etc/postfix/main.cf，添加如下内容：</div><div>########################Virtual Mailbox Settings########################</div><div>virtual_mailbox_base = /var/mailbox</div><div>virtual_mailbox_maps = mysql:/etc/postfix/mysql_virtual_mailbox_maps.cf</div><div>virtual_mailbox_domains = mysql:/etc/postfix/mysql_virtual_domains_maps.cf</div><div>virtual_alias_domains =</div><div>virtual_alias_maps = mysql:/etc/postfix/mysql_virtual_alias_maps.cf</div><div>virtual_uid_maps = static:2525</div><div>virtual_gid_maps = static:2525</div><div>virtual_transport = virtual</div><div>maildrop_destination_recipient_limit = 1</div><div>maildrop_destination_concurrency_limit = 1</div><div>##########################QUOTA Settings########################</div><div>message_size_limit = 14336000</div><div>virtual_mailbox_limit = 20971520</div><div>virtual_create_maildirsize = yes</div><div>virtual_mailbox_extended = yes</div><div>virtual_mailbox_limit_maps = mysql:/etc/postfix/mysql_virtual_mailbox_limit_maps.cf</div><div>virtual_mailbox_limit_override = yes</div><div>virtual_maildir_limit_message = Sorry, the user's maildir has overdrawn his diskspace quota, please Tidy your mailbox and try again later.</div><div>virtual_overquota_bounce = yes</div><div><br/></div><div>2、使用extman源码目录下docs目录中的extmail.sql和init.sql建立数据库：</div><div><br/></div><div># tar zxvf  extman-1.1.tar.gz</div><div># cd extman-1.1/docs</div><div># mysql -u root -p &lt; extmail.sql</div><div># mysql -u root -p &lt;init.sql</div><div># cp mysql*  /etc/postfix/</div><div><br/></div><div>3、授予用户extmail访问extmail数据库的权限</div><div>mysql&gt; GRANT all privileges on extmail.* TO extmail@localhost IDENTIFIED BY 'extmail';</div><div>mysql&gt; GRANT all privileges on extmail.* TO extmail@127.0.0.1 IDENTIFIED BY 'extmail';</div><div><br/></div><div>说明：启用虚拟域以后，需要取消中心域，即注释掉myhostname, mydestination, mydomain, myorigin几个指令；当然，你也可以把mydestionation的值改为你自己需要的。</div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div>十、配置dovecot</div><div><br/></div><div># vi /etc/dovecot.conf</div><div>mail_location = maildir:/var/mailbox/%d/%n/Maildir</div><div>……</div><div>auth default {</div><div>    mechanisms = plain</div><div>    passdb sql {</div><div>        args = /etc/dovecot-mysql.conf</div><div>    }</div><div>    userdb sql {</div><div>        args = /etc/dovecot-mysql.conf</div><div>    }</div><div>    ……</div><div><br/></div><div># vim /etc/dovecot-mysql.conf                 </div><div>driver = mysql</div><div>connect = host=localhost dbname=extmail user=extmail password=extmail</div><div>default_pass_scheme = CRYPT</div><div>password_query = SELECT username AS user,password AS password FROM mailbox WHERE username = '%u'                            </div><div>user_query = SELECT maildir, uidnumber AS uid, gidnumber AS gid FROM mailbox WHERE username = '%u'</div><div><br/></div><div>接下来启动dovecot服务：</div><div><br/></div><div># service dovecot start</div><div># chkconfig dovecot on</div><div><br/></div><div><br/></div><div><br/></div><div>十一、安装Extmail-1.2</div><div><br/></div><div>1、安装</div><div># tar zxvf extmail-1.2.tar.gz</div><div># mkdir -pv /var/www/extsuite</div><div># mv extmail-1.2 /var/www/extsuite/extmail</div><div># cp /var/www/extsuite/extmail/webmail.cf.default  /var/www/extsuite/extmail/webmail.cf</div><div><br/></div><div>2、修改主配置文件</div><div>#vi /var/www/extsuite/extmail/webmail.cf</div><div><br/></div><div>部分修改选项的说明：</div><div><br/></div><div>SYS_MESSAGE_SIZE_LIMIT = 5242880</div><div>用户可以发送的最大邮件</div><div><br/></div><div>SYS_USER_LANG = en_US</div><div>语言选项，可改作：</div><div>SYS_USER_LANG = zh_CN</div><div><br/></div><div>SYS_MAILDIR_BASE = /home/domains</div><div>此处即为您在前文所设置的用户邮件的存放目录，可改作：</div><div>SYS_MAILDIR_BASE = /var/mailbox</div><div><br/></div><div>SYS_MYSQL_USER = db_user</div><div>SYS_MYSQL_PASS = db_pass</div><div>以上两句句用来设置连接数据库服务器所使用用户名、密码和邮件服务器用到的数据库，这里修改为：</div><div>SYS_MYSQL_USER = extmail</div><div>SYS_MYSQL_PASS = extmail</div><div><br/></div><div>SYS_MYSQL_HOST = localhost</div><div>指明数据库服务器主机名，这里默认即可</div><div><br/></div><div>SYS_MYSQL_TABLE = mailbox</div><div>SYS_MYSQL_ATTR_USERNAME = username</div><div>SYS_MYSQL_ATTR_DOMAIN = domain</div><div>SYS_MYSQL_ATTR_PASSWD = password</div><div><br/></div><div>以上用来指定验正用户登录里所用到的表，以及用户名、域名和用户密码分别对应的表中列的名称；这里默认即可</div><div><br/></div><div>SYS_AUTHLIB_SOCKET = /var/spool/authdaemon/socket</div><div>此句用来指明authdaemo socket文件的位置，这里修改为：</div><div>SYS_AUTHLIB_SOCKET = /usr/local/courier-authlib/var/spool/authdaemon/socket</div><div><br/></div><div><br/></div><div>3、apache相关配置</div><div><br/></div><div>由于extmail要进行本地邮件的投递操作，故必须将运行apache服务器用户的身份修改为您的邮件投递代理的用户；本例中打开了apache服务器的suexec功能，故使用以下方法来实现虚拟主机运行身份的指定。此例中的MDA为postfix自带，因此将指定为postfix用户：</div><div>&lt;VirtualHost *:80&gt;</div><div>ServerName <a href="http://mail.magedu.com/">mail.magedu.com</a></div><div>DocumentRoot /var/www/extsuite/extmail/html/</div><div>ScriptAlias /extmail/cgi /var/www/extsuite/extmail/cgi</div><div>Alias /extmail /var/www/extsuite/extmail/html</div><div>SuexecUserGroup postfix postfix</div><div>&lt;/VirtualHost&gt;</div><div><br/></div><div>修改 cgi执行文件属主为apache运行身份用户：</div><div># chown -R postfix.postfix /var/www/extsuite/extmail/cgi/</div><div><br/></div><div>如果您没有打开apache服务器的suexec功能,也可以使用以下方法解决：</div><div># vi /etc/httpd/httpd.conf</div><div>User postfix</div><div>Group postfix</div><div><br/></div><div>&lt;VirtualHost *:80&gt;</div><div>ServerName <a href="http://mail.magedu.com/">mail.magedu.com</a></div><div>DocumentRoot /var/www/extsuite/extmail/html/</div><div>ScriptAlias /extmail/cgi /var/www/extsuite/extmail/cgi</div><div>Alias /extmail /var/www/extsuite/extmail/html</div><div>&lt;/VirtualHost&gt;</div><div><br/></div><div>4、依赖关系的解决</div><div><br/></div><div>extmail将会用到perl的Unix::syslogd功能，您可以去<a href="http://search.cpan.org/">http://search.cpan.org</a>搜索下载原码包进行安装。</div><div># tar zxvf Unix-Syslog-0.100.tar.gz</div><div># cd Unix-Syslog-0.100</div><div># perl Makefile.PL</div><div># make</div><div># make install</div><div><br/></div><div>5、启动apache服务</div><div># service httpd start</div><div># chkconfig httpd on</div><div><br/></div><div><br/></div><div><br/></div><div>十二、安装Extman-1.1</div><div><br/></div><div>1、安装及基本配置</div><div><br/></div><div># tar zxvf  extman-1.1.tar.gz</div><div># mv extman-1.1 /var/www/extsuite/extman</div><div><br/></div><div>修改配置文件以符合本例的需要：</div><div># cp /var/www/extsuite/extman/webman.cf.default  /var/www/extsuite/extman/webman.cf</div><div># vi /var/www/extsuite/extman/webman.cf</div><div><br/></div><div>SYS_MAILDIR_BASE = /home/domains</div><div>此处即为您在前文所设置的用户邮件的存放目录，可改作：</div><div>SYS_MAILDIR_BASE = /var/mailbox</div><div><br/></div><div>SYS_DEFAULT_UID = 1000</div><div>SYS_DEFAULT_GID = 1000</div><div>此两处后面设定的ID号需更改为前而创建的postfix用户和postfix组的id号，本文使用的是2525，因此，上述两项需要修改为：</div><div>SYS_DEFAULT_UID = 2525</div><div>SYS_DEFAULT_GID = 2525</div><div><br/></div><div>SYS_MYSQL_USER = webman</div><div>SYS_MYSQL_PASS = webman</div><div>修改为：</div><div>SYS_MYSQL_USER = extmail</div><div>SYS_MYSQL_PASS = extmail</div><div><br/></div><div>而后修改cgi目录的属主：</div><div># chown -R postfix.postfix /var/www/extsuite/extman/cgi/</div><div><br/></div><div>在apache的主配置文件中Extmail的虚拟主机部分，添加如下两行：</div><div>ScriptAlias /extman/cgi /var/www/extsuite/extman/cgi</div><div>Alias /extman /var/www/extsuite/extman/html</div><div><br/></div><div>创建其运行时所需的临时目录，并修改其相应的权限：</div><div>#mkdir  -pv  /tmp/extman</div><div>#chown postfix.postfix  /tmp/extman</div><div><br/></div><div>修改</div><div>SYS_CAPTCHA_ON = 1</div><div>为</div><div>SYS_CAPTCHA_ON = 0</div><div><br/></div><div>好了，到此为止，重新启动apache服务器后，您的Webmail和Extman已经可以使用了，可以在浏览器中输入指定的虚拟主机的名称进行访问，如下：</div><div><a href="http://mail.magedu.com/">http://mail.magedu.com</a></div><div><br/></div><div>选择管理即可登入extman进行后台管理了。默认管理帐号为：<a href="mailto:root@extmail.org">root@extmail.org</a>  密码为：extmail*123*</div><div><br/></div><div>说明：</div><div>(1) 如果您安装后无法正常显示校验码，安装perl-GD模块会解决这个问题。如果想简单，您可以到以下地址下载适合您的平台的rpm包，安装即可：  <a href="http://dries.ulyssis.org/rpm/packages/perl-GD/info.html">http://dries.ulyssis.org/rpm/packages/perl-GD/info.html</a></div><div>(2) extman-1.1自带了图形化显示日志的功能；此功能需要rrdtool的支持，您需要安装此些模块才可能正常显示图形日志。</div><div><br/></div><div><br/></div><div>2、配置Mailgraph_ext，使用Extman的图形日志：（下面所需的软件包面要自己下载）</div><div><br/></div><div>接下来安装图形日志的运行所需要的软件包Time::HiRes、File::Tail和rrdtool，其中前两个包您可以去<a href="http://search.cpan.org/">http://search.cpan.org</a>搜索并下载获得，后一个包您可以到 <a href="http://oss.oetiker.ch/rrdtool/pub/?M=D">http://oss.oetiker.ch/rrdtool/pub/?M=D</a>下载获得； 注意安装顺序不能改换。</div><div><br/></div><div>安装Time::HiRes</div><div>#tar zxvf Time-HiRes-1.9707.tar.gz</div><div>#cd Time-HiRes-1.9707</div><div>#perl Makefile.PL</div><div>#make</div><div>#make test</div><div>#make install</div><div><br/></div><div>安装File::Tail</div><div>#tar zxvf File-Tail-0.99.3.tar.gz</div><div>#cd File-Tail-0.99.3</div><div>#perl Makefile</div><div>#make</div><div>#make test</div><div>#make install</div><div><br/></div><div>安装rrdtool-1.2.23</div><div>#tar zxvf rrdtool-1.2.23.tar.gz</div><div>#cd rrdtool-1.2.23</div><div>#./configure --prefix=/usr/local/rrdtool</div><div>#make</div><div>#make install</div><div><br/></div><div>创建必要的符号链接(Extman会到这些路径下找相关的库文件)</div><div>#ln -sv /usr/local/rrdtool/lib/perl/5.8.5/i386-linux-thread-multi/auto/RRDs/RRDs.so   /usr/lib/perl5/5.8.5/i386-linux-thread-multi/</div><div>#ln -sv /usr/local/rrdtool/lib/perl/5.8.5/RRDp.pm   /usr/lib/perl5/5.8.5</div><div>#ln -sv /usr/local/rrdtool/lib/perl/5.8.5/i386-linux-thread-multi/RRDs.pm   /usr/lib/perl5/5.8.5</div><div><br/></div><div>复制mailgraph_ext到/usr/local，并启动之</div><div># cp -r /var/www/extsuite/extman/addon/mailgraph_ext  /usr/local  </div><div># /usr/local/mailgraph_ext/mailgraph-init start</div><div><br/></div><div>启动cmdserver(在后台显示系统信息)</div><div># /var/www/extsuite/extman/daemon/cmdserver --daemon</div><div><br/></div><div>添加到自动启动队列</div><div># echo “/usr/local/mailgraph_ext/mailgraph-init start” &gt;&gt; /etc/rc.d/rc.local</div><div># echo “/var/www/extsuite/extman/daemon/cmdserver -v -d” &gt;&gt; /etc/rc.d/rc.local</div><div><br/></div><div>使用方法： 等待大约15分钟左右，如果邮件系统有一定的流量，即可登陆到extman里，点“图形日志”即可看到图形化的日志。具体每天，周，月，年的则点击相应的图片进入即可。</div></span>
</div></body></html> 