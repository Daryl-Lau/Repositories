<html>
<head>
  <title>ASM 添加磁盘实验</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="Evernote Windows/307027 (zh-CN, DDL); Windows/10.0.0 (Win64);"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="407"/>
<h1>ASM 添加磁盘实验</h1>

<div>
<span><div>ASM 添加磁盘实验</div><div><br/></div><div>查看asm状态</div><div>[grid@pass admin]$ ps -ef |grep asm</div><div>grid      2128     1  0 02:45 ?        00:00:00 asm_pmon_+asm</div><div>grid      2130     1  0 02:45 ?        00:00:32 asm_vktm_+asm</div><div>grid      2134     1  0 02:45 ?        00:00:00 asm_gen0_+asm</div><div>grid      2136     1  0 02:45 ?        00:00:00 asm_diag_+asm</div><div>grid      2138     1  0 02:45 ?        00:00:00 asm_psp0_+asm</div><div>grid      2140     1  0 02:45 ?        00:00:01 asm_dia0_+asm</div><div>grid      2142     1  0 02:45 ?        00:00:00 asm_mman_+asm</div><div>grid      2144     1  0 02:45 ?        00:00:00 asm_dbw0_+asm</div><div>grid      2146     1  0 02:45 ?        00:00:00 asm_lgwr_+asm</div><div>grid      2148     1  0 02:45 ?        00:00:00 asm_ckpt_+asm</div><div>grid      2150     1  0 02:45 ?        00:00:00 asm_smon_+asm</div><div>grid      2152     1  0 02:45 ?        00:00:00 asm_rbal_+asm</div><div>grid      2154     1  0 02:45 ?        00:00:01 asm_gmon_+asm</div><div>grid      2156     1  0 02:45 ?        00:00:00 asm_mmon_+asm</div><div>grid      2158     1  0 02:45 ?        00:00:01 asm_mmnl_+asm</div><div>oracle    2605     1  0 02:53 ?        00:00:00 ora_asmb_james</div><div>grid      2609     1  0 02:53 ?        00:00:00 oracle+asm_asmb_james (DESCRIPTION=(LOCAL=YES)(ADDRESS=(PROTOCOL=beq)))</div><div>grid      4953     1  0 04:00 ?        00:00:00 oracle+asm_o000_james (DESCRIPTION=(LOCAL=YES)(ADDRESS=(PROTOCOL=beq)))</div><div>grid      5080 31746  0 04:02 pts/3    00:00:00 grep asm</div><div><br/></div><div><br/></div><div><br/></div><div>sys@JAMES&gt; select * from V$asm_client</div><div>  2  ;</div><div><br/></div><div>GROUP_NUMBER INSTANCE_NAME                                                    DB_NAME  STATUS</div><div>------------ ---------------------------------------------------------------- -------- ------------</div><div>SOFTWARE_VERSION                                             COMPATIBLE_VERSION</div><div>------------------------------------------------------------ ------------------------------------------------------------</div><div>           1 +asm                                                             james    CONNECTED</div><div>11.2.0.1.0                                                   11.2.0.0.0</div><div><br/></div><div><br/></div><div>sys@JAMES&gt; select name,open_mode from v$database;</div><div><br/></div><div>NAME                                OPEN_MODE</div><div>----------------------------------- --------------------</div><div>JAMES                               READ WRITE</div><div><br/></div><div><br/></div><div><br/></div><div>sys@JAMES&gt; select name, state, type, total_mb, free_mb from v$asm_diskgroup;</div><div><br/></div><div>NAME                                STATE       TYPE     TOTAL_MB    FREE_MB</div><div>----------------------------------- ----------- ------ ---------- ----------</div><div>DG1                                 CONNECTED   NORMAL       8188       6734</div><div><br/></div><div>sys@JAMES&gt; select group_number, name,failgroup, path from v$asm_disk;</div><div><br/></div><div>GROUP_NUMBER NAME                                FAILGROUP                      PATH</div><div>------------ ----------------------------------- ------------------------------ --------------------------------------------------</div><div>           1 DG1_0001                            F2                             /dev/asm-diskc</div><div>           1 DG1_0000                            F1                             /dev/asm-diskb</div><div><br/></div><div>select * from V$datafile</div><div><br/></div><div>select * from V$fixed_table where NAME like '%ASM%'</div><div><br/></div><div>select * from V$asm_file</div><div>select * from V$asm_operation</div><div>asmcmd</div><div><br/></div><div><br/></div><div>虚拟机新加硬盘。</div><div>fdisk -l</div><div><br/></div><div>for i in d ;</div><div>do</div><div>echo &quot;KERNEL==\&quot;sd*\&quot;, BUS==\&quot;scsi\&quot;, PROGRAM==\&quot;/sbin/scsi_id --whitelisted --replace-whitespace --device=/dev/\$name\&quot;, RESULT==\&quot;`/sbin/scsi_id --whitelisted --replace-whitespace --device=/dev/sd$i`\&quot;, NAME=\&quot;asm-disk$i\&quot;, OWNER=\&quot;grid\&quot;, GROUP=\&quot;asmadmin\&quot;, MODE=\&quot;0660\&quot;&quot;      &gt;&gt; /etc/udev/rules.d/99-oracle-asmdevices.rules</div><div>done</div><div><br/></div><div>cat /etc/udev/rules.d/99-oracle-asmdevices.rules</div><div><br/></div><div>映射ASM disk</div><div>[root@pass ~]# udevadm control --reload</div><div>[root@pass ~]# ls -ltr /dev/asm-disk*</div><div>brw-rw----. 1 grid asmadmin 8, 33 Dec  4 07:01 /dev/asm-diskc</div><div>brw-rw----. 1 grid asmadmin 8, 17 Dec  4 07:01 /dev/asm-diskb</div><div><br/></div><div>[root@pass ~]# udevadm trigger</div><div>[root@pass ~]# ls -ltr /dev/asm-disk*</div><div>brw-rw----. 1 grid asmadmin 8, 49 Dec  4 07:01 /dev/asm-diskd</div><div>brw-rw----. 1 grid asmadmin 8, 33 Dec  4 07:01 /dev/asm-diskc</div><div>brw-rw----. 1 grid asmadmin 8, 17 Dec  4 07:01 /dev/asm-diskb</div><div><br/></div><div>    </div><div><br/></div><div>SQL&gt; alter diskgroup DG1 add disk  '/dev/asm-diskd';</div><div><br/></div><div>Diskgroup altered.</div><div><br/></div><div>    </div><div>SQL&gt; col name for a10</div><div>SQL&gt; col path for a30</div><div>SQL&gt; select name,path from v$asm_disk;</div><div><br/></div><div>NAME       PATH</div><div>---------- ------------------------------</div><div>DG1_0000   /dev/asm-diskb</div><div>DG1_0001   /dev/asm-diskc</div><div>DG1_0002   /dev/asm-diskd</div><div><br/></div><div>SQL&gt; select disk_number, state, name, total_mb, free_mb from v$asm_disk;</div><div><br/></div><div>DISK_NUMBER STATE    NAME         TOTAL_MB    FREE_MB</div><div>----------- -------- ---------- ---------- ----------</div><div>          0 NORMAL   DG1_0000         4094       3580</div><div>          1 NORMAL   DG1_0001         4094       3578</div><div>          2 NORMAL   DG1_0002         4094       3581</div><div><br/></div><div>SQL&gt; select operation,est_minutes,ERROR_CODE from v$asm_operation;</div><div><br/></div><div>no rows selected</div><div><br/></div><div><br/></div><div>su - oracle  插入一张大表</div><div>[oracle@pass ~]$ export ORACLE_SID=james</div><div>[oracle@pass ~]$ sqlplus / as sysdba</div><div><br/></div><div>SQL*Plus: Release 11.2.0.1.0 Production on Fri Dec 4 07:08:37 2015</div><div><br/></div><div>Copyright (c) 1982, 2009, Oracle.  All rights reserved.</div><div><br/></div><div>Connected to an idle instance.</div><div><br/></div><div>idle&gt; startup</div><div><br/></div><div>create table test TABLESPACE users as select * from dba_tables;</div><div><br/></div><div>select TABLE_NAME,TABLESPACE_NAME from dba_tables where TABLE_NAME='TEST';</div><div><br/></div><div>TABLE_NAME                     TABLESPACE_NAME</div><div>------------------------------ ------------------------------</div><div>TEST                           USERS</div><div><br/></div><div>select FILE_NAME,TABLESPACE_NAME from dba_data_files where TABLESPACE_NAME='USERS';</div><div><br/></div><div><br/></div><div>FILE_NAME                                     TABLESPACE_NAME</div><div>--------------------------------------------- ------------------------------</div><div>+DG1/oradata/userdata.dbf                     USERS</div><div><br/></div><div>idle&gt; select sum(bytes)/1024/1024 &quot;table size(M)&quot; from user_segments where segment_name='TEST';</div><div><br/></div><div>table size(M)</div><div>-------------</div><div>         3328</div><div><br/></div><div>insert into test select * from test;  -反复执行</div><div>sys@JAMES&gt; insert into test select * from test;</div><div><br/></div><div>140032 rows created.</div><div>Commit</div><div><br/></div><div>sys@JAMES&gt; SELECT file_id,file_name,tablespace_name,autoextensible,increment_by FROM  dba_data_files  ;</div><div><br/></div><div>   FILE_ID FILE_NAME                                     TABLESPACE_NAME                AUT INCREMENT_BY</div><div>---------- --------------------------------------------- ------------------------------ --- ------------</div><div>         1 +DG1/oradata/system.dbf                       SYSTEM                         NO             0</div><div>         2 +DG1/oradata/sysaux.dbf                       SYSAUX                         NO             0</div><div>         3 +DG1/oradata/undo1.dbf                        UNDOTBS1                       NO             0</div><div>         4 +DG1/oradata/userdata.dbf                     USERS                          NO             0</div><div><br/></div><div>sys@JAMES&gt; alter database datafile 4 autoextend on;</div><div><br/></div><div>Database altered.</div><div><br/></div><div>sys@JAMES&gt;  SELECT file_id,file_name,tablespace_name,autoextensible,increment_by FROM  dba_data_files  ;</div><div><br/></div><div>   FILE_ID FILE_NAME                                     TABLESPACE_NAME                AUT INCREMENT_BY</div><div>---------- --------------------------------------------- ------------------------------ --- ------------</div><div>         1 +DG1/oradata/system.dbf                       SYSTEM                         NO             0</div><div>         2 +DG1/oradata/sysaux.dbf                       SYSAUX                         NO             0</div><div>         3 +DG1/oradata/undo1.dbf                        UNDOTBS1                       NO             0</div><div>         4 +DG1/oradata/userdata.dbf                     USERS                          YES            1</div><div><br/></div><div>sys@JAMES&gt; select sum(bytes)/1024/1024 &quot;table size(M)&quot; from user_segments where segment_name='TEST';</div><div><br/></div><div>table size(M)</div><div>-------------</div><div>          1216</div><div><br/></div><div>sys@JAMES&gt; select count(*) from test;</div><div><br/></div><div>  COUNT(*)</div><div>----------</div><div>   4481024</div><div><br/></div><div><br/></div><div>sys@JAMES&gt; col path for a40</div><div>sys@JAMES&gt; select path,total_mb,free_mb from v$asm_disk_stat;</div><div><br/></div><div>PATH                                       TOTAL_MB    FREE_MB</div><div>---------------------------------------- ---------- ----------</div><div>/dev/asm-diskb                                 4094       2796</div><div>/dev/asm-diskc                                 4094       2794</div><div>/dev/asm-diskd                                 4094       2795</div><div><br/></div><div>   </div><div>删除disk</div><div><br/></div><div>SQL&gt; select name,path from v$asm_disk;</div><div><br/></div><div>NAME       PATH</div><div>---------- ------------------------------</div><div>DG1_0000   /dev/asm-diskb</div><div>DG1_0001   /dev/asm-diskc</div><div>DG1_0002   /dev/asm-diskd</div><div><br/></div><div>将当前的diskgroup组的rebalance速度修改为10：</div><div><br/></div><div>SQL&gt; alter diskgroup DG1  rebalance power  1;</div><div><br/></div><div>SQL&gt; alter diskgroup DG1 drop disk  DG1_0000;</div><div><br/></div><div>Diskgroup altered.</div><div><br/></div><div><br/></div><div>查看是否删除</div><div><br/></div><div><br/></div><div>SQL&gt; select disk_number, state, name, total_mb, free_mb from v$asm_disk;</div><div><br/></div><div>DISK_NUMBER STATE    NAME         TOTAL_MB    FREE_MB</div><div>----------- -------- ---------- ---------- ----------</div><div>          0 DROPPING                     0          0</div><div>          1 NORMAL   DG1_0001         4094       2828</div><div>          2 NORMAL   DG1_0002         4094       2828</div><div><br/></div><div>          </div><div>可以看到，虽然删除操作执行完成，但是磁盘并没有真正被删掉，ASM在后台尝试将磁盘上的数据挪到其他可用磁盘中，这时磁盘的状态为DROPPING。</div><div>当后台数据同步的操作完成，磁盘的组信息被清除，磁盘恢复STATE状态。这时这个磁盘就从ASM中被彻底删除。</div><div><br/></div><div>SQL&gt; select operation,est_minutes,STATE,POWER,ACTUAL from v$asm_operation;  ==》 ASM instanc</div><div><br/></div><div><br/></div><div>还可以查看 alert log 观察 rebalance</div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div>重新加回来disk</div><div>SQL&gt; alter diskgroup DG1  rebalance power  10;</div><div>alter diskgroup DG1 drop disk  DG1_0000;</div><div><br/></div><div>Diskgroup altered.</div><div><br/></div><div><br/></div><div>SQL&gt; alter diskgroup DG1 add disk  '/dev/asm-diskb';</div><div><br/></div><div>Diskgroup altered.</div><div><br/></div><div>alter diskgroup DG1 add disk  '/dev/asm-diskd';</div><div><br/></div><div><br/></div><div>SQL&gt; select group_number,name,state,total_mb,free_mb from v$asm_diskgroup;</div><div><br/></div><div>GROUP_NUMBER NAME       STATE         TOTAL_MB    FREE_MB</div><div>------------ ---------- ----------- ---------- ----------</div><div>           1 DG1        MOUNTED           8188       6734</div><div>           </div><div>SQL&gt; select path,total_mb,free_mb from v$asm_disk_stat;</div><div><br/></div><div>PATH                             TOTAL_MB    FREE_MB</div><div>------------------------------ ---------- ----------</div><div>/dev/asm-diskc                       4094       3367</div><div>/dev/asm-diskb                       4094       3367</div><div><br/></div><div><br/></div><div><br/></div><div><br/></div></span>
</div></body></html> 