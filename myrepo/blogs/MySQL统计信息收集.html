<html>
<head>
  <title>MySQL统计信息收集</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="Evernote Windows/307027 (zh-CN, DDL); Windows/10.0.0 (Win64);"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="581"/>
<h1>MySQL统计信息收集</h1>

<div>
<span><div style="white-space: pre-wrap; text-indent: 28px; text-align: left; font-size: 14px;"><a href="#63cmdk1522420553447" style="line-height: 1.75;">MySQL统计信息收集</a><br/></div><div style="white-space: pre-wrap; text-indent: 56px; text-align: left; font-size: 14px;"><a href="#43qfvx1522415685765" style="white-space: pre-wrap; text-indent: 56px; font-size: 14px; line-height: 1.75;">统计每个库大小</a></div><div style="white-space: pre-wrap; text-indent: 56px; text-align: left; font-size: 14px;"><a href="#5deck1522415899899" style="white-space: pre-wrap; text-indent: 56px; font-size: 14px; line-height: 1.75;">统计库里每个表的大小</a></div><div style="white-space: pre-wrap; text-indent: 56px; text-align: left; font-size: 14px;"><a href="#42rtkt1522415907563" style="white-space: pre-wrap; text-indent: 56px; font-size: 14px; line-height: 1.75;">统计所有数据库的大小</a></div><div style="white-space: pre-wrap; text-indent: 56px; text-align: left; font-size: 14px;"><a href="#57vbqd1522415916827" style="white-space: pre-wrap; text-indent: 56px; font-size: 14px; line-height: 1.75;">统计客户端连接数</a></div><div style="white-space: pre-wrap; text-indent: 56px; text-align: left; font-size: 14px;"><a href="#17iatc1522415936007" style="white-space: pre-wrap; text-indent: 56px; font-size: 14px; line-height: 1.75;">MySQL在什么状态收集统计信息</a></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 20px; font-weight: bold; line-height: 1.75;">MySQL数据库表创建规范与管理</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><br/></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">禁止使用中文做字段名</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">禁止使用字符型做主键，也要禁止无主键或唯一索引的表出现</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">线上管理，一定要提前写好sql，昨晚测试再在线上执行</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><br/></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 20px; font-weight: bold; line-height: 1.75;">MySQL统计信息收集</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">1、重启MySQL数据库</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">2、遍历 information_schema.tables表</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">这个库里面的表只支持select查询</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><br/></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">每天读取一下information_schema.tables的信息,读这个表:相当于完成了一次表信息的收集</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><br/></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 16px; font-weight: bold; line-height: 1.75;">统计每个库大小</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div style="font-family: Monaco; font-size: 11pt; color: rgb(51, 51, 51);"><span style="font-family: &quot;DejaVu Sans Mono&quot;; color: rgb(0, 128, 0); font-size: 9pt;">mysql&gt; <span style="background-color: rgb(255, 250, 165);-evernote-highlight:true;">use information_schema ;</span></span></div><div style="font-family: Monaco; font-size: 11pt; color: rgb(51, 51, 51);"><span style="font-family: &quot;DejaVu Sans Mono&quot;; color: rgb(0, 128, 0); font-size: 9pt;">Reading table information for completion of table and column names</span></div><div style="font-family: Monaco; font-size: 11pt; color: rgb(51, 51, 51);"><span style="font-family: &quot;DejaVu Sans Mono&quot;; color: rgb(0, 128, 0); font-size: 9pt;">You can turn off this feature to get a quicker startup with -A</span></div><div style="font-family: Monaco; font-size: 11pt; color: rgb(51, 51, 51);"><br style="font-family: Monaco; font-size: 11pt; color: rgb(51, 51, 51);"/></div><div style="font-family: Monaco; font-size: 11pt; color: rgb(51, 51, 51);"><span style="font-family: &quot;DejaVu Sans Mono&quot;; color: rgb(0, 128, 0); font-size: 9pt;">Database changed</span></div><div style="font-family: Monaco; font-size: 11pt; color: rgb(51, 51, 51);"><span style="font-family: &quot;DejaVu Sans Mono&quot;; color: rgb(0, 128, 0); font-size: 9pt;">mysql&gt; <span style="background-color: rgb(255, 250, 165);-evernote-highlight:true;">SELECT TABLE_SCHEMA,SUM(DATA_LENGTH)/1024/1024/1024 as DATA_LENGTH,SUM(INDEX_LENGTH)/1024/1024/1024</span></span></div><div style="font-family: Monaco; font-size: 11pt; color: rgb(51, 51, 51);"><span style="font-family: &quot;DejaVu Sans Mono&quot;;color: rgb(0, 128, 0);font-size: 9pt;background-color: rgb(255, 250, 165);-evernote-highlight:true;">    as INDEX_LENGTH,SUM(DATA_LENGTH+INDEX_LENGTH)/1024/1024/1024 as SUM_DATA_INDEX FROM information_schema.TABLES</span></div><div style="font-family: Monaco; font-size: 11pt; color: rgb(51, 51, 51);"><span style="font-family: &quot;DejaVu Sans Mono&quot;;color: rgb(0, 128, 0);font-size: 9pt;background-color: rgb(255, 250, 165);-evernote-highlight:true;">    WHERE TABLE_SCHEMA!='information_schema' AND TABLE_SCHEMA!='mysql' GROUP BY TABLE_SCHEMA;</span></div><div style="font-family: Monaco; font-size: 11pt; color: rgb(51, 51, 51);"><div style="font-family: DejaVu Sans Mono; font-size: 9pt; color: rgb(0, 128, 0);"><span style="font-family: &quot;DejaVu Sans Mono&quot;; color: rgb(0, 128, 0); font-size: 9pt;">+--------------------+----------------+----------------+----------------+</span></div><div style="font-family: DejaVu Sans Mono; font-size: 9pt; color: rgb(0, 128, 0);"><span style="font-family: &quot;DejaVu Sans Mono&quot;; color: rgb(0, 128, 0); font-size: 9pt;">| TABLE_SCHEMA       | DATA_LENGTH    | INDEX_LENGTH   | SUM_DATA_INDEX |</span></div><div style="font-family: DejaVu Sans Mono; font-size: 9pt; color: rgb(0, 128, 0);"><span style="font-family: &quot;DejaVu Sans Mono&quot;; color: rgb(0, 128, 0); font-size: 9pt;">+--------------------+----------------+----------------+----------------+</span></div><div style="font-family: DejaVu Sans Mono; font-size: 9pt; color: rgb(0, 128, 0);"><span style="font-family: &quot;DejaVu Sans Mono&quot;; color: rgb(0, 128, 0); font-size: 9pt;">| performance_schema | 0.000000000000 | 0.000000000000 | 0.000000000000 |</span></div><div style="font-family: DejaVu Sans Mono; font-size: 9pt; color: rgb(0, 128, 0);"><span style="font-family: &quot;DejaVu Sans Mono&quot;; color: rgb(0, 128, 0); font-size: 9pt;">| sys                | 0.000015258789 | 0.000000000000 | 0.000015258789 |</span></div><div style="font-family: DejaVu Sans Mono; font-size: 9pt; color: rgb(0, 128, 0);"><span style="font-family: &quot;DejaVu Sans Mono&quot;; color: rgb(0, 128, 0); font-size: 9pt;">| test               | 0.000015258789 | 0.000000000000 | 0.000015258789 |</span></div><div style="font-family: DejaVu Sans Mono; font-size: 9pt; color: rgb(0, 128, 0);"><span style="font-family: &quot;DejaVu Sans Mono&quot;; color: rgb(0, 128, 0); font-size: 9pt;">+--------------------+----------------+----------------+----------------+</span></div></div><div style="font-family: Monaco; font-size: 11pt; color: rgb(51, 51, 51);"><span style="font-family: &quot;DejaVu Sans Mono&quot;; color: rgb(0, 128, 0); font-size: 9pt;">2 rows in set (0.08 sec)</span></div><div style="font-family: Monaco; font-size: 11pt; color: rgb(51, 51, 51);"><br style="font-family: Monaco; font-size: 11pt; color: rgb(51, 51, 51);"/></div><div style="font-family: Monaco; font-size: 11pt; color: rgb(51, 51, 51);"><span style="font-family: &quot;DejaVu Sans Mono&quot;; color: rgb(0, 128, 0); font-size: 9pt;">mysql&gt;</span></div></div></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 16px;"><br/></span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 16px; font-weight: bold; line-height: 1.75;">统计库里每个表的大小</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"><div style="font-family: DejaVu Sans Mono; font-size: 9pt; color: rgb(0, 128, 0);"><span style="font-family: &quot;DejaVu Sans Mono&quot;; color: rgb(0, 128, 0); font-size: 9pt;">mysql&gt; SELECT TABLE_NAME,DATA_LENGTH,INDEX_LENGTH,SUM(DATA_LENGTH+INDEX_LENGTH) AS TOTAL_SIZE</span></div><div style="font-family: DejaVu Sans Mono; font-size: 9pt; color: rgb(0, 128, 0);"><span style="font-family: &quot;DejaVu Sans Mono&quot;; color: rgb(0, 128, 0); font-size: 9pt;">    FROM information_schema.TABLES</span></div><div style="font-family: DejaVu Sans Mono; font-size: 9pt; color: rgb(0, 128, 0);"><span style="font-family: &quot;DejaVu Sans Mono&quot;; color: rgb(0, 128, 0); font-size: 9pt;">    WHERE TABLE_SCHEMA='test' GROUP BY TABLE_NAME;</span></div><div style="font-family: DejaVu Sans Mono; font-size: 9pt; color: rgb(0, 128, 0);"><span style="font-family: &quot;DejaVu Sans Mono&quot;; color: rgb(0, 128, 0); font-size: 9pt;">+------------+-------------+--------------+------------+</span></div><div style="font-family: DejaVu Sans Mono; font-size: 9pt; color: rgb(0, 128, 0);"><span style="font-family: &quot;DejaVu Sans Mono&quot;; color: rgb(0, 128, 0); font-size: 9pt;">| TABLE_NAME | DATA_LENGTH | INDEX_LENGTH | TOTAL_SIZE |</span></div><div style="font-family: DejaVu Sans Mono; font-size: 9pt; color: rgb(0, 128, 0);"><span style="font-family: &quot;DejaVu Sans Mono&quot;; color: rgb(0, 128, 0); font-size: 9pt;">+------------+-------------+--------------+------------+</span></div><div style="font-family: DejaVu Sans Mono; font-size: 9pt; color: rgb(0, 128, 0);"><span style="font-family: &quot;DejaVu Sans Mono&quot;; color: rgb(0, 128, 0); font-size: 9pt;">| t1         |       16384 |            0 |      16384 |</span></div><div style="font-family: DejaVu Sans Mono; font-size: 9pt; color: rgb(0, 128, 0);"><span style="font-family: &quot;DejaVu Sans Mono&quot;; color: rgb(0, 128, 0); font-size: 9pt;">+------------+-------------+--------------+------------+</span></div><div style="font-family: DejaVu Sans Mono; font-size: 9pt; color: rgb(0, 128, 0);"><span style="font-family: &quot;DejaVu Sans Mono&quot;; color: rgb(0, 128, 0); font-size: 9pt;">1 row in set (0.00 sec)</span></div></div><div style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"><br/></div></div></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><br/></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 16px; font-weight: bold; line-height: 1.75;">统计所有数据库的大小</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"><span style="font-family: &quot;DejaVu Sans Mono&quot;; color: rgb(0, 128, 0); font-size: 9pt;">mysql&gt; select sum(data_length+index_length)/1024/1024/1024 from information_schema.tables;</span></div><div style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"><span style="font-family: &quot;DejaVu Sans Mono&quot;; color: rgb(0, 128, 0); font-size: 9pt;">+----------------------------------------------+</span></div><div style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"><span style="font-family: &quot;DejaVu Sans Mono&quot;; color: rgb(0, 128, 0); font-size: 9pt;">| sum(data_length+index_length)/1024/1024/1024 |</span></div><div style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"><span style="font-family: &quot;DejaVu Sans Mono&quot;; color: rgb(0, 128, 0); font-size: 9pt;">+----------------------------------------------+</span></div><div style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"><span style="font-family: &quot;DejaVu Sans Mono&quot;; color: rgb(0, 128, 0); font-size: 9pt;">|                               0.002552489750 |</span></div><div style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"><span style="font-family: &quot;DejaVu Sans Mono&quot;; color: rgb(0, 128, 0); font-size: 9pt;">+----------------------------------------------+</span></div><div style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"><span style="font-family: &quot;DejaVu Sans Mono&quot;; color: rgb(0, 128, 0); font-size: 9pt;">1 row in set (0.04 sec)</span></div><div><br/></div></div></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">index_length 都为0, 表示只有主键,或是没索引</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><br/></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 16px; font-weight: bold; line-height: 1.75;">统计客户端连接数</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"><span style="font-family: &quot;DejaVu Sans Mono&quot;; color: rgb(0, 128, 0); font-size: 9pt;">[root@lyucan ~]# netstat -anlp|grep 3306|grep tcp|awk '{print $5}'|awk -F: '{print $1}'|sort|uniq -c|sort -nr|head -n20</span></div><div style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"><span style="font-family: &quot;DejaVu Sans Mono&quot;; color: rgb(0, 128, 0); font-size: 9pt;">      3 119.123.76.61</span></div><div style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"><span style="font-family: &quot;DejaVu Sans Mono&quot;; color: rgb(0, 128, 0); font-size: 9pt;">      1</span></div><div style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"><span style="font-family: &quot;DejaVu Sans Mono&quot;; color: rgb(0, 128, 0); font-size: 9pt;">[root@lyucan ~]# mysql -uroot -p -e &quot;show processlist&quot;|awk '{print $3}' |awk -F: '{print $1}' |sort |uniq -c |sort -nr</span></div><div style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"><span style="font-family: &quot;DejaVu Sans Mono&quot;; color: rgb(0, 128, 0); font-size: 9pt;">Enter password:</span></div><div style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"><span style="font-family: &quot;DejaVu Sans Mono&quot;; color: rgb(0, 128, 0); font-size: 9pt;">      3 119.123.76.61</span></div><div style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"><span style="font-family: &quot;DejaVu Sans Mono&quot;; color: rgb(0, 128, 0); font-size: 9pt;">      2 localhost</span></div><div style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"><span style="font-family: &quot;DejaVu Sans Mono&quot;; color: rgb(0, 128, 0); font-size: 9pt;">      1 Host</span></div><div style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"><span style="font-family: &quot;DejaVu Sans Mono&quot;; color: rgb(0, 128, 0); font-size: 9pt;">[root@lyucan ~]#</span></div><div><br/></div></div></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><br/></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 16px; font-weight: bold; line-height: 1.75;">MySQL在什么状态收集统计信息</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">1. 访问information_schema.tables 会收集</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">2. 数据库重启</span></div><div><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">3. show table status;</span></div></span>
</div></body></html> 