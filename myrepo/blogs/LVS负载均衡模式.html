<html>
<head>
  <title>LVS负载均衡模式</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="Evernote Windows/307027 (zh-CN, DDL); Windows/10.0.0 (Win64);"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="390"/>
<h1>LVS负载均衡模式</h1>

<div>
<span><div><div><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">LVS</span><span style="font-size: 14px; white-space: pre-wrap;">负载均衡模式</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">LVS-DR模式 （直接路由模式）</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">LVS-NAT模式 （NAT）</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">LVS-TUN模式 （隧道模式）</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><br/></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">硬件设备</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">    F5，BIG IP</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">    Citrix，Netscaler</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">    A10</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">软件</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">    四层</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">        LVS</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">    七层</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">        nginx</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">            http，smtp，pop3，imap</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">        haproxy</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">            http，tcp（mysql，smtp）</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><br/></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><br/></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">负载均衡调度算法</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">静态调度算法</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">1、轮循调度（Round Robin）（rr）</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">2、加权轮循（Weight Round Robin）（wrr）</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">3、目标地址散列（Destination Hashing）（DH）</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">根据请求的目标IP地址，作为散列键（hash key）从静态分配的散列表找出对应的服务器，若该服务器是可用的且未超载，将请求发送到该服务器，否则返回空。</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">当一个请求访问时将其丢给一台机器响应，当它下次再来请求时，将他丢给同一台机器进行响应</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">4、源地址散列（Source Hashing）（SH）</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">根据请求的源IP地址，作为散列键（hash key）从静态分配的散列键表找出对应的服务器，若该服务器是可用的且未超载，将请求发送到该服务器，否则返回空。</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">当出口有多个时，根据源IP地址，出去是经过哪个接口，回来还是经过那个接口</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><br/></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">动态调度算法</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">5、最少连接（Least Connections）（LC）</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">根据活动连接和非活动连接计算开销，计算公式为：活动连接*256+非活动连接，哪个计算结果小，就将请求丢给哪个服务器</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75; color: rgb(255, 0, 0);">6、加权最少连接（Weight Least Connections）（WLC）（最优秀的调度算法，系统默认也是这个）</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">在集群系统的服务器想能差异较大的情况下，调度器采用“加权最少连接”调度算法优化负载均衡性能，具有较高的服务器将承受较大比例的活动连接负载。调度器可以自动询问真实服务器的负载情况，并动态的调整其权值。</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">根据计算公式：（</span><span style="white-space: pre-wrap; font-size: 14px; background-color: rgb(255, 255, 255); line-height: 1.75;">活动连接*256+非活动连接</span><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">）/权重，哪个计算结果小，就将请求丢给哪个服务器</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">7、最短的期望延迟（Shortest Expected Delay）(SED)</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">在WLC的基础上做了一下微调，不考虑非活动连接数，只考虑活动连接。</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">计算公式为：（（活动连接+1）*256）/权重</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">8、最少队列调度（Never Queue ）（NQ）</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">无需队列，如果连接数等于0，就直接分配一个连接过去，不需要进行SED运算</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">9、基于局部性的最少连接（Locality-Based Least Connections）（LBLC）</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">针对目标地址的负载均衡，目前主要用于cache集群系统。该算法根据请求的目标IP地址找到该目标IP地址最近使用的服务器，若该服务器是可用的且没有超载，将请求发送到该服务器，若服务器不存在，或者该服务器超载且有服务器处于一半的工作负载，则用“最少连接的”原则选出一个可用的服务器，将其发送到该服务器</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">10、带复制的基于局部性最少连接（</span><span style="white-space: pre-wrap; font-size: 14px; background-color: rgb(255, 255, 255); line-height: 1.75;">Locality-Based Least Connections with Replication</span><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">）（LBLCR）</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">这个调度算法也是针对目标IP地址的负载均衡，目前主要用于cache聚群系统。它与LBLC算法打不通之处是它要维护从一个目标IP地址到一组服务器的映射，而LBLC算法维护从一个目标IP地址到一台服务器的映射。该算法根据请求的目标IP地址找出该目标IP地址对应的服务器组，按“最小连接”原则从服务器组中选出一台服务器，若服务器没有超载，将请求发送到该服务区；若服务器超载，则按“最小连接”原则从这个集群中选出一台服务器，将该服务器加入到服务器组中，将请求发送到该服务器。同时当该服务器组有一段时间没有被修改，将最忙的服务器从服务器组中删除，以降低复制程度。</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><br/></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">LVS-NAT</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;"><img src="LVS负载均衡模式_files/Image.png" type="image/png" data-filename="Image.png" style="font-size: 11pt;"/><br/></span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">LVS-NAT特性</span><br/></span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">RS必须与DR在同一网络，仅用于与DR服务器通讯</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">DR接受所有的数据包通讯（包括客户端Direcor、Dirctor和realserver直接的通讯）</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">RealServer的默认网关必须要指向到Director</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">Director支持端口映射，可以将客户端的请求映射到RealServer的另一端口</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">能支持任意操作系统</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">单一的Director是整个集群的瓶颈</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><br/></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">配置LVS-NAT</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">实验环境，4台虚拟机CentOS7.0，一台DR调度器，两台后端Real Server，一台客户端。</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">Director调度器：</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">    vip：10.10.10.1（对外的公网ip）</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">    内网ip：192.168.10.1（用于和后端RS通信）</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">    掩码：255.255.255.0</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><br/></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">RealServer1：</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">    ip：192.168.10.100</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">    gateway：192.168.10.1（网关一定要指向调度器的内网ip）</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">    </span><span style="white-space: pre-wrap; font-size: 14px; background-color: rgb(255, 255, 255); line-height: 1.75;">掩码：255.255.255.0</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><br/></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">RealServer：</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">    ip：192.168.10.200</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">    gateway：192.168.10.1</span><span style="white-space: pre-wrap; font-size: 14px; background-color: rgb(255, 255, 255); line-height: 1.75;">（网关一定要指向调度器的内网ip）</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">    </span><span style="white-space: pre-wrap; font-size: 14px; background-color: rgb(255, 255, 255); line-height: 1.75;">掩码：255.255.255.0</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><br/></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">Client：</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">    ip：10.10.10.2</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">    </span><span style="white-space: pre-wrap; font-size: 14px; background-color: rgb(255, 255, 255); line-height: 1.75;">掩码：255.255.255.0</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><br/></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">查看网络配置</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">Director：</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">[</span><a href="mailto:root@Director" style="white-space: pre-wrap; font-size: 14px; line-height: 1.75; color: rgb(0, 56, 132); text-decoration: underline;">root@Director</a><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;"> ~]# cat /etc/sysconfig/network-scripts/ifcfg-eno16777736 </span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">TYPE=Ethernet</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">BOOTPROTO=none</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">NAME=eno16777736</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">ONBOOT=yes</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">IPADDR=192.168.10.1</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">NETMASK=255.255.255.0</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">HWADDR=00:0c:29:9a:a1:85</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><br/></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">[</span><a href="mailto:root@Director" style="white-space: pre-wrap; font-size: 14px; line-height: 1.75; color: rgb(0, 56, 132); text-decoration: underline;">root@Director</a><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;"> ~]# cat /etc/sysconfig/network-scripts/ifcfg-eno33554992 </span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">TYPE=Ethernet</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">BOOTPROTO=none</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">NAME=eno33554992</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">ONBOOT=yes</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">IPADDR=10.10.10.1</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">NETMASK=255.255.255.0</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">HWADDR=00:0c:29:9a:a1:8f</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><br/></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">RS1：</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">[</span><a href="mailto:root@RealServer1" style="white-space: pre-wrap; font-size: 14px; line-height: 1.75; color: rgb(0, 56, 132); text-decoration: underline;">root@RealServer1</a><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;"> network-scripts]# cat /etc/sysconfig/network-scripts/ifcfg-eno16777736 </span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">TYPE=Ethernet</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">BOOTPROTO=none</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">NAME=eno16777736</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">ONBOOT=yes</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">IPADDR=192.168.10.100</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">NETMASK=255.255.255.0</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">GATEWAY=192.168.10.1</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">HWADDR=00:0c:29:fb:45:31</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><br/></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">RS2：</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">[</span><a href="mailto:root@RealServer2" style="white-space: pre-wrap; font-size: 14px; line-height: 1.75; color: rgb(0, 56, 132); text-decoration: underline;">root@RealServer2</a><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;"> network-scripts]# cat /etc/sysconfig/network-scripts/ifcfg-eno16777736 </span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">TYPE=Ethernet</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">BOOTPROTO=none</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">NAME=eno16777736</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">ONBOOT=yes</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">IPADDR=192.168.10.200</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">NETMASK=255.255.255.0</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">GATEWAY=192.168.10.1</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">HWADDR=00:0c:29:35:4b:51</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><br/></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">Client：</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">[</span><a href="mailto:root@Client" style="white-space: pre-wrap; font-size: 14px; line-height: 1.75; color: rgb(0, 56, 132); text-decoration: underline;">root@Client</a><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;"> network-scripts]# cat /etc/sysconfig/network-scripts/ifcfg-eno16777736 </span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">TYPE=Ethernet</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">BOOTPROTO=none</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">NAME=eno16777736</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">ONBOOT=yes</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">IPADDR=10.10.10.2</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">NETMASK=255.255.255.0</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">HWADDR=00:0c:29:fa:16:ed</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><br/></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">配置完网络后，进行lvs的配置，以下配置只在Director上操作。</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">ipvs已经集成在我们内核里面了，不需要重新编译内核，只需要安装管理套件即可。</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">如何查看我们内核是否支持ipvs呢，使用以下命令：</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">$ cat /boot/config-3.10.0-123.el7.x86_64 | grep -i ipvs</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;"># IPVS transport protocol load balancing support</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;"># IPVS scheduler</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;"># IPVS application helper</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">如果出现以上信息，即表示内核支持ipvs</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><br/></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">安装ipvsadm套件：</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">yum -y install ipvsadm</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><br/></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">开启转发功能：</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">echo 1 &gt; /proc/sys/net/ipv4/ip_forward </span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><br/></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">然后进行ipvsadm的配置</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">$ ipvsadm -A -t 10.10.10.1:80 -s wrr</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">$ ipvsadm -a -t 10.10.10.1:80 -r 192.168.10.100 -m -w 1  （-m使用NAT模式，默认是-g的DR模式）</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">$ ipvsadm -a -t 10.10.10.1:80 -r 192.168.10.200 -m -w 3</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">这里我们的调度算法使用加权轮循，ipvsadm的具体参数使用方法用--help自行查看</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><br/></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">随后在RS1和RS2上分别安装httpd服务，然后写一个index.html页面，为了区分两台RS的内容，我们RS1上写This is RealServer 1，RS2上我们写This is RealServer 2，随后可以进行测试了，为了排除防火墙的干扰，我们先把防火墙关掉再进行测试。iptables -F</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><br/></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">切换到Client进行请求，注意这里我们请求的地址应该是Director上的公网ip地址，不要搞错了</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">[</span><a href="mailto:root@Client" style="white-space: pre-wrap; font-size: 14px; line-height: 1.75; color: rgb(0, 56, 132); text-decoration: underline;">root@Client</a><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;"> ~]# curl </span><a href="http://10.10.10.1/" style="white-space: pre-wrap; font-size: 14px; line-height: 1.75; color: rgb(0, 56, 132); text-decoration: underline;">http://10.10.10.1</a></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">This is RealServer 2</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">[</span><a href="mailto:root@Client" style="white-space: pre-wrap; font-size: 14px; line-height: 1.75; color: rgb(0, 56, 132); text-decoration: underline;">root@Client</a><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;"> ~]# curl </span><a href="http://10.10.10.1/" style="white-space: pre-wrap; font-size: 14px; line-height: 1.75; color: rgb(0, 56, 132); text-decoration: underline;">http://10.10.10.1</a></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">This is RealServer 2</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">[</span><a href="mailto:root@Client" style="white-space: pre-wrap; font-size: 14px; line-height: 1.75; color: rgb(0, 56, 132); text-decoration: underline;">root@Client</a><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;"> ~]# curl </span><a href="http://10.10.10.1/" style="white-space: pre-wrap; font-size: 14px; line-height: 1.75; color: rgb(0, 56, 132); text-decoration: underline;">http://10.10.10.1</a></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">This is RealServer 2</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">[</span><a href="mailto:root@Client" style="white-space: pre-wrap; font-size: 14px; line-height: 1.75; color: rgb(0, 56, 132); text-decoration: underline;">root@Client</a><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;"> ~]# curl </span><a href="http://10.10.10.1/" style="white-space: pre-wrap; font-size: 14px; line-height: 1.75; color: rgb(0, 56, 132); text-decoration: underline;">http://10.10.10.1</a></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">This is RealServer 1</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">[</span><a href="mailto:root@Client" style="white-space: pre-wrap; font-size: 14px; line-height: 1.75; color: rgb(0, 56, 132); text-decoration: underline;">root@Client</a><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;"> ~]# curl </span><a href="http://10.10.10.1/" style="white-space: pre-wrap; font-size: 14px; line-height: 1.75; color: rgb(0, 56, 132); text-decoration: underline;">http://10.10.10.1</a></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">This is RealServer 2</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">[</span><a href="mailto:root@Client" style="white-space: pre-wrap; font-size: 14px; line-height: 1.75; color: rgb(0, 56, 132); text-decoration: underline;">root@Client</a><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;"> ~]# curl </span><a href="http://10.10.10.1/" style="white-space: pre-wrap; font-size: 14px; line-height: 1.75; color: rgb(0, 56, 132); text-decoration: underline;">http://10.10.10.1</a></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">This is RealServer 2</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">[</span><a href="mailto:root@Client" style="white-space: pre-wrap; font-size: 14px; line-height: 1.75; color: rgb(0, 56, 132); text-decoration: underline;">root@Client</a><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;"> ~]# curl </span><a href="http://10.10.10.1/" style="white-space: pre-wrap; font-size: 14px; line-height: 1.75; color: rgb(0, 56, 132); text-decoration: underline;">http://10.10.10.1</a></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">This is RealServer 2</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">[</span><a href="mailto:root@Client" style="white-space: pre-wrap; font-size: 14px; line-height: 1.75; color: rgb(0, 56, 132); text-decoration: underline;">root@Client</a><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;"> ~]# curl </span><a href="http://10.10.10.1/" style="white-space: pre-wrap; font-size: 14px; line-height: 1.75; color: rgb(0, 56, 132); text-decoration: underline;">http://10.10.10.1</a></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">This is RealServer 1</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">可以看到，我们的请求丢给RS2三次，然后丢给RS1一次，再丢给RS2三次，lvs的调度基本上而没有出现问题。</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><br/></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">然后我们使用压力测试工具ab进行大量的请求模拟</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">ab -c 10 -n 10000</span> <a href="http://10.10.10.1/index.html" style="white-space: pre-wrap; font-size: 14px; line-height: 1.75; color: rgb(0, 56, 132); text-decoration: underline;">http://10.10.10.1/index.html</a></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><br/></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">完成后切换到Director查看一下连接数，可以看到大致是1:3的比例。</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">[</span><a href="mailto:root@Director" style="white-space: pre-wrap; font-size: 14px; line-height: 1.75; color: rgb(0, 56, 132); text-decoration: underline;">root@Director</a><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;"> ~]# ipvsadm -L -n</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">IP Virtual Server version 1.2.1 (size=4096)</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">Prot LocalAddress:Port Scheduler Flags</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">  -&gt; RemoteAddress:Port           Forward Weight ActiveConn InActConn</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">TCP  10.10.10.1:80 wrr</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">  -&gt; 192.168.10.100:80            Masq    1      0          2501      </span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">  -&gt; 192.168.10.200:80            Masq    3      0          7503      </span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><br/></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><br/></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><br/></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><br/></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">LVS-DR</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;"><img src="LVS负载均衡模式_files/Image [1].png" type="image/png" data-filename="Image.png" style="font-size: 11pt;"/><br/></span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;"><br/></span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">LVS-DR特性</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">RealServer必须与Director在同一网络</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">RealServer不需要是一个私有ip地址</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">Director将接收进来的数据包，根据调度算法将数据包转发到后端的RealServer上</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">RealServer不需要使用Director作为默认网关</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">能支持更多操作系统</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">相对于NAT模式来说，能支持更多的RealServer</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><br/></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><br/></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">lvs中内核参数作用</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">在2.4.26及2.6.4以后的内核中，系统默认支持两个内核参数</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><br/></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">arp_announce：对网络接口上本地ip地址发出的ARP回应做出相应级别的限制</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">0（默认）：在任意网络接口上的任何本地地址</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">1：尽量避免不在该网络接口子网段的本地地址，当发起ARP请求的源地址是被设置应该经由路由达到此网络接口的时候很有用，此时会检查来访ip是否为所有接口上的子网段内ip之一，如果该来访ip不属于各个网络接口上的子网段内，那么将采用级别2的方式来进行处理。</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">2：对查询目标使用最适当的本地地址，在此模式下将忽略这个ip数据包的源地址并尝试选择与能与该地址通信的本地地址。首要是选择所有的网络接口的子网中外出访问子网中包含该目标ip地址的本地地址。如果没有合适的地址被发现，将选择当前的发送网络接口或其他的有可能接收到该ARP回应的网络接口来进行发送。</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><br/></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">arp_ignore：定义对目标地址为本地ip的ARP询问不同的应答模式</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">0（默认）：回应任何网络接口上对任何本地ip地址的ARP查询请求</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">1：只回答目标ip地址是来访网络接口本地地址的ARP查询请求</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">2：只回答目标ip地址是来访网络接口本地地址的ARP查询请求，且来访ip必须在该网络接口的子网段内</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">3：不回应该网络界面的ARP请求，而只对设置的唯一和链接地址做出回应addresses are</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">4-7：保留未使用</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">8：不回应所有（本地地址）的ARP查询请求</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><br/></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">配置</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">实验环境：</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">    Director：192.168.10.1（eno16777736）</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">                     192.168.10.250（eno16777736:1）（vip）</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">    RS1：192.168.10.100（eno16777736）</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">              192.168.10.250（lo:1）（vip）</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">    RS2：192.168.10.200（eno16777736）</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">              192.168.10.250（lo:1）（vip）</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><br/></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">Director上配置：</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">    ifconfig eno16777736:1 $vip broadcast $vip netmask 255.255.255.255 up</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">    route add -host $vip dev eno16777736:1</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">    ipvsadm -C</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">    ipvsadm -A -t $vip:80 -s wlc</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">    ipvsadm -a -t $vip:80 -r 192.169.10.100 -g -w 1   （-g使用DR模式，也是默认的模式）</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">    </span><span style="white-space: pre-wrap; font-size: 14px; background-color: rgb(255, 255, 255); line-height: 1.75;">ipvsadm -a -t $vip:80 -r 192.169.10.200 -g -w 2</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">RS上配置（1和2配置相同）：</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">    echo 1 &gt; /proc/sys/net/ipv4/conf/lo/arp_ignore </span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">    echo 1 &gt; /proc/sys/net/ipv4/conf/all/arp_ignore</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">    echo 2 &gt; /proc/sys/net/ipv4/conf/lo/arp_announce</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">    echo 2 &gt; /proc/sys/net/ipv4/conf/all/arp_announce</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">    ifconfig lo:1 $vip broadcast $vip netmask 255.255.255.255 up</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">    route add -host $vip dev lo:1</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><br/></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;"><span style="color: rgb(51, 51, 51); font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;">上面绑定VIP的掩码是”</span><span style="font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;"><font style="color: rgb(227, 0, 0);">255.255.255.255</font></span><span style="color: rgb(51, 51, 51); font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;">″，说明广播地址是其本身，那么他就不会将ARP发送到实际的自己该属于的广播域了，这样防止与LVS上VIP冲突，而导致IP冲突。</span><br/></span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;"><span style="color: rgb(51, 51, 51); font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;"><br/></span></span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">客户端配置：</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">    将ip设置为192.168.10.*同一网段即可（注意不要冲突）。</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><br/></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">测试：</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">[</span><a href="mailto:root@Client" style="white-space: pre-wrap; font-size: 14px; line-height: 1.75; color: rgb(0, 56, 132); text-decoration: underline;">root@Client</a><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;"> ~]# curl </span><a href="http://192.168.10.250/" style="white-space: pre-wrap; font-size: 14px; line-height: 1.75; color: rgb(0, 56, 132); text-decoration: underline;">http://192.168.10.250</a></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">This is RealServer 1</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">[</span><a href="mailto:root@Client" style="white-space: pre-wrap; font-size: 14px; line-height: 1.75; color: rgb(0, 56, 132); text-decoration: underline;">root@Client</a><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;"> ~]# curl </span><a href="http://192.168.10.250/" style="white-space: pre-wrap; font-size: 14px; line-height: 1.75; color: rgb(0, 56, 132); text-decoration: underline;">http://192.168.10.250</a></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">This is RealServer 2</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">[</span><a href="mailto:root@Client" style="white-space: pre-wrap; font-size: 14px; line-height: 1.75; color: rgb(0, 56, 132); text-decoration: underline;">root@Client</a><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;"> ~]# curl </span><a href="http://192.168.10.250/" style="white-space: pre-wrap; font-size: 14px; line-height: 1.75; color: rgb(0, 56, 132); text-decoration: underline;">http://192.168.10.250</a></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">This is RealServer 2</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">[</span><a href="mailto:root@Client" style="white-space: pre-wrap; font-size: 14px; line-height: 1.75; color: rgb(0, 56, 132); text-decoration: underline;">root@Client</a><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;"> ~]# curl </span><a href="http://192.168.10.250/" style="white-space: pre-wrap; font-size: 14px; line-height: 1.75; color: rgb(0, 56, 132); text-decoration: underline;">http://192.168.10.250</a></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">This is RealServer 1</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">[</span><a href="mailto:root@Client" style="white-space: pre-wrap; font-size: 14px; line-height: 1.75; color: rgb(0, 56, 132); text-decoration: underline;">root@Client</a><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;"> ~]# curl </span><a href="http://192.168.10.250/" style="white-space: pre-wrap; font-size: 14px; line-height: 1.75; color: rgb(0, 56, 132); text-decoration: underline;">http://192.168.10.250</a></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">This is RealServer 2</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">[</span><a href="mailto:root@Client" style="white-space: pre-wrap; font-size: 14px; line-height: 1.75; color: rgb(0, 56, 132); text-decoration: underline;">root@Client</a><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;"> ~]# curl </span><a href="http://192.168.10.250/" style="white-space: pre-wrap; font-size: 14px; line-height: 1.75; color: rgb(0, 56, 132); text-decoration: underline;">http://192.168.10.250</a></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">This is RealServer 2</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">[</span><a href="mailto:root@Client" style="white-space: pre-wrap; font-size: 14px; line-height: 1.75; color: rgb(0, 56, 132); text-decoration: underline;">root@Client</a><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;"> ~]# curl </span><a href="http://192.168.10.250/" style="white-space: pre-wrap; font-size: 14px; line-height: 1.75; color: rgb(0, 56, 132); text-decoration: underline;">http://192.168.10.250</a></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><br/></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><br/></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">keepalived</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">安装</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">yum -y install gcc kernel-devel openssl-devel</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><br/></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">下载源码包 </span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; background-color: rgb(255, 255, 255); line-height: 1.75;">wget </span><a href="http://www.keepalived.org/software/keepalived-1.2.24.tar.gz" style="white-space: pre-wrap; font-size: 14px; background-color: rgb(255, 255, 255); line-height: 1.75; color: rgb(0, 56, 132); text-decoration: underline;">http://www.keepalived.org/software/keepalived-1.2.24.tar.gz</a></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">解压配置</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">tar 。。。。</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">./configure --prefix=/usr/local/ --with-kernel-dir=/usr/src/kernels/2.6.32-642.4.2.el6.x86_64/</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><br/></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><br/></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><br/></div><ol><li style="text-align: left; font-size: 12px; list-style-position: inside; white-space: pre-wrap; word-break: break-word; list-style-type: decimal;"><div><span style="font-size: 12px; background-color: rgb(255, 255, 255); color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-style: normal; font-weight: normal; line-height: 1.75;">#全局定义部分  </span></div></li><li style="text-align: left; font-size: 12px; list-style-position: inside; white-space: pre-wrap; word-break: break-word; list-style-type: decimal;"><div><span style="font-size: 12px; background-color: rgb(248, 248, 248); color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-style: normal; font-weight: normal; line-height: 1.75;">global_defs {  </span></div></li><li style="text-align: left; font-size: 12px; list-style-position: inside; white-space: pre-wrap; word-break: break-word; list-style-type: decimal;"><div><span style="font-size: 12px; background-color: rgb(255, 255, 255); color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-style: normal; font-weight: normal; line-height: 1.75;">    notification_email{  </span></div></li><li style="text-align: left; font-size: 12px; list-style-position: inside; white-space: pre-wrap; word-break: break-word; list-style-type: decimal;"><div><span style="font-size: 12px; background-color: rgb(248, 248, 248); color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-style: normal; font-weight: normal; line-height: 1.75;"><a href="mailto:1547840014@qq.com" style="font-family: &quot;Courier New&quot;; font-size: 12px; font-style: normal; font-weight: normal; line-height: 1.75; background-color: rgb(248, 248, 248);">1547840014@qq.com</a>   #设置报警邮件地址,可以设置多个,每行一个。需要开启邮件服务功能  </span></div></li><li style="text-align: left; font-size: 12px; list-style-position: inside; white-space: pre-wrap; word-break: break-word; list-style-type: decimal;"><div><span style="font-size: 12px; background-color: rgb(255, 255, 255);"><a href="mailto:1547840014@qq.com" style="font-family: &quot;Courier New&quot;; font-size: 12px; font-style: normal; font-weight: normal; line-height: 1.75; background-color: rgb(255, 255, 255);">1547840014@qq.com</a></span></div></li><li style="text-align: left; font-size: 12px; list-style-position: inside; white-space: pre-wrap; word-break: break-word; list-style-type: decimal;"><div><span style="font-size: 12px; background-color: rgb(248, 248, 248); color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-style: normal; font-weight: normal; line-height: 1.75;">    }  </span></div></li><li style="text-align: left; font-size: 12px; list-style-position: inside; white-space: pre-wrap; word-break: break-word; list-style-type: decimal;"><div><span style="font-size: 12px; background-color: rgb(255, 255, 255); color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-style: normal; font-weight: normal; line-height: 1.75;">    notification_email_from  keepalived@localhost  #设置邮件的发送地址  </span></div></li><li style="text-align: left; font-size: 12px; list-style-position: inside; white-space: pre-wrap; word-break: break-word; list-style-type: decimal;"><div><span style="font-size: 12px; background-color: rgb(248, 248, 248); color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-style: normal; font-weight: normal; line-height: 1.75;">    smtp_server 192.168.200.1   #设置smtp server地址  </span></div></li><li style="text-align: left; font-size: 12px; list-style-position: inside; white-space: pre-wrap; word-break: break-word; list-style-type: decimal;"><div><span style="font-size: 12px; background-color: rgb(255, 255, 255); color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-style: normal; font-weight: normal; line-height: 1.75;">    smtp_connect_timeout 30    #设置连接smtp server的超时时间  </span></div></li><li style="text-align: left; font-size: 12px; list-style-position: inside; white-space: pre-wrap; word-break: break-word; list-style-type: decimal;"><div><span style="font-size: 12px; background-color: rgb(248, 248, 248); color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-style: normal; font-weight: normal; line-height: 1.75;">    router_id  LVS_DEVEL     #表示运行keepalived服务器的一个标识,发邮件时显示在邮件主题中的信息  </span></div></li><li style="text-align: left; font-size: 12px; list-style-position: inside; white-space: pre-wrap; word-break: break-word; list-style-type: decimal;"><div><span style="font-size: 12px; background-color: rgb(255, 255, 255); color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-style: normal; font-weight: normal; line-height: 1.75;">}  </span></div></li><li style="text-align: left; font-size: 12px; list-style-position: inside; white-space: pre-wrap; word-break: break-word; list-style-type: decimal;"><div><span style="font-size: 12px; background-color: rgb(248, 248, 248); color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-style: normal; font-weight: normal; line-height: 1.75;">  </span></div></li><li style="text-align: left; font-size: 12px; list-style-position: inside; white-space: pre-wrap; word-break: break-word; list-style-type: decimal;"><div><span style="font-size: 12px; background-color: rgb(255, 255, 255); color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-style: normal; font-weight: normal; line-height: 1.75;">vrrp_instance VI_1 {  </span></div></li><li style="text-align: left; font-size: 12px; list-style-position: inside; white-space: pre-wrap; word-break: break-word; list-style-type: decimal;"><div><span style="font-size: 12px; background-color: rgb(248, 248, 248); color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-style: normal; font-weight: normal; line-height: 1.75;">    state MASTER      #指定keepalived的角色,MASTER表示此主机是主服务器,#BACKUP表示此主机是备份服务器  </span></div></li><li style="text-align: left; font-size: 12px; list-style-position: inside; white-space: pre-wrap; word-break: break-word; list-style-type: decimal;"><div><span style="font-size: 12px; background-color: rgb(255, 255, 255); color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-style: normal; font-weight: normal; line-height: 1.75;">    interface eth0    #指定HA检测网络的接口  </span></div></li><li style="text-align: left; font-size: 12px; list-style-position: inside; white-space: pre-wrap; word-break: break-word; list-style-type: decimal;"><div><span style="font-size: 12px; background-color: rgb(248, 248, 248); color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-style: normal; font-weight: normal; line-height: 1.75;">    virtual_router_id  51  #虚拟路由标识,这个标识是一个数字,同一个vrrp实例使用唯一的标识,即同一个  </span></div></li><li style="text-align: left; font-size: 12px; list-style-position: inside; white-space: pre-wrap; word-break: break-word; list-style-type: decimal;"><div><span style="font-size: 12px; background-color: rgb(255, 255, 255); color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-style: normal; font-weight: normal; line-height: 1.75;">                           vrrp_instance下,MASTER和BACKUP必须是一致的  </span></div></li><li style="text-align: left; font-size: 12px; list-style-position: inside; white-space: pre-wrap; word-break: break-word; list-style-type: decimal;"><div><span style="font-size: 12px; background-color: rgb(248, 248, 248); color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-style: normal; font-weight: normal; line-height: 1.75;">    priority  100    #定义优先级,数字越大,优先级越高.在一个vrrp_instance下,MASTER的优先级必须大于BACKUP      </span></div></li><li style="text-align: left; font-size: 12px; list-style-position: inside; white-space: pre-wrap; word-break: break-word; list-style-type: decimal;"><div><span style="font-size: 12px; background-color: rgb(255, 255, 255); color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-style: normal; font-weight: normal; line-height: 1.75;">    advert_int 1      #设定master和backup负载均衡器之间同步检查的时间间隔,单位是秒  </span></div></li><li style="text-align: left; font-size: 12px; list-style-position: inside; white-space: pre-wrap; word-break: break-word; list-style-type: decimal;"><div><span style="font-size: 12px; background-color: rgb(248, 248, 248); color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-style: normal; font-weight: normal; line-height: 1.75;">    authentication{  #设定验证类型和密码  </span></div></li><li style="text-align: left; font-size: 12px; list-style-position: inside; white-space: pre-wrap; word-break: break-word; list-style-type: decimal;"><div><span style="font-size: 12px; background-color: rgb(255, 255, 255); color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-style: normal; font-weight: normal; line-height: 1.75;">        auth_type PASS   #设置验证类型,主要有HA和PASS两种  </span></div></li><li style="text-align: left; font-size: 12px; list-style-position: inside; white-space: pre-wrap; word-break: break-word; list-style-type: decimal;"><div><span style="font-size: 12px; background-color: rgb(248, 248, 248); color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-style: normal; font-weight: normal; line-height: 1.75;">        auth_pass 1111   #设置验证密码,在一个vrrp_instance下,MASTER和BACKUP必须使用相同的密码才能正常通信  </span></div></li><li style="text-align: left; font-size: 12px; list-style-position: inside; white-space: pre-wrap; word-break: break-word; list-style-type: decimal;"><div><span style="font-size: 12px; background-color: rgb(255, 255, 255); color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-style: normal; font-weight: normal; line-height: 1.75;">    }  </span></div></li><li style="text-align: left; font-size: 12px; list-style-position: inside; white-space: pre-wrap; word-break: break-word; list-style-type: decimal;"><div><span style="font-size: 12px; background-color: rgb(248, 248, 248); color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-style: normal; font-weight: normal; line-height: 1.75;">    virtual_ipaddress{   #设置虚拟IP地址,可以设置多个虚拟IP地址,每行一个  </span></div></li><li style="text-align: left; font-size: 12px; list-style-position: inside; white-space: pre-wrap; word-break: break-word; list-style-type: decimal;"><div><span style="font-size: 12px; background-color: rgb(255, 255, 255); color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-style: normal; font-weight: normal; line-height: 1.75;">        192.168.1.20  </span></div></li><li style="text-align: left; font-size: 12px; list-style-position: inside; white-space: pre-wrap; word-break: break-word; list-style-type: decimal;"><div><span style="font-size: 12px; background-color: rgb(248, 248, 248); color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-style: normal; font-weight: normal; line-height: 1.75;">    }  </span></div></li><li style="text-align: left; font-size: 12px; list-style-position: inside; white-space: pre-wrap; word-break: break-word; list-style-type: decimal;"><div><span style="font-size: 12px; background-color: rgb(255, 255, 255); color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-style: normal; font-weight: normal; line-height: 1.75;">}  </span></div></li><li style="text-align: left; font-size: 12px; list-style-position: inside; white-space: pre-wrap; word-break: break-word; list-style-type: decimal;"><div><span style="font-size: 12px; background-color: rgb(248, 248, 248); color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-style: normal; font-weight: normal; line-height: 1.75;">#虚拟服务器定义部分  </span></div></li><li style="text-align: left; font-size: 12px; list-style-position: inside; white-space: pre-wrap; word-break: break-word; list-style-type: decimal;"><div><span style="font-size: 12px; background-color: rgb(255, 255, 255); color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-style: normal; font-weight: normal; line-height: 1.75;">virtual_server 192.168.1.20 80 {  #设置虚拟服务器,需要指定虚拟服务器IP地址和服务端口,IP与端口之间用空格隔开  </span></div></li><li style="text-align: left; font-size: 12px; list-style-position: inside; white-space: pre-wrap; word-break: break-word; list-style-type: decimal;"><div><span style="font-size: 12px; background-color: rgb(248, 248, 248); color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-style: normal; font-weight: normal; line-height: 1.75;">     delay_loop  6   #设置运行健康检查时间，单位是秒  </span></div></li><li style="text-align: left; font-size: 12px; list-style-position: inside; white-space: pre-wrap; word-break: break-word; list-style-type: decimal;"><div><span style="font-size: 12px; background-color: rgb(255, 255, 255); color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-style: normal; font-weight: normal; line-height: 1.75;">     lb_algo  rr     #设置负载均衡调度算法,这里设置为rr,即轮询算法  </span></div></li><li style="text-align: left; font-size: 12px; list-style-position: inside; white-space: pre-wrap; word-break: break-word; list-style-type: decimal;"><div><span style="font-size: 12px; background-color: rgb(248, 248, 248); color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-style: normal; font-weight: normal; line-height: 1.75;">     lb_kind  DR        #设置lvs实现负载均衡的机制,有NAT,TUN,DR三个模式可选  </span></div></li><li style="text-align: left; font-size: 12px; list-style-position: inside; white-space: pre-wrap; word-break: break-word; list-style-type: decimal;"><div><span style="font-size: 12px; background-color: rgb(255, 255, 255); color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-style: normal; font-weight: normal; line-height: 1.75;">     persistence_timeout 50  #回话保持时间,单位是秒。这个对网页很有用,为session共享提供了好的方案  </span></div></li><li style="text-align: left; font-size: 12px; list-style-position: inside; white-space: pre-wrap; word-break: break-word; list-style-type: decimal;"><div><span style="font-size: 12px; background-color: rgb(248, 248, 248); color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-style: normal; font-weight: normal; line-height: 1.75;">     protocol TCP    #指定转发协议类型,有TCP和UDP两种  </span></div></li><li style="text-align: left; font-size: 12px; list-style-position: inside; white-space: pre-wrap; word-break: break-word; list-style-type: decimal;"><div><span style="font-size: 12px; background-color: rgb(255, 255, 255); color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-style: normal; font-weight: normal; line-height: 1.75;">     real_server 192.168.1.100 80{  #指定真实服务器的ip地址和端口,之间用空格隔开  </span></div></li><li style="text-align: left; font-size: 12px; list-style-position: inside; white-space: pre-wrap; word-break: break-word; list-style-type: decimal;"><div><span style="font-size: 12px; background-color: rgb(248, 248, 248); color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-style: normal; font-weight: normal; line-height: 1.75;">         weight 3   #权值  </span></div></li><li style="text-align: left; font-size: 12px; list-style-position: inside; white-space: pre-wrap; word-break: break-word; list-style-type: decimal;"><div><span style="font-size: 12px; background-color: rgb(255, 255, 255); color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-style: normal; font-weight: normal; line-height: 1.75;">         TCP_CHECK{  #realserver的状态检测设置部分,单位是秒  </span></div></li><li style="text-align: left; font-size: 12px; list-style-position: inside; white-space: pre-wrap; word-break: break-word; list-style-type: decimal;"><div><span style="font-size: 12px; background-color: rgb(248, 248, 248); color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-style: normal; font-weight: normal; line-height: 1.75;">             connect_timeout 3  #表示3秒无响应超时  </span></div></li><li style="text-align: left; font-size: 12px; list-style-position: inside; white-space: pre-wrap; word-break: break-word; list-style-type: decimal;"><div><span style="font-size: 12px; background-color: rgb(255, 255, 255); color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-style: normal; font-weight: normal; line-height: 1.75;">             nb_get_retry    3  #表示重试次数  </span></div></li><li style="text-align: left; font-size: 12px; list-style-position: inside; white-space: pre-wrap; word-break: break-word; list-style-type: decimal;"><div><span style="font-size: 12px; background-color: rgb(248, 248, 248); color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-style: normal; font-weight: normal; line-height: 1.75;">             delay_before_retry  3  #表示重试间隔  </span></div></li><li style="text-align: left; font-size: 12px; list-style-position: inside; white-space: pre-wrap; word-break: break-word; list-style-type: decimal;"><div><span style="font-size: 12px; background-color: rgb(255, 255, 255); color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-style: normal; font-weight: normal; line-height: 1.75;">         }  </span></div></li><li style="text-align: left; font-size: 12px; list-style-position: inside; white-space: pre-wrap; word-break: break-word; list-style-type: decimal;"><div><span style="font-size: 12px; background-color: rgb(248, 248, 248); color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-style: normal; font-weight: normal; line-height: 1.75;">     }  </span></div></li><li style="text-align: left; font-size: 12px; list-style-position: inside; white-space: pre-wrap; word-break: break-word; list-style-type: decimal;"><div><span style="font-size: 12px; background-color: rgb(255, 255, 255); color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-style: normal; font-weight: normal; line-height: 1.75;">     real_server 192.168.1.200 80{    </span></div></li><li style="text-align: left; font-size: 12px; list-style-position: inside; white-space: pre-wrap; word-break: break-word; list-style-type: decimal;"><div><span style="font-size: 12px; background-color: rgb(248, 248, 248); color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-style: normal; font-weight: normal; line-height: 1.75;">         weight 3   #权值  </span></div></li><li style="text-align: left; font-size: 12px; list-style-position: inside; white-space: pre-wrap; word-break: break-word; list-style-type: decimal;"><div><span style="font-size: 12px; background-color: rgb(255, 255, 255); color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-style: normal; font-weight: normal; line-height: 1.75;">         TCP_CHECK{    </span></div></li><li style="text-align: left; font-size: 12px; list-style-position: inside; white-space: pre-wrap; word-break: break-word; list-style-type: decimal;"><div><span style="font-size: 12px; background-color: rgb(248, 248, 248); color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-style: normal; font-weight: normal; line-height: 1.75;">             connect_timeout 3    </span></div></li><li style="text-align: left; font-size: 12px; list-style-position: inside; white-space: pre-wrap; word-break: break-word; list-style-type: decimal;"><div><span style="font-size: 12px; background-color: rgb(255, 255, 255); color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-style: normal; font-weight: normal; line-height: 1.75;">             nb_get_retry    3    </span></div></li><li style="text-align: left; font-size: 12px; list-style-position: inside; white-space: pre-wrap; word-break: break-word; list-style-type: decimal;"><div><span style="font-size: 12px; background-color: rgb(248, 248, 248); color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-style: normal; font-weight: normal; line-height: 1.75;">             delay_before_retry  3    </span></div></li><li style="text-align: left; font-size: 12px; list-style-position: inside; white-space: pre-wrap; word-break: break-word; list-style-type: decimal;"><div><span style="font-size: 12px; background-color: rgb(255, 255, 255); color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-style: normal; font-weight: normal; line-height: 1.75;">         }  </span></div></li><li style="text-align: left; font-size: 12px; list-style-position: inside; white-space: pre-wrap; word-break: break-word; list-style-type: decimal;"><div><span style="font-size: 12px; background-color: rgb(248, 248, 248); color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-style: normal; font-weight: normal; line-height: 1.75;">     }  </span></div></li><li style="text-align: left; font-size: 12px; list-style-position: inside; white-space: pre-wrap; word-break: break-word; list-style-type: decimal;"><div><span style="font-size: 12px; background-color: rgb(255, 255, 255); color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-style: normal; font-weight: normal; line-height: 1.75;"> }  </span></div></li></ol><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><br/></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-size: 11pt;">global_defs {</span></div><div><span style="font-size: 11pt;">   notification_email {</span></div><div><a href="mailto:example_to@163.com" style="font-size: 11pt;">example_to@163.com</a></div><div><span style="font-size: 11pt;">   }</span></div><div><span style="font-size: 11pt;">   notification_email_from</span> <a href="mailto:example_from@163.com" style="font-size: 11pt;">example_from@163.com</a></div><div><span style="font-size: 11pt;">   smtp_server</span> <a href="http://smtp.163.com/" style="font-size: 11pt;">smtp.163.com</a></div><div><span style="font-size: 11pt;">   smtp_connect_timeout 30</span></div><div><span style="font-size: 11pt;">   router_id LVS_DEVEL</span></div><div><span style="font-size: 11pt;">}</span></div><div><br style="font-size: 11pt;"/></div><div><span style="font-size: 11pt;">vrrp_instance VI_1 {</span></div><div><span style="font-size: 11pt;">    state MASTER</span></div><div><span style="font-size: 11pt;">    interface eno16777736</span></div><div><span style="font-size: 11pt;">    virtual_router_id 51</span></div><div><span style="font-size: 11pt;">    priority 100</span></div><div><span style="font-size: 11pt;">    advert_int 1</span></div><div><span style="font-size: 11pt;">    authentication {</span></div><div><span style="font-size: 11pt;">        auth_type PASS</span></div><div><span style="font-size: 11pt;">        auth_pass 1111</span></div><div><span style="font-size: 11pt;">    }</span></div><div><span style="font-size: 11pt;">    virtual_ipaddress {</span></div><div><span style="font-size: 11pt;">        192.168.10.250</span></div><div><span style="font-size: 11pt;">    }</span></div><div><span style="font-size: 11pt;">}</span></div><div><br style="font-size: 11pt;"/></div><div><span style="font-size: 11pt;">virtual_server 192.168.10.250 80 {</span></div><div><span style="font-size: 11pt;">    delay_loop 6</span></div><div><span style="font-size: 11pt;">    lb_algo rr</span></div><div><span style="font-size: 11pt;">    lb_kind DR</span></div><div><span style="font-size: 11pt;">    persistence_timeout 50</span></div><div><span style="font-size: 11pt;">    protocol TCP</span></div><div><span style="font-size: 11pt;">    real_server 192.168.10.100 80 {</span></div><div><span style="font-size: 11pt;">        weight 1</span></div><div><span style="font-size: 11pt;">        TCP_CHECK {</span></div><div><span style="font-size: 11pt;">            connect_timeout 3</span></div><div><span style="font-size: 11pt;">            nb_get_retry 3</span></div><div><span style="font-size: 11pt;">            delay_before_retry 3</span></div><div><span style="font-size: 11pt;">        }</span></div><div><span style="font-size: 11pt;">    }</span></div><div><span style="font-size: 11pt;">    real_server 192.168.10.200 80 {</span></div><div><span style="font-size: 11pt;">        weight 2</span></div><div><span style="font-size: 11pt;">        TCP_CHECK {</span></div><div><span style="font-size: 11pt;">            connect_timeout 3</span></div><div><span style="font-size: 11pt;">            nb_get_retry 3</span></div><div><span style="font-size: 11pt;">            delay_before_retry 3</span></div><div><span style="font-size: 11pt;">        }</span></div><div><span style="font-size: 11pt;">    }</span></div><div><span style="font-size: 11pt;">}</span></div></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><br/></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><br/></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><br/></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">[</span><a href="mailto:root@Director" style="white-space: pre-wrap; font-size: 14px; line-height: 1.75; color: rgb(0, 56, 132); text-decoration: underline;">root@Director</a><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;"> ~]# ipvsadm -L -n</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">IP Virtual Server version 1.2.1 (size=4096)</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">Prot LocalAddress:Port Scheduler Flags</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">  -&gt; RemoteAddress:Port           Forward Weight ActiveConn InActConn</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">TCP  192.168.10.250:80 rr persistent 50</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">  -&gt; 192.168.10.100:80            Route   1      0          0         </span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">  -&gt; 192.168.10.200:80            Route   2      0          0       </span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><br/></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><br/></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><br/></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">LVS-TUN模型</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">    集群节点可以跨越互联网</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">    RIP必须是公网地址</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">    Director仅处理入站请求，响应报文直接由RS响应</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">    RS网关不能指向Director</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">    只有支持隧道功能的OS才能用于RS</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">    不支持端口映射</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><br/></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><br/></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">LVS持久连接</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">    无论使用什么算法，LVS持久都能实现在一定时间内，将来自同一个客户端请求派发至此前选定的RS</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">    </span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">    持久连接模板（内存缓冲区）：</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">        每一个客户端，及分配给它的RS的映射关系；</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><br/></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">    ipvsadm -A ...-p timeout：</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">        timeout：持久连接时长，默认300秒</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><br/></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">    在基于SSL，需要用到持久连接；</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><br/></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><br/></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><br/></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><br/></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><br/></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><br/></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><br/></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><br/></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><br/></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><br/></div><div><br/></div></div><div><br/></div></span>
</div></body></html> 