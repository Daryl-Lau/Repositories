<html>
<head>
  <title>上下文管理器with语句</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="Evernote Windows/307027 (zh-CN, DDL); Windows/10.0.0 (Win64);"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="813"/>
<h1>上下文管理器with语句</h1>

<div>
<span><div>上下文管理器with语句</div><div><br/></div><div>如果一个类对象实现了特殊方法__enter__()和__exit__()，那么就称这个类对象遵守了上下文管理协议，同时，这个类对象的实例对象被称为上下文管理器。</div><div>with语句会让上下文管理器创建一个运行时上下文，当进入运行时上下文时自动调用特殊方法__enter__()，当离开运行时向下文时自动调用特殊方法__exit__()。</div><div><br/></div><div>with语句的语法格式：</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>with 上下文表达式 [as 变量]:</div><div>    with 语句体</div></div><div><br/></div><div>如果with语句体中产生了异常，那么sys.exc_info()的返回值中的三个元素会被自动传递给特殊方法__exit__()的形参exc_type、exc_val、exc_tb，这三个形参分别表示异常的类型、异常的错误信息和异常调用堆栈的跟踪信息。</div><div><br/></div><div>与finally类似，特殊方法__exit__()总会被调用，通常在特殊方法__exit__()中释放资源，例如：关闭文件、关闭网路连接等。</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: &quot;DejaVu Sans Mono&quot;; color: rgb(0, 0, 255); font-size: 9pt;">#!/usr/bin/python3</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: &quot;DejaVu Sans Mono&quot;; color: rgb(200, 175, 0); font-size: 9pt;">class</span> <span style="font-family: &quot;DejaVu Sans Mono&quot;; color: rgb(0, 205, 205); font-size: 9pt;">MyContextManager</span><span style="font-family: &quot;DejaVu Sans Mono&quot;; color: rgb(0, 128, 0); font-size: 9pt;">(</span><span style="font-family: &quot;DejaVu Sans Mono&quot;; color: rgb(0, 205, 205); font-size: 9pt;">object</span><span style="font-family: &quot;DejaVu Sans Mono&quot;; color: rgb(0, 128, 0); font-size: 9pt;">):</span></div><div><span style="font-family: &quot;DejaVu Sans Mono&quot;; color: rgb(0, 128, 0); font-size: 9pt;">   </span> <span style="font-family: &quot;DejaVu Sans Mono&quot;; color: rgb(200, 175, 0); font-size: 9pt;">def</span> <span style="font-family: &quot;DejaVu Sans Mono&quot;; color: rgb(0, 205, 205); font-size: 9pt;">__enter__</span><span style="font-family: &quot;DejaVu Sans Mono&quot;; color: rgb(0, 128, 0); font-size: 9pt;">(self):</span></div><div><span style="font-family: &quot;DejaVu Sans Mono&quot;; color: rgb(0, 128, 0); font-size: 9pt;">       </span> <span style="font-family: &quot;DejaVu Sans Mono&quot;; color: rgb(0, 205, 205); font-size: 9pt;">print</span><span style="font-family: &quot;DejaVu Sans Mono&quot;; color: rgb(0, 128, 0); font-size: 9pt;">(</span><span style="font-family: &quot;DejaVu Sans Mono&quot;; color: rgb(187, 0, 0); font-size: 9pt;">'特殊方法__enter__()被调用'</span><span style="font-family: &quot;DejaVu Sans Mono&quot;; color: rgb(0, 128, 0); font-size: 9pt;">)</span></div><div><span style="font-family: &quot;DejaVu Sans Mono&quot;; color: rgb(0, 128, 0); font-size: 9pt;">       </span> <span style="font-family: &quot;DejaVu Sans Mono&quot;; color: rgb(200, 175, 0); font-size: 9pt;">return</span> <span style="font-family: &quot;DejaVu Sans Mono&quot;; color: rgb(0, 128, 0); font-size: 9pt;">self</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: &quot;DejaVu Sans Mono&quot;; color: rgb(0, 128, 0); font-size: 9pt;">   </span> <span style="font-family: &quot;DejaVu Sans Mono&quot;; color: rgb(200, 175, 0); font-size: 9pt;">def</span> <span style="font-family: &quot;DejaVu Sans Mono&quot;; color: rgb(0, 205, 205); font-size: 9pt;">__exit__</span><span style="font-family: &quot;DejaVu Sans Mono&quot;; color: rgb(0, 128, 0); font-size: 9pt;">(self, exc_type, exc_val, exc_tb):</span></div><div><span style="font-family: &quot;DejaVu Sans Mono&quot;; color: rgb(0, 128, 0); font-size: 9pt;">       </span> <span style="font-family: &quot;DejaVu Sans Mono&quot;; color: rgb(0, 205, 205); font-size: 9pt;">print</span><span style="font-family: &quot;DejaVu Sans Mono&quot;; color: rgb(0, 128, 0); font-size: 9pt;">(</span><span style="font-family: &quot;DejaVu Sans Mono&quot;; color: rgb(187, 0, 0); font-size: 9pt;">'特殊方法__exit__()被调用'</span><span style="font-family: &quot;DejaVu Sans Mono&quot;; color: rgb(0, 128, 0); font-size: 9pt;">)</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: &quot;DejaVu Sans Mono&quot;; color: rgb(0, 128, 0); font-size: 9pt;">       </span> <span style="font-family: &quot;DejaVu Sans Mono&quot;; color: rgb(0, 205, 205); font-size: 9pt;">print</span><span style="font-family: &quot;DejaVu Sans Mono&quot;; color: rgb(0, 128, 0); font-size: 9pt;">(</span><span style="font-family: &quot;DejaVu Sans Mono&quot;; color: rgb(187, 0, 0); font-size: 9pt;">'异常的类型：%s'</span> <span style="font-family: &quot;DejaVu Sans Mono&quot;; color: rgb(0, 128, 0); font-size: 9pt;">% exc_type)</span></div><div><span style="font-family: &quot;DejaVu Sans Mono&quot;; color: rgb(0, 128, 0); font-size: 9pt;">       </span> <span style="font-family: &quot;DejaVu Sans Mono&quot;; color: rgb(0, 205, 205); font-size: 9pt;">print</span><span style="font-family: &quot;DejaVu Sans Mono&quot;; color: rgb(0, 128, 0); font-size: 9pt;">(</span><span style="font-family: &quot;DejaVu Sans Mono&quot;; color: rgb(187, 0, 0); font-size: 9pt;">'异常的错误信息：%s'</span> <span style="font-family: &quot;DejaVu Sans Mono&quot;; color: rgb(0, 128, 0); font-size: 9pt;">% exc_val)</span></div><div><span style="font-family: &quot;DejaVu Sans Mono&quot;; color: rgb(0, 128, 0); font-size: 9pt;">       </span> <span style="font-family: &quot;DejaVu Sans Mono&quot;; color: rgb(0, 205, 205); font-size: 9pt;">print</span><span style="font-family: &quot;DejaVu Sans Mono&quot;; color: rgb(0, 128, 0); font-size: 9pt;">(</span><span style="font-family: &quot;DejaVu Sans Mono&quot;; color: rgb(187, 0, 0); font-size: 9pt;">'异常调用堆栈的跟踪信息：%s'</span> <span style="font-family: &quot;DejaVu Sans Mono&quot;; color: rgb(0, 128, 0); font-size: 9pt;">% exc_tb)</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: &quot;DejaVu Sans Mono&quot;; color: rgb(0, 128, 0); font-size: 9pt;">       </span> <span style="font-family: &quot;DejaVu Sans Mono&quot;; color: rgb(0, 0, 255); font-size: 9pt;"># return True</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: &quot;DejaVu Sans Mono&quot;; color: rgb(0, 128, 0); font-size: 9pt;">   </span> <span style="font-family: &quot;DejaVu Sans Mono&quot;; color: rgb(200, 175, 0); font-size: 9pt;">def</span> <span style="font-family: &quot;DejaVu Sans Mono&quot;; color: rgb(0, 205, 205); font-size: 9pt;">do_sth</span><span style="font-family: &quot;DejaVu Sans Mono&quot;; color: rgb(0, 128, 0); font-size: 9pt;">(self):</span></div><div><span style="font-family: &quot;DejaVu Sans Mono&quot;; color: rgb(0, 128, 0); font-size: 9pt;">       </span> <span style="font-family: &quot;DejaVu Sans Mono&quot;; color: rgb(0, 205, 205); font-size: 9pt;">print</span><span style="font-family: &quot;DejaVu Sans Mono&quot;; color: rgb(0, 128, 0); font-size: 9pt;">(</span><span style="font-family: &quot;DejaVu Sans Mono&quot;; color: rgb(187, 0, 0); font-size: 9pt;">'方法do_sth()被调用'</span><span style="font-family: &quot;DejaVu Sans Mono&quot;; color: rgb(0, 128, 0); font-size: 9pt;">)</span></div><div><span style="font-family: &quot;DejaVu Sans Mono&quot;; color: rgb(0, 128, 0); font-size: 9pt;">       </span> <span style="font-family: &quot;DejaVu Sans Mono&quot;; color: rgb(0, 205, 205); font-size: 9pt;">print</span><span style="font-family: &quot;DejaVu Sans Mono&quot;; color: rgb(0, 128, 0); font-size: 9pt;">(</span><span style="font-family: &quot;DejaVu Sans Mono&quot;; color: rgb(187, 0, 0); font-size: 9pt;">1</span> <span style="font-family: &quot;DejaVu Sans Mono&quot;; color: rgb(0, 128, 0); font-size: 9pt;">/</span> <span style="font-family: &quot;DejaVu Sans Mono&quot;; color: rgb(187, 0, 0); font-size: 9pt;">0</span><span style="font-family: &quot;DejaVu Sans Mono&quot;; color: rgb(0, 128, 0); font-size: 9pt;">)</span></div><div><span style="font-family: &quot;DejaVu Sans Mono&quot;; color: rgb(187, 0, 0); font-size: 9pt;">&quot;&quot;&quot;</span></div><div><span style="font-family: &quot;DejaVu Sans Mono&quot;; color: rgb(187, 0, 0); font-size: 9pt;">with MyContextManager() as mcm:</span></div><div><span style="font-family: &quot;DejaVu Sans Mono&quot;; color: rgb(187, 0, 0); font-size: 9pt;">    mcm.do_sth()</span></div><div><span style="font-family: &quot;DejaVu Sans Mono&quot;; color: rgb(187, 0, 0); font-size: 9pt;">&quot;&quot;&quot;</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: &quot;DejaVu Sans Mono&quot;; color: rgb(200, 175, 0); font-size: 9pt;">try</span><span style="font-family: &quot;DejaVu Sans Mono&quot;; color: rgb(0, 128, 0); font-size: 9pt;">:</span></div><div><span style="font-family: &quot;DejaVu Sans Mono&quot;; color: rgb(0, 128, 0); font-size: 9pt;">   </span> <span style="font-family: &quot;DejaVu Sans Mono&quot;; color: rgb(200, 175, 0); font-size: 9pt;">with</span> <span style="font-family: &quot;DejaVu Sans Mono&quot;; color: rgb(0, 128, 0); font-size: 9pt;">MyContextManager()</span> <span style="font-family: &quot;DejaVu Sans Mono&quot;; color: rgb(200, 175, 0); font-size: 9pt;">as</span> <span style="font-family: &quot;DejaVu Sans Mono&quot;; color: rgb(0, 128, 0); font-size: 9pt;">mcm:</span></div><div><span style="font-family: &quot;DejaVu Sans Mono&quot;; color: rgb(0, 128, 0); font-size: 9pt;">        mcm.do_sth()</span></div><div><span style="font-family: &quot;DejaVu Sans Mono&quot;; color: rgb(200, 175, 0); font-size: 9pt;">except</span> <span style="font-family: &quot;DejaVu Sans Mono&quot;; color: rgb(0, 100, 0); font-size: 9pt;">ZeroDivisionError</span> <span style="font-family: &quot;DejaVu Sans Mono&quot;; color: rgb(200, 175, 0); font-size: 9pt;">as</span> <span style="font-family: &quot;DejaVu Sans Mono&quot;; color: rgb(0, 128, 0); font-size: 9pt;">err:</span></div><div><span style="font-family: &quot;DejaVu Sans Mono&quot;; color: rgb(0, 128, 0); font-size: 9pt;">   </span> <span style="font-family: &quot;DejaVu Sans Mono&quot;; color: rgb(0, 205, 205); font-size: 9pt;">print</span><span style="font-family: &quot;DejaVu Sans Mono&quot;; color: rgb(0, 128, 0); font-size: 9pt;">(err)</span></div></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: &quot;DejaVu Sans Mono&quot;; color: rgb(0, 128, 0); font-size: 9pt;">[root@lyucan ~]# ./yc.py</span></div><div><span style="font-family: &quot;DejaVu Sans Mono&quot;; color: rgb(0, 128, 0); font-size: 9pt;">特殊方法__enter__()被调用</span></div><div><span style="font-family: &quot;DejaVu Sans Mono&quot;; color: rgb(0, 128, 0); font-size: 9pt;">方法do_sth()被调用</span></div><div><span style="font-family: &quot;DejaVu Sans Mono&quot;; color: rgb(0, 128, 0); font-size: 9pt;">特殊方法__exit__()被调用</span></div><div><span style="font-family: &quot;DejaVu Sans Mono&quot;; color: rgb(0, 128, 0); font-size: 9pt;">异常的类型：&lt;class 'ZeroDivisionError'&gt;</span></div><div><span style="font-family: &quot;DejaVu Sans Mono&quot;; color: rgb(0, 128, 0); font-size: 9pt;">异常的错误信息：division by zero</span></div><div><span style="font-family: &quot;DejaVu Sans Mono&quot;; color: rgb(0, 128, 0); font-size: 9pt;">异常调用堆栈的跟踪信息：&lt;traceback object at 0x7fb5a99c4b88&gt;</span></div><div><span style="font-family: &quot;DejaVu Sans Mono&quot;; color: rgb(0, 128, 0); font-size: 9pt;">division by zero</span></div></div><div><br/></div></span>
</div></body></html> 