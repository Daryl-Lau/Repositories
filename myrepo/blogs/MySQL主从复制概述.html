<html>
<head>
  <title>MySQL主从复制概述</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="Evernote Windows/307027 (zh-CN, DDL); Windows/10.0.0 (Win64);"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="542"/>
<h1>MySQL主从复制概述</h1>

<div>
<span><div><span style="font-size: 14pt;">MySQL主从复制概述</span></div><div><font style="font-size: 11pt;"><span style="font-size: 11pt; color: black;">复制是</span><span style="font-size: 11pt; color: black;">mysql</span><span style="font-size: 11pt; color: black;">数据库提供的一种高可用、高性能的解决方案，一般用来建立大型的应用；</span></font></div><div><span style="font-size: 11pt;">mysql</span><span style="font-size: 11pt;">支持单向，双向，链式级联，异步复制</span><span style="font-size: 11pt;">,</span><span style="font-size: 11pt;">半同步</span><span style="font-size: 11pt;">制</span><span style="font-size: 11pt;">(mysql5.5</span><span style="font-size: 11pt;">版本之后</span><span style="font-size: 11pt;">)</span><span style="font-size: 11pt;">，复制过程中</span><span style="font-size: 11pt;">,</span><span style="font-size: 11pt;">一台服务器当主</span><span style="font-size: 11pt;">master</span><span style="font-size: 11pt;">，而一个或者多个服务器</span><span style="font-size: 11pt;">slave；</span><br/><span style="font-size: 11pt;">复制可以是单向：</span><span style="font-size: 11pt;">M--&gt;</span><span style="font-size: 11pt;">S,</span><span style="font-size: 11pt;">也可以双向</span><span style="font-size: 11pt;">M&lt;--&gt;</span><span style="font-size: 11pt;">M</span><br/><span style="font-size: 11pt;">如设置了链式级联复制，那么从服务器本身除了充当slave之外，还是其下面从服务器的主服务器</span>结构如是：</div><div>M--&gt;<span style="font-size: 11pt;">S1--&gt;</span><span style="font-size: 11pt;">S2--&gt;</span><span style="font-size: 11pt;">S3</span><span style="font-size: 11pt;">的复制形式</span></div><div><span style="font-size: 11pt;"><br/></span></div><div><span style="font-size: 11pt;">单向主从复制</span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>master  --&gt;  slave</div></div><div><br/></div><div>一主多从模式</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>          -------slave1</div><div>          |</div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">master——</span>|------slave2</div><div>          |</div><div>          -------slave3</div></div><div><br/></div><div>线性级联模式</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>master --&gt; slave1 --&gt; salve2 --&gt; slave3</div></div><div><br/></div><div>双主模式，互为主从</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>master &lt;--&gt; master</div></div><div><br/></div><div>其他，结合起来使用，如</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>master &lt;--&gt; master</div><div>   |</div><div> slave</div></div><div><br/></div><div>mysql主从复制原理</div><div><img src="MySQL主从复制概述_files/Image.png" type="image/png" data-filename="Image.png"/></div><div>复制分为三个步骤：</div><div><ol><li><span style="font-size: 10pt;">主服务器将数据更新记录到二进制日志中；</span><br/></li><li><span style="font-size: 10pt;">从服务器把主服务器的二进制日志拷贝到自己的中继日志中；</span><br/></li><li><span style="font-size: 10pt;">从服务器重做中继日志中的时间，把更新应用到自己的数据库上；</span><br/></li></ol></div><div><br/></div><div>主服务器中的线程：</div><div>I/O线程</div><div>    接收到从库发来的请求后，负责给从库发送二进制日志；<br/></div><div><br/></div><div>从库中的线程：</div><div>I/O线程</div><div>    接收主库发来的二进制日志，并将其保存在自己的中继日志中<br/></div><div><br/></div><div>sql线程</div><div>    来复制中继日志中的日志<br/></div><div><br/></div><div><br/></div><div>主动复制分为异步复制、半同步复制和基于GTID的复制；</div><div><br/></div><div><ul><li><span style="font-size: 10pt;">异步复制：</span><span style="font-size: 10pt;"><font style="color: rgb(227, 0, 0);">MySQL复制默认是异步复制</font>，Master将事件写入binlog，但并不知道Slave是否或何时已经接收且已处理。在异步复制的机制的情况下，如果Master宕机，事务在Master上已提交，但很可能这些事务没有传到任何的Slave上。假设有Master-&gt;Salve故障转移的机制，此时Slave也可能会丢失事务。</span></li><li>半同步复制：当<span style="font-size: 10pt;">Slave</span><span style="font-size: 10pt;">主机连接到</span><span style="font-size: 10pt;">Master</span><span style="font-size: 10pt;">时，能够查看其是否处于半同步复制的机制，</span>当<span style="font-size: 10pt;">Master</span><span style="font-size: 10pt;">上开启半同步复制的功能时，至少应该有一个</span><span style="font-size: 10pt;">Slave</span><span style="font-size: 10pt;">开启其功能。此时，一个线程在</span><span style="font-size: 10pt;">Master</span><span style="font-size: 10pt;">上提交事务将受到阻塞，直到得知一个已开启半同步复制功能的</span><span style="font-size: 10pt;">Slave</span><span style="font-size: 10pt;">已收到此事务的所有事件，或等待超时。</span>当一个事务的事件都已写入其<span style="font-size: 10pt;">relay-log</span><span style="font-size: 10pt;">中且已刷新到磁盘上，</span><span style="font-size: 10pt;">Slave</span><span style="font-size: 10pt;">才会告知已收到，</span>如果等待超时，也就是<span style="font-size: 10pt;">Master</span><span style="font-size: 10pt;">没被告知已收到，此时</span><span style="font-size: 10pt;">Master</span><span style="font-size: 10pt;">会自动转换为异步复制的机制。当至少一个半同步的</span><span style="font-size: 10pt;">Slave</span><span style="font-size: 10pt;">赶上了，</span><span style="font-size: 10pt;">Master</span><span style="font-size: 10pt;">与其</span><span style="font-size: 10pt;">Slave</span><span style="font-size: 10pt;">自动转换为半同步复制的机制。</span>半同步复制的功能要在<span style="font-size: 10pt;">Master</span><span style="font-size: 10pt;">，</span><span style="font-size: 10pt;">Slave</span><span style="font-size: 10pt;">都开启，半同步复制才会起作用；否则，只开启一边，它依然为异步复制</span></li></ul></div><div><br/></div><div><img src="MySQL主从复制概述_files/Image [1].png" type="image/png" data-filename="Image.png"/></div><div><br/></div><div>主从复制应用场景</div><div>主从复制有利于数据库架构的健壮性，提升访问速度，易于管理；</div><div><font style="font-size: 10pt;"><br/></font></div><div><font style="font-size: 10pt;"><span style="font-size: 10pt;">主从服务器互为备份</span></font></div><div><font style="font-size: 10pt;"><span style="font-size: 10pt;">M-S服务器架构的设置，可以大大的加强数据库架构的健壮性，当主库出现问题，可以切换到从库，从而不影响正常生产业务的进行；</span><br/></font></div><div><span style="font-size: 13.3333px;">主从复制读写分离分担网站压力</span></div><div><font style="font-size: 10pt;"><span style="font-size: 10pt;">主从服务器架构通过程序(php,java）对客户端的请求实现读写分离，在从服务器上仅仅处理用户的select查询请求，降低用户查询响应时间，以及读写操作同时在主服务器带来的压力；</span><br/></font></div><div><br/></div><div>GTID主从复制</div><div style="margin: 10px auto; padding: 0px; text-indent: 0px; font-size: 14px; letter-spacing: normal; orphans: 2; text-align: left; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="text-indent: 0px; font-size: 14px; letter-spacing: normal; orphans: 2; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; font-variant-caps: normal; font-variant-ligatures: normal;">一、GTID的概述：</span></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px; letter-spacing: normal; orphans: 2; text-align: left; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><ol><li><span style="font-size: 11pt;">全局事物标识：global transaction identifieds。<br/></span></li><li><span style="font-size: 11pt;">GTID事物是全局唯一性的，且一个事务对应一个GTID。<br/></span></li><li><span style="font-size: 11pt;">一个GTID在一个服务器上只执行一次，避免重复执行导致数据混乱或者主从不一致。<br/></span></li><li><span style="font-size: 11pt;">GTID用来代替classic的复制方法，不在使用binlog+pos开启复制。而是使用master_auto_postion=1的方式自动匹配GTID断点进行复制。<br/></span></li><li><span style="font-size: 11pt;">MySQL-5.6.5开始支持的，MySQL-5.6.10后开始完善。<br/></span></li><li><span style="font-size: 11pt;">在传统的slave端，binlog是不用开启的，但是在GTID中，slave端的binlog是必须开启的，目的是记录执行过的GTID（强制）</span><br/></li></ol></div><div><br/></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px; font-size: 14px; letter-spacing: normal; orphans: 2; text-align: left; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="text-indent: 0px; font-size: 14px; letter-spacing: normal; orphans: 2; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; font-variant-caps: normal; font-variant-ligatures: normal;">二、GTID的组成部分：</span></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px; letter-spacing: normal; orphans: 2; text-align: left; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><ol><li><span style="font-size: 11pt;">前面是server_uuid：后面是一个序列号</span></li><li><font style="font-size: 11pt;"><span style="text-indent: 0px; font-size: 14px; letter-spacing: normal; orphans: 2; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;">例如：server_uuid：sequence number</span></font></li><li>7800a22c-95ae-11e4-983d-080027de205a:10</li><li><span style="font-size: 11pt;">UUID：每个mysql实例的唯一ID，由于会传递到slave，所以也可以理解为源ID。<br/></span></li><li><span style="font-size: 11pt;">Sequence number：在每台MySQL服务器上都是从1开始自增长的序列，一个数值对应一个事务。</span><br/></li></ol></div><div><br/></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px; font-size: 14px; letter-spacing: normal; orphans: 2; text-align: left; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="text-indent: 0px; font-size: 14px; letter-spacing: normal; orphans: 2; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; font-variant-caps: normal; font-variant-ligatures: normal;">三、GTID比传统复制的优势：</span></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px; letter-spacing: normal; orphans: 2; text-align: left; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><ol><li><span style="font-size: 11pt;">更简单的实现failover，不用以前那样在需要找log_file和log_Pos。<br/></span></li><li><span style="font-size: 11pt;">更简单的搭建主从复制。<br/></span></li><li><span style="font-size: 11pt;">比传统复制更加安全。<br/></span></li><li><span style="font-size: 11pt;">GTID是连续没有空洞的，因此主从库出现数据冲突时，可以用添加空事物的方式进行跳过。</span><br/></li></ol></div><div><span style="text-indent: 0px; font-size: 14px; letter-spacing: normal; orphans: 2; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;"><br/></span></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px; font-size: 14px; letter-spacing: normal; orphans: 2; text-align: left; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="text-indent: 0px; font-size: 14px; letter-spacing: normal; orphans: 2; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); font-variant-caps: normal; font-variant-ligatures: normal;">四、GTID的工作原理：</span></div><div style="margin: 0px; padding: 0px; letter-spacing: normal; orphans: 2; text-align: left; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><ol><li><span style="font-size: 11pt;">master更新数据时，会在事务前产生GTID，一同记录到binlog日志中。<br/></span></li><li><span style="font-size: 11pt;">slave端的i/o 线程将变更的binlog，写入到本地的relay log中。<br/></span></li><li><span style="font-size: 11pt;">sql线程从relay log中获取GTID，然后对比slave端的binlog是否有记录。<br/></span></li><li><span style="font-size: 11pt;">如果有记录，说明该GTID的事务已经执行，slave会忽略。<br/></span></li><li><span style="font-size: 11pt;">如果没有记录，slave就会从relay log中执行该GTID的事务，并记录到binlog。<br/></span></li><li><span style="font-size: 11pt;">在解析过程中会判断是否有主键，如果没有就用二级索引，如果没有就用全部扫描。</span><br/></li></ol></div><div><span style="font-size: 14px; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;"><br/></span></div><div style="margin: 0in; padding: 0px; box-sizing: border-box; text-align: justify; word-wrap: break-word; word-break: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><font style="font-size: 11pt;"><span style="box-sizing: border-box; word-wrap: break-word; word-break: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; font-size: 11pt; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 26px;">五、GTID</span><span style="box-sizing: border-box; word-wrap: break-word; word-break: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; font-size: 11pt; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 26px;">的限制：</span></font></div><div style="margin: 0in; padding: 0px; box-sizing: border-box; text-align: justify; word-wrap: break-word; word-break: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><ol><li><span style="font-size: 11pt;">不支持非事务引擎（从库报错，</span><span style="word-wrap: break-word; word-break: normal; font-size: 11pt; line-height: 26px;">stopslave; start slave;</span><span style="word-wrap: break-word; word-break: normal; font-size: 11pt; line-height: 26px;"> </span><span style="word-wrap: break-word; word-break: normal; font-size: 11pt; line-height: 26px;">忽略）</span><span style="font-size: 11pt;"><br/></span></li><li><span style="font-size: 11pt;">不支持</span><span style="word-wrap: break-word; word-break: normal; font-size: 11pt; line-height: 26px;">create table … select</span><span style="word-wrap: break-word; word-break: normal; font-size: 11pt; line-height: 26px;"> </span><span style="word-wrap: break-word; word-break: normal; font-size: 11pt; line-height: 26px;">语句复制（主库直接报错）</span><span style="font-size: 11pt;"><br/></span></li><li><span style="font-size: 11pt;">不允许在一个</span><span style="word-wrap: break-word; word-break: normal; font-size: 11pt; line-height: 26px;">SQL</span><span style="word-wrap: break-word; word-break: normal; font-size: 11pt; line-height: 26px;">同时更新一个事务引擎和非事务引擎的表</span><span style="font-size: 11pt;"><br/></span></li><li><span style="font-size: 11pt;">在一个复制组中，必须要求统一开启</span><span style="word-wrap: break-word; word-break: normal; font-size: 11pt; line-height: 26px;">CTID</span><span style="word-wrap: break-word; word-break: normal; font-size: 11pt; line-height: 26px;">或是关闭</span><span style="word-wrap: break-word; word-break: normal; font-size: 11pt; line-height: 26px;">GTID</span><span style="font-size: 11pt;"><br/></span></li><li><span style="font-size: 11pt;">开启</span><span style="word-wrap: break-word; word-break: normal; font-size: 11pt; line-height: 26px;">DTID</span><span style="word-wrap: break-word; word-break: normal; font-size: 11pt; line-height: 26px;">需要重启（</span><span style="word-wrap: break-word; word-break: normal; font-size: 11pt; line-height: 26px;">5.7</span><span style="word-wrap: break-word; word-break: normal; font-size: 11pt; line-height: 26px;">中可能不需要）</span><span style="font-size: 11pt;"><br/></span></li><li><span style="font-size: 11pt;">开启</span><span style="word-wrap: break-word; word-break: normal; font-size: 11pt; line-height: 26px;">DTID</span><span style="word-wrap: break-word; word-break: normal; font-size: 11pt; line-height: 26px;">后，就不在使用原来的传统的复制方式</span><span style="font-size: 11pt;"><br/></span></li><li><span style="font-size: 11pt;">对于</span><span style="word-wrap: break-word; word-break: normal; font-size: 11pt; line-height: 26px;">createtemporary table</span><span style="word-wrap: break-word; word-break: normal; font-size: 11pt; line-height: 26px;"> </span><span style="word-wrap: break-word; word-break: normal; font-size: 11pt; line-height: 26px;">和</span><span style="word-wrap: break-word; word-break: normal; font-size: 11pt; line-height: 26px;">drop temporary table</span><span style="word-wrap: break-word; word-break: normal; font-size: 11pt; line-height: 26px;">语句不支持</span><span style="font-size: 11pt;"><br/></span></li><li><span style="font-size: 11pt;">不支持</span><span style="background-color: transparent; word-wrap: break-word; word-break: normal; font-size: 11pt; line-height: 26px;">sql_slave_skip_counter</span><br/></li></ol></div><div><br/></div></span>
</div></body></html> 