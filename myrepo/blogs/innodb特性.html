<html>
<head>
  <title>innodb特性</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="Evernote Windows/307027 (zh-CN, DDL); Windows/10.0.0 (Win64);"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="562"/>
<h1>innodb特性</h1>

<div>
<span><div><span style="white-space: pre-wrap; text-indent: 28px; font-size: 14px; line-height: 1.75;">innodb特性</span></div><div><span style="font-size: 14px; text-indent: 56px; white-space: pre-wrap;">    插入缓存（insert buffer）</span></div><div><span style="font-size: 14px; text-indent: 56px; white-space: pre-wrap;">    二次写 （double write）</span></div><div><span style="font-size: 14px; text-indent: 56px; white-space: pre-wrap;">    自适应哈希索引（adapter hash index）</span></div><div><span style="font-size: 14px; text-indent: 56px; white-space: pre-wrap;">    异步IO（async IO）</span></div><div><span style="font-size: 14px; text-indent: 56px; white-space: pre-wrap;">    刷新邻接页</span></div><div><span style="white-space: pre-wrap; font-size: 20px; font-weight: bold; line-height: 1.75;">innodb特性</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 16px; font-weight: bold; line-height: 1.75;">插入缓存（insert buffer）</span></div><div style="white-space: pre-wrap; text-indent: 28px; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; text-indent: 28px; font-size: 14px; line-height: 1.75;">对非聚集索引的插入或者update，purge等操作，并非每一次直接插入索引页，而是把若干对于同一页面的更新缓存起来合并为一次操作，随机IO --&gt; 顺序IO，避免随机IO带的性能消耗，提高写性能。</span></div><div style="white-space: pre-wrap; text-indent: 28px; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; text-indent: 28px; font-size: 14px; line-height: 1.75;">原理：</span></div><div style="white-space: pre-wrap; text-indent: 56px; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; text-indent: 56px; font-size: 14px; line-height: 1.75;">先判断插入的非聚集索引页是否在缓冲池中</span></div><div style="white-space: pre-wrap; text-indent: 56px; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; text-indent: 56px; font-size: 14px; line-height: 1.75;">如果在，直接插入</span></div><div style="white-space: pre-wrap; text-indent: 56px; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; text-indent: 56px; font-size: 14px; line-height: 1.75;">如果不在，想放到插入缓冲区，欺骗数据库，这个非聚集的索引已经插入到叶子节点了</span></div><div style="white-space: pre-wrap; text-indent: 56px; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; text-indent: 56px; font-size: 14px; line-height: 1.75;">然后再以一定的频率执行插入缓冲和非聚集索引页子节点的合并操作</span></div><div style="white-space: pre-wrap; text-indent: 28px; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; text-indent: 28px; font-size: 14px; line-height: 1.75;">条件：</span></div><div style="white-space: pre-wrap; text-indent: 56px; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; text-indent: 56px; font-size: 14px; line-height: 1.75;">索引是辅助索引</span></div><div style="white-space: pre-wrap; text-indent: 56px; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; text-indent: 56px; font-size: 14px; line-height: 1.75;">索引不是唯一的</span></div><div style="white-space: pre-wrap; text-indent: 28px; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; text-indent: 28px; font-size: 14px; color: rgb(223, 64, 42); line-height: 1.75;">注意：在写密集的情况下，插入缓冲会占用过多的缓冲池内存，默认最大可以占用</span><span style="white-space: pre-wrap; text-indent: 28px; font-size: 14px; line-height: 1.75;"><a dir="ltr">1/2</a></span><span style="white-space: pre-wrap; text-indent: 28px; font-size: 14px; color: rgb(223, 64, 42); line-height: 1.75;">的缓冲池内存</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><br/></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 16px; font-weight: bold; line-height: 1.75;">二次写 （double write）</span></div><div style="white-space: pre-wrap; text-indent: 28px; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; text-indent: 28px; font-size: 14px; line-height: 1.75;">带给innodb存储引擎数据的可靠性</span></div><div style="white-space: pre-wrap; text-indent: 28px; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; text-indent: 28px; font-size: 14px; line-height: 1.75;">起因：当数据库宕机时，可能发生数据库写一个页面，而这个页只写了一部分，这就是所谓的部分写失效（partial page write），它会导致数据丢失，这时是无法通过重做日志恢复的，因为重做日志记录的是对页的物理修改，如果页本身已经损坏，重做日志也无能为力。</span></div><div style="white-space: pre-wrap; text-indent: 28px; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; text-indent: 28px; font-size: 14px; line-height: 1.75;">恢复原理：mysql在恢复的时候是通过检查page的checksum来决定这个页是否需要恢复，checksum就是当前这个页最后一个事务的事务号，如果系统找不到checksum，mysql就无法对该行数据进行写入操作</span></div><div style="text-align: center; float: none;"><img src="innodb特性_files/Image.png" type="image/png" data-filename="Image.png" title="Attachment"/><br/></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">两次写需要额外添加两个部分：</span></div><div style="white-space: pre-wrap; text-indent: 28px; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; text-indent: 28px; font-size: 14px; line-height: 1.75;">1）内存中的两次写缓冲（doublewrite buffer），大小为2MB</span></div><div style="white-space: pre-wrap; text-indent: 28px; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; text-indent: 28px; font-size: 14px; line-height: 1.75;">2）磁盘上共享表空间中连续的128页，大小也为2MB</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;"> </span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">其原理是这样的：</span></div><div style="white-space: pre-wrap; text-indent: 28px; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; text-indent: 28px; font-size: 14px; line-height: 1.75;">1）当刷新缓冲池脏页时，并不直接写到数据文件中，而是先拷贝至内存中的两次写缓冲区。</span></div><div style="white-space: pre-wrap; text-indent: 28px; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; text-indent: 28px; font-size: 14px; line-height: 1.75;">2）接着从两次写缓冲区分两次写入磁盘共享表空间中，每次写入1MB</span></div><div style="white-space: pre-wrap; text-indent: 28px; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; text-indent: 28px; font-size: 14px; line-height: 1.75;">3）待第2步完成后，再将两次写缓冲区写入数据文件</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;"> </span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.75;">这样就可以解决上文提到的部分写失效的问题，因为在磁盘共享表空间中已有数据页副本拷贝，如果数据库在页写入数据文件的过程中宕机，在实例恢复时，可以从共享表空间中找到该页副本，将其拷贝覆盖原有的数据页，再应用重做日志即可。</span></div><div style="white-space: pre-wrap; text-indent: 28px; text-align: left; font-size: 14px;"><br/></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 16px; font-weight: bold; line-height: 1.75;">自适应哈希索引（adapter hash index）</span></div><div style="white-space: pre-wrap; text-indent: 28px; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; text-indent: 28px; font-size: 14px; line-height: 1.75;">innodb存储引擎会监控对表上索引的查找，如果观察到建立哈希索引可以带来速度上的提升，则建立哈希索引，所以称为自适应的。</span></div><div style="white-space: pre-wrap; text-indent: 28px; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; text-indent: 28px; font-size: 14px; line-height: 1.75;">自适应哈希索引通过缓冲池的B+树构造而来，因为建立的速度很快，而且不需要将整个表都建立哈希索引，innodb会自动根据访问频率和模式来为某些页建立哈希索引。</span></div><div style="white-space: pre-wrap; text-indent: 28px; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; text-indent: 28px; font-size: 14px; line-height: 1.75;">启用自适应哈希索引后，读写速度提高两倍，辅助索引的链接操作，性能提高五倍。</span></div><div style="white-space: pre-wrap; text-indent: 28px; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; text-indent: 28px; font-size: 14px; line-height: 1.75;">数据库自动优化，不需要认为干预。</span></div><div style="white-space: pre-wrap; text-indent: 28px; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; text-indent: 28px; font-size: 14px; line-height: 1.75;">可以通过 show engine innodb status\G来查看自适应哈西索引的使用情况。可以使用innodb_adaptive_hash_index来禁用和启用hash索引，默认开启。</span></div><div style="white-space: pre-wrap; text-indent: 28px; text-align: left; font-size: 14px;"><br/></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 16px; font-weight: bold; line-height: 1.75;">异步IO（async IO）</span></div><div style="white-space: pre-wrap; text-indent: 28px; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; text-indent: 28px; font-size: 14px; line-height: 1.75;">为提高性能，采用异步IO来处理磁盘操作，好处是可以进行合并IO；</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><br/></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 16px; font-weight: bold; line-height: 1.75;">刷新邻接页</span></div><div style="white-space: pre-wrap; text-indent: 28px; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; text-indent: 28px; font-size: 14px; line-height: 1.75;">当刷新一个页的时候，innodb存储引擎会检测该页所在区的所有页，如果是脏页，就一起进行刷新。</span></div><div style="white-space: pre-wrap; text-indent: 28px; text-align: left; font-size: 14px;">如果使用的是固态硬盘，关掉它可以有效的提高性能。</div></span>
</div></body></html> 