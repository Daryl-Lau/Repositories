<html>
<head>
  <title>半同步主从复制</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="Evernote Windows/307027 (zh-CN, DDL); Windows/10.0.0 (Win64);"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="549"/>
<h1>半同步主从复制</h1>

<div>
<span><div><span style="font-size: 14pt; font-weight: bold;">半同步主从复制</span></div><div>半同步复制可以直接在异步复制的基础上完成 <a href="在线搭建异步主从复制.html" style="color: #69aa35;">在线搭建异步主从复制</a></div><div><br/></div><div>先检查是否支持动态安装插件</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"><span style="font-family: &quot;DejaVu Sans Mono&quot;; font-size: 9pt; color: rgb(0, 128, 0);">mysql&gt; select @@have_dynamic_loading</span></div><div style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"><span style="font-family: &quot;DejaVu Sans Mono&quot;; font-size: 9pt; color: rgb(0, 128, 0);">    -&gt; ;</span></div><div style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"><span style="font-family: &quot;DejaVu Sans Mono&quot;; font-size: 9pt; color: rgb(0, 128, 0);">+------------------------+</span></div><div style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"><span style="font-family: &quot;DejaVu Sans Mono&quot;; font-size: 9pt; color: rgb(0, 128, 0);">| @@have_dynamic_loading |</span></div><div style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"><span style="font-family: &quot;DejaVu Sans Mono&quot;; font-size: 9pt; color: rgb(0, 128, 0);">+------------------------+</span></div><div style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"><span style="font-family: &quot;DejaVu Sans Mono&quot;; font-size: 9pt; color: rgb(0, 128, 0);">| YES                    |</span></div><div style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"><span style="font-family: &quot;DejaVu Sans Mono&quot;; font-size: 9pt; color: rgb(0, 128, 0);">+------------------------+</span></div><div style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"><span style="font-family: &quot;DejaVu Sans Mono&quot;; font-size: 9pt; color: rgb(0, 128, 0);">1 row in set (0.00 sec)</span></div></div><div><br/></div><div>查看插件库的路径</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"><span style="font-family: &quot;DejaVu Sans Mono&quot;; font-size: 9pt; color: rgb(0, 128, 0);">mysql&gt; show variables like 'plugin_dir';</span></div><div style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"><span style="font-family: &quot;DejaVu Sans Mono&quot;; font-size: 9pt; color: rgb(0, 128, 0);">+---------------+------------------------------+</span></div><div style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"><span style="font-family: &quot;DejaVu Sans Mono&quot;; font-size: 9pt; color: rgb(0, 128, 0);">| Variable_name | Value                        |</span></div><div style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"><span style="font-family: &quot;DejaVu Sans Mono&quot;; font-size: 9pt; color: rgb(0, 128, 0);">+---------------+------------------------------+</span></div><div style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"><span style="font-family: &quot;DejaVu Sans Mono&quot;; font-size: 9pt; color: rgb(0, 128, 0);">| plugin_dir    | /usr/local/mysql/lib/plugin/ |</span></div><div style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"><span style="font-family: &quot;DejaVu Sans Mono&quot;; font-size: 9pt; color: rgb(0, 128, 0);">+---------------+------------------------------+</span></div><div style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"><span style="font-family: &quot;DejaVu Sans Mono&quot;; font-size: 9pt; color: rgb(0, 128, 0);">1 row in set (0.00 sec)</span></div></div><div><br/></div><div>有这个两个表示支持在线安装插件，然后在master和slave上同时安装插件</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"><span style="font-family: &quot;DejaVu Sans Mono&quot;; font-size: 9pt; color: rgb(0, 128, 0);"># master</span></div><div style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"><span style="font-family: &quot;DejaVu Sans Mono&quot;; font-size: 9pt; color: rgb(0, 128, 0);">mysql&gt; install plugin rpl_semi_sync_master SONAME 'semisync_master.so';</span></div><div style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"><span style="font-family: &quot;DejaVu Sans Mono&quot;; font-size: 9pt; color: rgb(0, 128, 0);">Query OK, 0 rows affected (0.10 sec)</span></div><div style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"><div><br/></div></div><div style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"><div style="font-family: DejaVu Sans Mono; font-size: 9pt; color: rgb(0, 128, 0);"><span style="font-family: &quot;DejaVu Sans Mono&quot;; font-size: 9pt; color: rgb(0, 128, 0);">mysql&gt; select * from mysql.plugin;</span></div><div style="font-family: DejaVu Sans Mono; font-size: 9pt; color: rgb(0, 128, 0);"><span style="font-family: &quot;DejaVu Sans Mono&quot;; font-size: 9pt; color: rgb(0, 128, 0);">+----------------------+--------------------+</span></div><div style="font-family: DejaVu Sans Mono; font-size: 9pt; color: rgb(0, 128, 0);"><span style="font-family: &quot;DejaVu Sans Mono&quot;; font-size: 9pt; color: rgb(0, 128, 0);">| name                 | dl                 |</span></div><div style="font-family: DejaVu Sans Mono; font-size: 9pt; color: rgb(0, 128, 0);"><span style="font-family: &quot;DejaVu Sans Mono&quot;; font-size: 9pt; color: rgb(0, 128, 0);">+----------------------+--------------------+</span></div><div style="font-family: DejaVu Sans Mono; font-size: 9pt; color: rgb(0, 128, 0);"><span style="font-family: &quot;DejaVu Sans Mono&quot;; font-size: 9pt; color: rgb(0, 128, 0);">| rpl_semi_sync_master | semisync_master.so |</span></div><div style="font-family: DejaVu Sans Mono; font-size: 9pt; color: rgb(0, 128, 0);"><span style="font-family: &quot;DejaVu Sans Mono&quot;; font-size: 9pt; color: rgb(0, 128, 0);">+----------------------+--------------------+</span></div><div style="font-family: DejaVu Sans Mono; font-size: 9pt; color: rgb(0, 128, 0);"><span style="font-family: &quot;DejaVu Sans Mono&quot;; font-size: 9pt; color: rgb(0, 128, 0);">1 row in set (0.00 sec)</span></div><div style="font-family: DejaVu Sans Mono; font-size: 9pt; color: rgb(0, 128, 0);"><div><br/></div></div><div style="font-family: DejaVu Sans Mono; font-size: 9pt; color: rgb(0, 128, 0);"><div style="font-family: DejaVu Sans Mono; font-size: 9pt; color: rgb(0, 128, 0);"><span style="font-family: &quot;DejaVu Sans Mono&quot;; font-size: 9pt; color: rgb(0, 128, 0);">mysql&gt; set global rpl_semi_sync_master_enabled=1;</span></div><div style="font-family: DejaVu Sans Mono; font-size: 9pt; color: rgb(0, 128, 0);"><span style="font-family: &quot;DejaVu Sans Mono&quot;; font-size: 9pt; color: rgb(0, 128, 0);">Query OK, 0 rows affected (0.00 sec)</span></div><div style="font-family: DejaVu Sans Mono; font-size: 9pt; color: rgb(0, 128, 0);"><br style="font-family: DejaVu Sans Mono; font-size: 9pt; color: rgb(0, 128, 0);"/></div><div style="font-family: DejaVu Sans Mono; font-size: 9pt; color: rgb(0, 128, 0);"><span style="font-family: &quot;DejaVu Sans Mono&quot;; font-size: 9pt; color: rgb(0, 128, 0);">mysql&gt; show status like '%semi_sync%';</span></div><div style="font-family: DejaVu Sans Mono; font-size: 9pt; color: rgb(0, 128, 0);"><span style="font-family: &quot;DejaVu Sans Mono&quot;; font-size: 9pt; color: rgb(0, 128, 0);">+--------------------------------------------+-------+</span></div><div style="font-family: DejaVu Sans Mono; font-size: 9pt; color: rgb(0, 128, 0);"><span style="font-family: &quot;DejaVu Sans Mono&quot;; font-size: 9pt; color: rgb(0, 128, 0);">| Variable_name                              | Value |</span></div><div style="font-family: DejaVu Sans Mono; font-size: 9pt; color: rgb(0, 128, 0);"><span style="font-family: &quot;DejaVu Sans Mono&quot;; font-size: 9pt; color: rgb(0, 128, 0);">+--------------------------------------------+-------+</span></div><div style="font-family: DejaVu Sans Mono; font-size: 9pt; color: rgb(0, 128, 0);"><span style="font-family: &quot;DejaVu Sans Mono&quot;; font-size: 9pt; color: rgb(0, 128, 0);">| Rpl_semi_sync_master_clients               | 0     |</span></div><div style="font-family: DejaVu Sans Mono; font-size: 9pt; color: rgb(0, 128, 0);"><span style="font-family: &quot;DejaVu Sans Mono&quot;; font-size: 9pt; color: rgb(0, 128, 0);">| Rpl_semi_sync_master_net_avg_wait_time     | 0     |</span></div><div style="font-family: DejaVu Sans Mono; font-size: 9pt; color: rgb(0, 128, 0);"><span style="font-family: &quot;DejaVu Sans Mono&quot;; font-size: 9pt; color: rgb(0, 128, 0);">| Rpl_semi_sync_master_net_wait_time         | 0     |</span></div><div style="font-family: DejaVu Sans Mono; font-size: 9pt; color: rgb(0, 128, 0);"><span style="font-family: &quot;DejaVu Sans Mono&quot;; font-size: 9pt; color: rgb(0, 128, 0);">| Rpl_semi_sync_master_net_waits             | 0     |</span></div><div style="font-family: DejaVu Sans Mono; font-size: 9pt; color: rgb(0, 128, 0);"><span style="font-family: &quot;DejaVu Sans Mono&quot;; font-size: 9pt; color: rgb(0, 128, 0);">| Rpl_semi_sync_master_no_times              | 0     |</span></div><div style="font-family: DejaVu Sans Mono; font-size: 9pt; color: rgb(0, 128, 0);"><span style="font-family: &quot;DejaVu Sans Mono&quot;; font-size: 9pt; color: rgb(0, 128, 0);">| Rpl_semi_sync_master_no_tx                 | 0     |</span></div><div style="font-family: DejaVu Sans Mono; font-size: 9pt; color: rgb(0, 128, 0);"><span style="font-family: &quot;DejaVu Sans Mono&quot;; font-size: 9pt; color: rgb(0, 128, 0);">| Rpl_semi_sync_master_status                | ON    |</span></div><div style="font-family: DejaVu Sans Mono; font-size: 9pt; color: rgb(0, 128, 0);"><span style="font-family: &quot;DejaVu Sans Mono&quot;; font-size: 9pt; color: rgb(0, 128, 0);">| Rpl_semi_sync_master_timefunc_failures     | 0     |</span></div><div style="font-family: DejaVu Sans Mono; font-size: 9pt; color: rgb(0, 128, 0);"><span style="font-family: &quot;DejaVu Sans Mono&quot;; font-size: 9pt; color: rgb(0, 128, 0);">| Rpl_semi_sync_master_tx_avg_wait_time      | 0     |</span></div><div style="font-family: DejaVu Sans Mono; font-size: 9pt; color: rgb(0, 128, 0);"><span style="font-family: &quot;DejaVu Sans Mono&quot;; font-size: 9pt; color: rgb(0, 128, 0);">| Rpl_semi_sync_master_tx_wait_time          | 0     |</span></div><div style="font-family: DejaVu Sans Mono; font-size: 9pt; color: rgb(0, 128, 0);"><span style="font-family: &quot;DejaVu Sans Mono&quot;; font-size: 9pt; color: rgb(0, 128, 0);">| Rpl_semi_sync_master_tx_waits              | 0     |</span></div><div style="font-family: DejaVu Sans Mono; font-size: 9pt; color: rgb(0, 128, 0);"><span style="font-family: &quot;DejaVu Sans Mono&quot;; font-size: 9pt; color: rgb(0, 128, 0);">| Rpl_semi_sync_master_wait_pos_backtraverse | 0     |</span></div><div style="font-family: DejaVu Sans Mono; font-size: 9pt; color: rgb(0, 128, 0);"><span style="font-family: &quot;DejaVu Sans Mono&quot;; font-size: 9pt; color: rgb(0, 128, 0);">| Rpl_semi_sync_master_wait_sessions         | 0     |</span></div><div style="font-family: DejaVu Sans Mono; font-size: 9pt; color: rgb(0, 128, 0);"><span style="font-family: &quot;DejaVu Sans Mono&quot;; font-size: 9pt; color: rgb(0, 128, 0);">| Rpl_semi_sync_master_yes_tx                | 0     |</span></div><div style="font-family: DejaVu Sans Mono; font-size: 9pt; color: rgb(0, 128, 0);"><span style="font-family: &quot;DejaVu Sans Mono&quot;; font-size: 9pt; color: rgb(0, 128, 0);">+--------------------------------------------+-------+</span></div><div style="font-family: DejaVu Sans Mono; font-size: 9pt; color: rgb(0, 128, 0);"><span style="font-family: &quot;DejaVu Sans Mono&quot;; font-size: 9pt; color: rgb(0, 128, 0);">14 rows in set (0.01 sec)</span></div></div></div></div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: &quot;DejaVu Sans Mono&quot;; font-size: 9pt; color: rgb(0, 128, 0);"># slave</span></div><div style="font-family: DejaVu Sans Mono; font-size: 9pt; color: rgb(0, 128, 0);"><span style="font-family: &quot;DejaVu Sans Mono&quot;; font-size: 9pt; color: rgb(0, 128, 0);">mysql&gt; install plugin rpl_semi_sync_slave SONAME 'semisync_slave.so';</span></div><div style="font-family: DejaVu Sans Mono; font-size: 9pt; color: rgb(0, 128, 0);"><span style="font-family: &quot;DejaVu Sans Mono&quot;; font-size: 9pt; color: rgb(0, 128, 0);">Query OK, 0 rows affected (0.02 sec)</span></div><div style="font-family: DejaVu Sans Mono; font-size: 9pt; color: rgb(0, 128, 0);"><br style="font-family: DejaVu Sans Mono; font-size: 9pt; color: rgb(0, 128, 0);"/></div><div style="font-family: DejaVu Sans Mono; font-size: 9pt; color: rgb(0, 128, 0);"><span style="font-family: &quot;DejaVu Sans Mono&quot;; font-size: 9pt; color: rgb(0, 128, 0);">mysql&gt; select * from mysql.plugin;</span></div><div style="font-family: DejaVu Sans Mono; font-size: 9pt; color: rgb(0, 128, 0);"><span style="font-family: &quot;DejaVu Sans Mono&quot;; font-size: 9pt; color: rgb(0, 128, 0);">+---------------------+-------------------+</span></div><div style="font-family: DejaVu Sans Mono; font-size: 9pt; color: rgb(0, 128, 0);"><span style="font-family: &quot;DejaVu Sans Mono&quot;; font-size: 9pt; color: rgb(0, 128, 0);">| name                | dl                |</span></div><div style="font-family: DejaVu Sans Mono; font-size: 9pt; color: rgb(0, 128, 0);"><span style="font-family: &quot;DejaVu Sans Mono&quot;; font-size: 9pt; color: rgb(0, 128, 0);">+---------------------+-------------------+</span></div><div style="font-family: DejaVu Sans Mono; font-size: 9pt; color: rgb(0, 128, 0);"><span style="font-family: &quot;DejaVu Sans Mono&quot;; font-size: 9pt; color: rgb(0, 128, 0);">| rpl_semi_sync_slave | semisync_slave.so |</span></div><div style="font-family: DejaVu Sans Mono; font-size: 9pt; color: rgb(0, 128, 0);"><span style="font-family: &quot;DejaVu Sans Mono&quot;; font-size: 9pt; color: rgb(0, 128, 0);">+---------------------+-------------------+</span></div><div style="font-family: DejaVu Sans Mono; font-size: 9pt; color: rgb(0, 128, 0);"><span style="font-family: &quot;DejaVu Sans Mono&quot;; font-size: 9pt; color: rgb(0, 128, 0);">1 row in set (0.00 sec)</span></div><div style="font-family: DejaVu Sans Mono; font-size: 9pt; color: rgb(0, 128, 0);"><div><br/></div></div><div style="font-family: DejaVu Sans Mono; font-size: 9pt; color: rgb(0, 128, 0);"><div style="font-family: DejaVu Sans Mono; font-size: 9pt; color: rgb(0, 128, 0);"><span style="font-family: &quot;DejaVu Sans Mono&quot;; font-size: 9pt; color: rgb(0, 128, 0);">mysql&gt; set global rpl_semi_sync_slave_enabled=1;</span></div><div style="font-family: DejaVu Sans Mono; font-size: 9pt; color: rgb(0, 128, 0);"><span style="font-family: &quot;DejaVu Sans Mono&quot;; font-size: 9pt; color: rgb(0, 128, 0);">Query OK, 0 rows affected (0.00 sec)</span></div></div><div style="font-family: DejaVu Sans Mono; font-size: 9pt; color: rgb(0, 128, 0);"><div><br/></div></div><div style="font-family: DejaVu Sans Mono; font-size: 9pt; color: rgb(0, 128, 0);"><div style="font-family: DejaVu Sans Mono; font-size: 9pt; color: rgb(0, 128, 0);"><span style="font-family: &quot;DejaVu Sans Mono&quot;; font-size: 9pt; color: rgb(0, 128, 0);">mysql&gt; show status like '%semi_sync%';</span></div><div style="font-family: DejaVu Sans Mono; font-size: 9pt; color: rgb(0, 128, 0);"><span style="font-family: &quot;DejaVu Sans Mono&quot;; font-size: 9pt; color: rgb(0, 128, 0);">+----------------------------+-------+</span></div><div style="font-family: DejaVu Sans Mono; font-size: 9pt; color: rgb(0, 128, 0);"><span style="font-family: &quot;DejaVu Sans Mono&quot;; font-size: 9pt; color: rgb(0, 128, 0);">| Variable_name              | Value |</span></div><div style="font-family: DejaVu Sans Mono; font-size: 9pt; color: rgb(0, 128, 0);"><span style="font-family: &quot;DejaVu Sans Mono&quot;; font-size: 9pt; color: rgb(0, 128, 0);">+----------------------------+-------+</span></div><div style="font-family: DejaVu Sans Mono; font-size: 9pt; color: rgb(0, 128, 0);"><span style="font-family: &quot;DejaVu Sans Mono&quot;; font-size: 9pt; color: rgb(0, 128, 0);">| Rpl_semi_sync_slave_status |</span> <span style="font-family: &quot;DejaVu Sans Mono&quot;;font-size: 9pt;color: rgb(0, 128, 0);background-color: rgb(255, 250, 165);-evernote-highlight:true;">OFF</span><span style="font-family: &quot;DejaVu Sans Mono&quot;; font-size: 9pt; color: rgb(0, 128, 0);">   |</span></div><div style="font-family: DejaVu Sans Mono; font-size: 9pt; color: rgb(0, 128, 0);"><span style="font-family: &quot;DejaVu Sans Mono&quot;; font-size: 9pt; color: rgb(0, 128, 0);">+----------------------------+-------+</span></div><div style="font-family: DejaVu Sans Mono; font-size: 9pt; color: rgb(0, 128, 0);"><span style="font-family: &quot;DejaVu Sans Mono&quot;; font-size: 9pt; color: rgb(0, 128, 0);">1 row in set (0.00 sec)</span></div></div><div style="font-family: DejaVu Sans Mono; font-size: 9pt; color: rgb(0, 128, 0);"><div><br/></div></div><div style="font-family: &quot;DejaVu Sans Mono&quot;; font-size: 9pt;"><span style="font-family: &quot;DejaVu Sans Mono&quot;; font-size: 9pt; color: rgb(227, 0, 0);">## 开启了半同步，为什么还是off呢，是由于我们之前slave是在运行状态，将其重启下就可以了！</span></div><div style="font-family: &quot;DejaVu Sans Mono&quot;; font-size: 9pt;"><div><br/></div></div><div style="font-family: &quot;DejaVu Sans Mono&quot;; font-size: 9pt;"><div style="font-family: DejaVu Sans Mono; font-size: 9pt; color: rgb(227, 0, 0);"><span style="font-family: &quot;DejaVu Sans Mono&quot;; font-size: 9pt; color: rgb(0, 128, 0);">mysql&gt; stop slave;</span></div><div style="font-family: DejaVu Sans Mono; font-size: 9pt; color: rgb(227, 0, 0);"><span style="font-family: &quot;DejaVu Sans Mono&quot;; font-size: 9pt; color: rgb(0, 128, 0);">Query OK, 0 rows affected (0.00 sec)</span></div><div style="font-family: DejaVu Sans Mono; font-size: 9pt; color: rgb(227, 0, 0);"><br style="font-family: DejaVu Sans Mono; font-size: 9pt; color: rgb(227, 0, 0);"/></div><div style="font-family: DejaVu Sans Mono; font-size: 9pt; color: rgb(227, 0, 0);"><span style="font-family: &quot;DejaVu Sans Mono&quot;; font-size: 9pt; color: rgb(0, 128, 0);">mysql&gt; start slave</span><span style="font-family: &quot;DejaVu Sans Mono&quot;; font-size: 9pt; color: rgb(0, 128, 0); min-height: 10pt;">;</span></div><div style="font-family: DejaVu Sans Mono; font-size: 9pt; color: rgb(227, 0, 0);"></div><div style="font-family: DejaVu Sans Mono; font-size: 9pt; color: rgb(227, 0, 0);"><span style="font-family: &quot;DejaVu Sans Mono&quot;; font-size: 9pt; color: rgb(0, 128, 0);">Query OK, 0 rows affected (0.01 sec)</span></div><div style="font-family: DejaVu Sans Mono; font-size: 9pt; color: rgb(227, 0, 0);"><div><br/></div></div><div style="font-family: DejaVu Sans Mono; font-size: 9pt; color: rgb(227, 0, 0);"><div style="font-family: DejaVu Sans Mono; font-size: 9pt; color: rgb(0, 128, 0);"><span style="font-family: &quot;DejaVu Sans Mono&quot;; font-size: 9pt; color: rgb(0, 128, 0);">mysql&gt; show status like '%semi_sync%';</span></div><div style="font-family: DejaVu Sans Mono; font-size: 9pt; color: rgb(0, 128, 0);"><span style="font-family: &quot;DejaVu Sans Mono&quot;; font-size: 9pt; color: rgb(0, 128, 0);">+----------------------------+-------+</span></div><div style="font-family: DejaVu Sans Mono; font-size: 9pt; color: rgb(0, 128, 0);"><span style="font-family: &quot;DejaVu Sans Mono&quot;; font-size: 9pt; color: rgb(0, 128, 0);">| Variable_name              | Value |</span></div><div style="font-family: DejaVu Sans Mono; font-size: 9pt; color: rgb(0, 128, 0);"><span style="font-family: &quot;DejaVu Sans Mono&quot;; font-size: 9pt; color: rgb(0, 128, 0);">+----------------------------+-------+</span></div><div style="font-family: DejaVu Sans Mono; font-size: 9pt; color: rgb(0, 128, 0);"><span style="font-family: &quot;DejaVu Sans Mono&quot;; font-size: 9pt; color: rgb(0, 128, 0);">| Rpl_semi_sync_slave_status |</span> <span style="font-family: &quot;DejaVu Sans Mono&quot;;font-size: 9pt;color: rgb(0, 128, 0);background-color: rgb(255, 250, 165);-evernote-highlight:true;">ON  </span><span style="font-family: &quot;DejaVu Sans Mono&quot;; font-size: 9pt; color: rgb(0, 128, 0);">  |</span></div><div style="font-family: DejaVu Sans Mono; font-size: 9pt; color: rgb(0, 128, 0);"><span style="font-family: &quot;DejaVu Sans Mono&quot;; font-size: 9pt; color: rgb(0, 128, 0);">+----------------------------+-------+</span></div><div style="font-family: DejaVu Sans Mono; font-size: 9pt; color: rgb(0, 128, 0);"><span style="font-family: &quot;DejaVu Sans Mono&quot;; font-size: 9pt; color: rgb(0, 128, 0);">1 row in set (0.01 sec)</span></div></div></div><div style="font-family: DejaVu Sans Mono; font-size: 9pt; color: rgb(0, 128, 0);"></div></div><div><br/></div><div>查看master上的状态</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"><span style="font-family: &quot;DejaVu Sans Mono&quot;; font-size: 9pt; color: rgb(0, 128, 0);">mysql&gt; show status like '%semi%';</span></div><div style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"><span style="font-family: &quot;DejaVu Sans Mono&quot;; font-size: 9pt; color: rgb(0, 128, 0);">+--------------------------------------------+-------+</span></div><div style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"><span style="font-family: &quot;DejaVu Sans Mono&quot;; font-size: 9pt; color: rgb(0, 128, 0);">| Variable_name                              | Value |</span></div><div style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"><span style="font-family: &quot;DejaVu Sans Mono&quot;; font-size: 9pt; color: rgb(0, 128, 0);">+--------------------------------------------+-------+</span></div><div style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"><span style="font-family: &quot;DejaVu Sans Mono&quot;; font-size: 9pt; color: rgb(0, 128, 0);">|</span> <span style="font-family: &quot;DejaVu Sans Mono&quot;;font-size: 9pt;color: rgb(0, 128, 0);background-color: rgb(255, 250, 165);-evernote-highlight:true;">Rpl_semi_sync_master_clients               | 1</span><span style="font-family: &quot;DejaVu Sans Mono&quot;; font-size: 9pt; color: rgb(0, 128, 0);">     |</span></div><div style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"><span style="font-family: &quot;DejaVu Sans Mono&quot;; font-size: 9pt; color: rgb(0, 128, 0);">| Rpl_semi_sync_master_net_avg_wait_time     | 0     |</span></div><div style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"><span style="font-family: &quot;DejaVu Sans Mono&quot;; font-size: 9pt; color: rgb(0, 128, 0);">| net_wait_time         | 0     |</span></div><div style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"><span style="font-family: &quot;DejaVu Sans Mono&quot;; font-size: 9pt; color: rgb(0, 128, 0);">| Rpl_semi_sync_master_net_waits             | 0     |</span></div><div style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"><span style="font-family: &quot;DejaVu Sans Mono&quot;; font-size: 9pt; color: rgb(0, 128, 0);">| Rpl_semi_sync_master_no_times              | 0     |</span></div><div style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"><span style="font-family: &quot;DejaVu Sans Mono&quot;; font-size: 9pt; color: rgb(0, 128, 0);">| Rpl_semi_sync_master_no_tx                 | 0     |</span></div><div style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"><span style="font-family: &quot;DejaVu Sans Mono&quot;; font-size: 9pt; color: rgb(0, 128, 0);">| Rpl_semi_sync_master_status                | ON    |</span></div><div style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"><span style="font-family: &quot;DejaVu Sans Mono&quot;; font-size: 9pt; color: rgb(0, 128, 0);">| Rpl_semi_sync_master_timefunc_failures     | 0     |</span></div><div style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"><span style="font-family: &quot;DejaVu Sans Mono&quot;; font-size: 9pt; color: rgb(0, 128, 0);">| Rpl_semi_sync_master_tx_avg_wait_time      | 0     |</span></div><div style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"><span style="font-family: &quot;DejaVu Sans Mono&quot;; font-size: 9pt; color: rgb(0, 128, 0);">| Rpl_semi_sync_master_tx_wait_time          | 0     |</span></div><div style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"><span style="font-family: &quot;DejaVu Sans Mono&quot;; font-size: 9pt; color: rgb(0, 128, 0);">| Rpl_semi_sync_master_tx_waits              | 0     |</span></div><div style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"><span style="font-family: &quot;DejaVu Sans Mono&quot;; font-size: 9pt; color: rgb(0, 128, 0);">| Rpl_semi_sync_master_wait_pos_backtraverse | 0     |</span></div><div style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"><span style="font-family: &quot;DejaVu Sans Mono&quot;; font-size: 9pt; color: rgb(0, 128, 0);">| Rpl_semi_sync_master_wait_sessions         | 0     |</span></div><div style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"><span style="font-family: &quot;DejaVu Sans Mono&quot;; font-size: 9pt; color: rgb(0, 128, 0);">| Rpl_semi_sync_master_yes_tx                | 0     |</span></div><div style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"><span style="font-family: &quot;DejaVu Sans Mono&quot;; font-size: 9pt; color: rgb(0, 128, 0);">+--------------------------------------------+-------+</span></div><div style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"><span style="font-family: &quot;DejaVu Sans Mono&quot;; font-size: 9pt; color: rgb(0, 128, 0);">14 rows in set (0.00 sec)</span></div><div style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"><div><br/></div></div><div style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"><span style="font-family: &quot;DejaVu Sans Mono&quot;; font-size: 9pt; color: rgb(0, 128, 0);">#</span><span style="font-family: &quot;DejaVu Sans Mono&quot;; font-size: 9pt; color: rgb(0, 128, 0);">Rpl_semi_sync_master_clients 表示有几台slave连接到了这台master上，有几台，数字就是几；</span></div></div><div><br/></div><div>将配置写入my.cnf中，避免重启失效</div><div>master</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: &quot;DejaVu Sans Mono&quot;; color: rgb(0, 128, 0);">[mysqld]</span></div><div><span style="font-family: &quot;DejaVu Sans Mono&quot;; color: rgb(0, 128, 0); font-size: 9pt;">rpl_semi_sync_master_enabled=1</span></div><div><span style="min-height: 10pt; font-family: &quot;DejaVu Sans Mono&quot;; color: rgb(0, 128, 0); font-size: 9pt;">rpl_semi_sync_master_timeout=10000        ##配置超时多少毫秒切换到异同步复制</span></div></div><div><br/></div><div>slave</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="color: rgb(0, 128, 0); font-family: DejaVu Sans Mono; font-size: 9pt;">[mysqld]</span></div><div><span style="font-family: &quot;DejaVu Sans Mono&quot;; font-size: 9pt; color: rgb(0, 128, 0);">rpl_semi_sync_slave_enabled=1</span></div></div><div><br/></div><div><br/></div><div>验证</div><div>将 slave 的io thread 停掉，那么将在10秒后切换到异步复制（上面配置文件配置的10秒），也就是插入操作将卡住10秒才插入成功</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"><div style="font-family: DejaVu Sans Mono; font-size: 9pt; color: rgb(0, 128, 0);"><span style="font-family: &quot;DejaVu Sans Mono&quot;; font-size: 9pt; color: rgb(0, 128, 0);"># slave</span></div><div style="font-family: DejaVu Sans Mono; font-size: 9pt; color: rgb(0, 128, 0);"><span style="font-family: &quot;DejaVu Sans Mono&quot;; font-size: 9pt; color: rgb(0, 128, 0);">mysql&gt; stop slave io_thread;</span></div><div style="font-family: DejaVu Sans Mono; font-size: 9pt; color: rgb(0, 128, 0);"><span style="font-family: &quot;DejaVu Sans Mono&quot;; font-size: 9pt; color: rgb(0, 128, 0);">Query OK, 0 rows affected, 1 warning (0.00 sec)</span></div><div style="font-family: DejaVu Sans Mono; font-size: 9pt; color: rgb(0, 128, 0);"><br style="font-family: DejaVu Sans Mono; font-size: 9pt; color: rgb(0, 128, 0);"/></div><div style="font-family: DejaVu Sans Mono; font-size: 9pt; color: rgb(0, 128, 0);"><span style="font-family: &quot;DejaVu Sans Mono&quot;; font-size: 9pt; color: rgb(0, 128, 0);">mysql&gt; show warnings;</span></div><div style="font-family: DejaVu Sans Mono; font-size: 9pt; color: rgb(0, 128, 0);"><span style="font-family: &quot;DejaVu Sans Mono&quot;; font-size: 9pt; color: rgb(0, 128, 0);">+-------+------+-----------------------------------------------------------+</span></div><div style="font-family: DejaVu Sans Mono; font-size: 9pt; color: rgb(0, 128, 0);"><span style="font-family: &quot;DejaVu Sans Mono&quot;; font-size: 9pt; color: rgb(0, 128, 0);">| Level | Code | Message                                                   |</span></div><div style="font-family: DejaVu Sans Mono; font-size: 9pt; color: rgb(0, 128, 0);"><span style="font-family: &quot;DejaVu Sans Mono&quot;; font-size: 9pt; color: rgb(0, 128, 0);">+-------+------+-----------------------------------------------------------+</span></div><div style="font-family: DejaVu Sans Mono; font-size: 9pt; color: rgb(0, 128, 0);"><span style="font-family: &quot;DejaVu Sans Mono&quot;; font-size: 9pt; color: rgb(0, 128, 0);">| Note  | 3084 | Replication thread(s) for channel '' are already stopped. |</span></div><div style="font-family: DejaVu Sans Mono; font-size: 9pt; color: rgb(0, 128, 0);"><span style="font-family: &quot;DejaVu Sans Mono&quot;; font-size: 9pt; color: rgb(0, 128, 0);">+-------+------+-----------------------------------------------------------+</span></div><div style="font-family: DejaVu Sans Mono; font-size: 9pt; color: rgb(0, 128, 0);"><span style="font-family: &quot;DejaVu Sans Mono&quot;; font-size: 9pt; color: rgb(0, 128, 0);">1 row in set (0.00 sec)</span></div></div><div style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"><br/></div><div style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"><span style="font-family: &quot;DejaVu Sans Mono&quot;; font-size: 9pt; color: rgb(0, 128, 0);">mysql&gt; show status like '%semi%';</span></div><div style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"><span style="font-family: &quot;DejaVu Sans Mono&quot;; font-size: 9pt; color: rgb(0, 128, 0);">+----------------------------+-------+</span></div><div style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"><span style="font-family: &quot;DejaVu Sans Mono&quot;; font-size: 9pt; color: rgb(0, 128, 0);">| Variable_name              | Value |</span></div><div style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"><span style="font-family: &quot;DejaVu Sans Mono&quot;; font-size: 9pt; color: rgb(0, 128, 0);">+----------------------------+-------+</span></div><div style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"><span style="font-family: &quot;DejaVu Sans Mono&quot;; font-size: 9pt; color: rgb(0, 128, 0);">| Rpl_semi_sync_slave_status | OFF   |</span></div><div style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"><span style="font-family: &quot;DejaVu Sans Mono&quot;; font-size: 9pt; color: rgb(0, 128, 0);">+----------------------------+-------+</span></div><div style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"><span style="font-family: &quot;DejaVu Sans Mono&quot;; font-size: 9pt; color: rgb(0, 128, 0);">1 row in set (0.00 sec)</span></div><div style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"><div><br/></div></div><div style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"><span style="font-family: &quot;DejaVu Sans Mono&quot;; font-size: 9pt; color: rgb(0, 128, 0);"># master</span></div><div style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"><div style="font-family: DejaVu Sans Mono; font-size: 9pt; color: rgb(0, 128, 0);"><span style="font-family: &quot;DejaVu Sans Mono&quot;; font-size: 9pt; color: rgb(0, 128, 0);">mysql&gt; insert into t1 values(17);</span></div><div style="font-family: DejaVu Sans Mono; font-size: 9pt; color: rgb(0, 128, 0);"><span style="font-family: &quot;DejaVu Sans Mono&quot;; font-size: 9pt; color: rgb(0, 128, 0);">Query OK, 1 row affected</span> <span style="font-family: &quot;DejaVu Sans Mono&quot;;font-size: 9pt;color: rgb(0, 128, 0);background-color: rgb(255, 250, 165);-evernote-highlight:true;">(10.01 sec)</span><span style="font-family: &quot;DejaVu Sans Mono&quot;; font-size: 9pt; color: rgb(0, 128, 0);">           ##可以看到花了10秒才插入成功，此时就切换到了异步复制</span></div></div></div><div><br/></div><div>切换到异步复制后，系统不会自动切回半同步，需要手动切，切得方式很简单，就是stop slave；start slave；</div><div><br/></div><div><br/></div><div><br/></div></span>
</div></body></html> 