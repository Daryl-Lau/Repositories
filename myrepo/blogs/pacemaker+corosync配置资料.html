<html>
<head>
  <title>pacemaker+corosync配置资料</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="Evernote Windows/307027 (zh-CN, DDL); Windows/10.0.0 (Win64);"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="387"/>
<h1>pacemaker+corosync配置资料</h1>

<div>
<span><div><span style="font-size: 14px; white-space: pre-wrap;">pacemaker+corosync配置资料</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">http://www.iyunv.com/thread-40135-1-1.html</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">http://xiexiaojun.blog.51cto.com/2305291/1705941</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><br/></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.875;">使用pcs shell配置corosync &amp; pacemaker群集</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.875;">Pacemaker</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.875;">Pacemaker，即Cluster Resource Manager（CRM），管理整个HA，客户端通过pacemaker管理监控整个集群。</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><br/></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.875;">CRM支持ocf和lsb两种资源类型：</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><br/></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.875;">ocf格式的启动脚本在/usr/lib/ocf/resource.d/下面。</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.875;">lsb的脚本一般在/etc/rc.d/init.d/下面。</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><br/></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><br/></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><br/></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.875;">1、常用的集群管理工具：</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.875;">（1）基于命令行</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.875;">crm shell/pcs</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><br/></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.875;">（2）基于图形化</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.875;">pygui/hawk/lcmc/pcs</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><br/></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><br/></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.875;">2、相关的资源文件：</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.875;">（1）/usr/lib/ocf/resource.d，pacemaker资源库文件位置，可安装资源包：resource-agents 获取更多ocf格式的资源。</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.875;">（2）/usr/sbin/fence_***，Fencing设备的执行脚本名称，可安装资源包：fence-agents 获取更多Fencing设备资源。</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><br/></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.875;">3、查看使用说明：</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.875;">[shell]# man ocf_heartbeat_*** ## 查看OCF资源说明，man ocf_heartbeat_apache</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.875;">[shell]# man fence_*** ## 查看Fencing设备说明，man fence_vmware</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><br/></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.875;">4、参考文档</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">https://github.com/ClusterLabs</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">http://clusterlabs.org/doc/</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">http://www.linux-ha.org/doc/man-pages/man-pages.html</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/6/html/Configuring_the_Red_Hat_High_Availability_Add-On_with_Pacemaker/index.html</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><br/></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">在群集配置过程中参考了互联网上众多优秀文章，在此感谢原作者！！！</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><br/></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">以下记录整理了在vmware esxi5.5 + centos6.6环境中使用PCS命令配置corosync &amp; pacemaker群集的一些操作，由于本人水平有限，仅供参考：</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><br/></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">--------------------------------------------------</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><br/></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><br/></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.875;">1.安装群集软件</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">[shell]# yum -y install corosync pacemaker pcs</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><span style="white-space: pre-wrap; font-size: 14px; line-height: 1.875;">[shell]# yum -y install fence-agents resource-agents</span></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><br/></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">2.拷贝配置文件、启动脚本</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">[shell]# mkdir -p /etc/cluster/</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">[shell]# ln -s /etc/rc.d/init.d/corosync /etc/rc.d/init.d/cman</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">[shell]# ln -s /usr/sbin/corosync-cmapctl /usr/sbin/corosync-objctl</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">[shell]# cp /etc/corosync/corosync.conf.example /etc/corosync/corosync.conf</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><br/></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><br/></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">注意：群集需要严格的时间同步机制，如果启用了防火墙需要开放相应的端口。</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><br/></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">--------------------------------------------------</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><br/></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">PCS（Pacemaker/Corosync configuration system）命令配置群集示例：</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><br/></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><br/></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">一、建立群集：</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><br/></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">1、配置群集节点的认证as the hacluster user:</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">[shell]# pcs cluster auth node11 node12</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><br/></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">2、创建一个二个节点的群集</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">[shell]# pcs cluster setup --name mycluster node11 node12</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">[shell]# pcs cluster start --all ## 启动群集</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><br/></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">3、设置资源默认粘性（防止资源回切）</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">[shell]# pcs resource defaults resource-stickiness=100</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">[shell]# pcs resource defaults</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><br/></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">4、设置资源超时时间</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">[shell]# pcs resource op defaults timeout=90s</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">[shell]# pcs resource op defaults</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><br/></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">5、二个节点时，忽略节点quorum功能</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">[shell]# pcs property set no-quorum-policy=ignore</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><br/></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">6、没有 Fencing设备时，禁用STONITH 组件功能</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">在 stonith-enabled=&quot;false&quot; 的情况下，分布式锁管理器 (DLM) 等资源以及依赖DLM 的所有服务（例如 cLVM2、GFS2 和 OCFS2）都将无法启动。</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">[shell]# pcs property set stonith-enabled=false</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">[shell]# crm_verify -L -V ## 验证群集配置信息</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><br/></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><br/></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><br/></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">二、建立群集资源</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><br/></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">1、查看可用资源</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">[shell]# pcs resource list ## 查看支持资源列表，pcs resource list ocf:heartbeat</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">[shell]# pcs resource describe agent_name ## 查看资源使用参数，pcs resource describe ocf:heartbeat:IPaddr2</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><br/></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">2、配置虚拟IP</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">[shell]# pcs resource create ClusterIP ocf:heartbeat:IPaddr2 \</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">ip=&quot;192.168.10.15&quot; cidr_netmask=32 nic=eth0 op monitor interval=30s</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><br/></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">3、配置Apache(httpd)</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">[shell]# pcs resource create WebServer ocf:heartbeat:apache \</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">httpd=&quot;/usr/sbin/httpd&quot; configfile=&quot;/etc/httpd/conf/httpd.conf&quot; \</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">statusurl=&quot;http://localhost/server-status&quot; op monitor interval=1min</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><br/></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">4、配置Nginx</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">[shell]# pcs resource create WebServer ocf:heartbeat:nginx \</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">httpd=&quot;/usr/sbin/nginx&quot; configfile=&quot;/etc/nginx/nginx.conf&quot; \</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">statusurl=&quot;http://localhost/ngx_status&quot; op monitor interval=30s</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><br/></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">5.1、配置FileSystem</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">[shell]# pcs resource create WebFS ocf:heartbeat:Filesystem \</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">device=&quot;/dev/sdb1&quot; directory=&quot;/var/www/html&quot; fstype=&quot;ext4&quot;</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><br/></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">[shell]# pcs resource create WebFS ocf:heartbeat:Filesystem \</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">device=&quot;-U 32937d65eb&quot; directory=&quot;/var/www/html&quot; fstype=&quot;ext4&quot;</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><br/></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">5.2、配置FileSystem-NFS</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">[shell]# pcs resource create WebFS ocf:heartbeat:Filesystem \</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">device=&quot;192.168.10.18:/mysqldata&quot; directory=&quot;/var/lib/mysql&quot; fstype=&quot;nfs&quot; \</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">options=&quot;-o username=your_name,password=your_password&quot; \</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">op start timeout=60s op stop timeout=60s op monitor interval=20s timeout=60s</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><br/></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">6、配置Iscsi</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">[shell]# pcs resource create WebData ocf:heartbeat:iscsi \</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">portal=&quot;192.168.10.18&quot; target=&quot;iqn.2008-08.com.starwindsoftware:&quot; \</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">op monitor depth=&quot;0&quot; timeout=&quot;30&quot; interval=&quot;120&quot;</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><br/></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">[shell]# pcs resource create WebFS ocf:heartbeat:Filesystem \</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">device=&quot;-U 32937d65eb&quot; directory=&quot;/var/www/html&quot; fstype=&quot;ext4&quot; options=&quot;_netdev&quot;</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><br/></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">7、配置DRBD</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">[shell]# pcs resource create WebData ocf:linbit:drbd \</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">drbd_resource=wwwdata op monitor interval=60s</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><br/></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">[shell]# pcs resource master WebDataClone WebData \</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">master-max=1 master-node-max=1 clone-max=2 clone-node-max=1 notify=true</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><br/></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">[shell]# pcs resource create WebFS ocf:heartbeat:Filesystem \</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">device=&quot;/dev/drbd1&quot; directory=&quot;/var/www/html&quot; fstype=&quot;ext4&quot;</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><br/></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">8、配置MySQL</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">[shell]# pcs resource create MySQL ocf:heartbeat:mysql \</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">binary=&quot;/usr/bin/mysqld_safe&quot; config=&quot;/etc/my.cnf&quot; datadir=&quot;/var/lib/mysql&quot; \</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">pid=&quot;/var/run/mysqld/mysql.pid&quot; socket=&quot;/tmp/mysql.sock&quot; \</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">op start timeout=180s op stop timeout=180s op monitor interval=20s timeout=60s</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><br/></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">9、配置Pingd，检测节点与目标的连接有效性</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">[shell]# pcs resource create PingCheck ocf:heartbeat:pingd \</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">dampen=5s multiplier=100 host_list=&quot;192.168.10.1 router&quot; \</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">op monitor interval=30s timeout=10s</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><br/></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">10、创建资源clone，克隆的资源会在全部节点启动</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">[shell]# pcs resource clone PingCheck</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">[shell]# pcs resource clone ClusterIP clone-max=2 clone-node-max=2 globally-unique=true ## clone-max=2，数据包分成2路</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">[shell]# pcs resource update ClusterIP clusterip_hash=sourceip ## 指定响应请求的分配策略为：sourceip</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><br/></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><br/></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><br/></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">三、调整群集资源</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><br/></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">1、配置资源约束</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">[shell]# pcs resource group add WebSrvs ClusterIP ## 配置资源组，组中资源会在同一节点运行</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">[shell]# pcs resource group remove WebSrvs ClusterIP ## 移除组中的指定资源</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">[shell]# pcs resource master WebDataClone WebData ## 配置具有多个状态的资源，如 DRBD master/slave状态</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">[shell]# pcs constraint colocation add WebServer ClusterIP INFINITY ## 配置资源捆绑关系</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">[shell]# pcs constraint colocation remove WebServer ## 移除资源捆绑关系约束中资源</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">[shell]# pcs constraint order ClusterIP then WebServer ## 配置资源启动顺序</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">[shell]# pcs constraint order remove ClusterIP ## 移除资源启动顺序约束中资源</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">[shell]# pcs constraint ## 查看资源约束关系， pcs constraint --full</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><br/></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">2、配置资源位置</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">[shell]# pcs constraint location WebServer prefers node11 ## 指定资源默认某个节点，node=50 指定增加的 score</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">[shell]# pcs constraint location WebServer avoids node11 ## 指定资源避开某个节点，node=50 指定减少的 score</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">[shell]# pcs constraint location remove location-WebServer ## 移除资源节点位置约束中资源ID，可用pcs config获取</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">[shell]# pcs constraint location WebServer prefers node11=INFINITY ## 手工移动资源节点，指定节点资源的 score of INFINITY</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">[shell]# crm_simulate -sL ## 验证节点资源 score 值</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><br/></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">3、修改资源配置</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">[shell]# pcs resource update WebFS ## 更新资源配置</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">[shell]# pcs resource delete WebFS ## 删除指定资源</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><br/></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">4、管理群集资源</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">[shell]# pcs resource disable ClusterIP ## 禁用资源</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">[shell]# pcs resource enable ClusterIP ## 启用资源</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">[shell]# pcs resource failcount show ClusterIP ## 显示指定资源的错误计数</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">[shell]# pcs resource failcount reset ClusterIP ## 清除指定资源的错误计数</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">[shell]# pcs resource cleanup ClusterIP ## 清除指定资源的状态与错误计数</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><br/></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><br/></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><br/></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><br/></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">四、配置Fencing设备，启用STONITH</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><br/></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">1、查询Fence设备资源</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">[shell]# pcs stonith list ## 查看支持Fence列表</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">[shell]# pcs stonith describe agent_name ## 查看Fence资源使用参数，pcs stonith describe fence_vmware_soap</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">2、配置fence设备资源</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">[shell]# pcs stonith create ipmi-fencing fence_ipmilan \</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">pcmk_host_list=&quot;pcmk-1 pcmk-2&quot; ipaddr=&quot;10.0.0.1&quot; login=testuser passwd=acd123 \</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">op monitor interval=60s</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><br/></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">mark:</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">If the device does not support the standard port parameter or may provide additional ones, you may also need to set the special pcmk_host_argument parameter. See man stonithd for details.</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">If the device does not know how to fence nodes based on their uname, you may also need to set the special pcmk_host_map parameter. See man stonithd for details.</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">If the device does not support the list command, you may also need to set the special pcmk_host_list and/or pcmk_host_check parameters. See man stonithd for details.</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">If the device does not expect the victim to be specified with the port parameter, you may also need to set the special pcmk_host_argument parameter. See man stonithd for details.</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">example: pcmk_host_argument=&quot;uuid&quot; pcmk_host_map=&quot;node11:4;node12:5;node13:6&quot; pcmk_host_list=&quot;node11,node12&quot; pcmk_host_check=&quot;static-list&quot;</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><br/></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">3、配置VMWARE (fence_vmware_soap)</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">特别说明：本次实例中使用了第3项（pcs stonith create vmware-fencing fence_vmware_soap）这个指定pcmk配置参数才能正常执行Fencing动作。</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><br/></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">3.1、确认vmware虚拟机的状态：</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">[shell]# fence_vmware_soap -o list -a vcenter.example.com -l cluster-admin -p &lt;password&gt; -z ## 获取虚拟机UUID</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">[shell]# fence_vmware_soap -o status -a vcenter.example.com -l cluster-admin -p &lt;password&gt; -z -U &lt;UUID&gt; ## 查看状态</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">[shell]# fence_vmware_soap -o status -a vcenter.example.com -l cluster-admin -p &lt;password&gt; -z -n &lt;vm name&gt;</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><br/></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">3.2、配置fence_vmware_soap</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">[shell]# pcs stonith create vmware-fencing-node11 fence_vmware_soap \</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">action=&quot;reboot&quot; ipaddr=&quot;192.168.10.10&quot; login=&quot;vmuser&quot; passwd=&quot;vmuserpd&quot; ssl=&quot;1&quot; \</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">port=&quot;node11&quot; shell_timeout=60s login_timeout=60s op monitor interval=90s</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><br/></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">[shell]# pcs stonith create vmware-fencing-node11 fence_vmware_soap \</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">action=&quot;reboot&quot; ipaddr=&quot;192.168.10.10&quot; login=&quot;vmuser&quot; passwd=&quot;vmuserpd&quot; ssl=&quot;1&quot; \</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">uuid=&quot;421dec5f-c484-3d69-ddfb-65af46530581&quot; shell_timeout=60s login_timeout=60s op monitor interval=90s</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><br/></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">[shell]# pcs stonith create vmware-fencing fence_vmware_soap \</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">action=&quot;reboot&quot; ipaddr=&quot;192.168.10.10&quot; login=&quot;vmuser&quot; passwd=&quot;vmuserpd&quot; ssl=&quot;1&quot; \</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">pcmk_host_argument=&quot;uuid&quot; pcmk_host_check=&quot;static-list&quot; pcmk_host_list=&quot;node11,node12&quot; \</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">pcmk_host_map=&quot;node11:421dec5f-c484-3d69-ddfb-65af46530581;node12:421dec5f-c484-3d69-ddfb-65af46530582&quot; \</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">shell_timeout=60s login_timeout=60s op monitor interval=90s</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><br/></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">注：如果配置fence_vmware_soap设备时用port=vm name在测试时不能识别，则使用uuid=vm uuid代替；</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">建议使用 pcmk_host_argument、pcmk_host_map、pcmk_host_check、pcmk_host_list 参数指明节点与设备端口关系，格式：</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">pcmk_host_argument=&quot;uuid&quot; pcmk_host_map=&quot;node11:uuid4;node12:uuid5;node13:uuid6&quot; pcmk_host_list=&quot;node11,node12,node13&quot; pcmk_host_check=&quot;static-list&quot;</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><br/></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">4、配置SCSI</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">[shell]# ls /dev/disk/by-id/wwn-* ## 获取Fencing磁盘UUID号，磁盘须未格式化</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">[shell]# pcs stonith create iscsi-fencing fence_scsi \</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">action=&quot;reboot&quot; devices=&quot;/dev/disk/by-id/wwn-0x600e002&quot; meta provides=unfencing</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><br/></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">5、配置DELL DRAC</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">[shell]# pcs stonith create dell-fencing-node11 fence_drac</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">.....</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><br/></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><br/></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">6、管理 STONITH</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">[shell]# pcs resource clone vmware-fencing ## clone stonith资源，供多节点启动</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">[shell]# pcs property set stonith-enabled=true ## 启用 stonith 组件功能</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">[shell]# pcs stonith cleanup vmware-fencing ## 清除Fence资源的状态与错误计数</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">[shell]# pcs stonith fence node11 ## fencing指定节点</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><br/></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><br/></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><br/></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><br/></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">五、群集操作命令</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><br/></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">1、验证群集安装</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">[shell]# pacemakerd -F ## 查看pacemaker组件，ps axf | grep pacemaker</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">[shell]# corosync-cfgtool -s ## 查看corosync序号</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">[shell]# corosync-cmapctl | grep members ## corosync 2.3.x</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">[shell]# corosync-objctl | grep members ## corosync 1.4.x</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><br/></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">2、查看群集资源</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">[shell]# pcs resource standards ## 查看支持资源类型</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">[shell]# pcs resource providers ## 查看资源提供商</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">[shell]# pcs resource agents ## 查看所有资源代理</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">[shell]# pcs resource list ## 查看支持资源列表</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">[shell]# pcs stonith list ## 查看支持Fence列表</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">[shell]# pcs property list --all ## 显示群集默认变量参数</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">[shell]# crm_simulate -sL ## 检验资源 score 值</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><br/></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">3、使用群集脚本</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">[shell]# pcs cluster cib ra_cfg ## 将群集资源配置信息保存在指定文件</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">[shell]# pcs -f ra_cfg resource create ## 创建群集资源并保存在指定文件中（而非保存在运行配置）</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">[shell]# pcs -f ra_cfg resource show ## 显示指定文件的配置信息，检查无误后</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">[shell]# pcs cluster cib-push ra_cfg ## 将指定配置文件加载到运行配置中</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><br/></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">4、STONITH 设备操作</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">[shell]# stonith_admin -I ## 查询fence设备</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">[shell]# stonith_admin -M -a agent_name ## 查询fence设备的元数据，stonith_admin -M -a fence_vmware_soap</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">[shell]# stonith_admin --reboot nodename ## 测试 STONITH 设备</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><br/></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">5、查看群集配置</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">[shell]# crm_verify -L -V ## 检查配置有无错误</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">[shell]# pcs property ## 查看群集属性</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">[shell]# pcs stonith ## 查看stonith</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">[shell]# pcs constraint ## 查看资源约束</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">[shell]# pcs config ## 查看群集资源配置</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">[shell]# pcs cluster cib ## 以XML格式显示群集配置</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;"><br/></div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">6、管理群集</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">[shell]# pcs status ## 查看群集状态</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">[shell]# pcs status cluster</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">[shell]# pcs status corosync</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">[shell]# pcs cluster stop [node11] ## 停止群集</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">[shell]# pcs cluster start --all ## 启动群集</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">[shell]# pcs cluster standby node11 ## 将节点置为后备standby状态，pcs cluster unstandby node11</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">[shell]# pcs cluster destroy [--all] ## 删除群集，[--all]同时恢复corosync.conf文件</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">[shell]# pcs resource cleanup ClusterIP ## 清除指定资源的状态与错误计数</div><div style="white-space: pre-wrap; text-align: left; font-size: 14px;">[shell]# pcs stonith cleanup vmware-fencing ## 清除Fence资源的状态与错误计数</div><div><br/></div></span>
</div></body></html> 